{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 106, "column": 0}, "map": {"version":3,"sources":["file:///C:/WebProjects/contractlens-web/apps/web/lib/mongodb.ts"],"sourcesContent":["import { MongoClient, Db } from \"mongodb\";\n\nconst uri = process.env.MONGODB_URI ?? \"mongodb://localhost:27017/contractlens\";\n\nlet client: MongoClient | null = null;\nlet clientPromise: Promise<MongoClient> | null = null;\n\nfunction getClient(): Promise<MongoClient> {\n  if (clientPromise) return clientPromise;\n  clientPromise = new MongoClient(uri).connect();\n  return clientPromise;\n}\n\nexport async function getDb(): Promise<Db> {\n  const c = await getClient();\n  return c.db();\n}\n\nexport async function ensureIndexes(): Promise<void> {\n  const db = await getDb();\n  await db.collection(\"documents\").createIndex({ createdAt: -1 });\n  await db.collection(\"chunks\").createIndex({ docId: 1 });\n  await db.collection(\"runs\").createIndex({ docId: 1 });\n  await db.collection(\"feedback\").createIndex({ runId: 1 });\n}\n"],"names":[],"mappings":";;;;;;AAAA;;AAEA,MAAM,MAAM,QAAQ,GAAG,CAAC,WAAW,IAAI;AAEvC,IAAI,SAA6B;AACjC,IAAI,gBAA6C;AAEjD,SAAS;IACP,IAAI,eAAe,OAAO;IAC1B,gBAAgB,IAAI,oKAAW,CAAC,KAAK,OAAO;IAC5C,OAAO;AACT;AAEO,eAAe;IACpB,MAAM,IAAI,MAAM;IAChB,OAAO,EAAE,EAAE;AACb;AAEO,eAAe;IACpB,MAAM,KAAK,MAAM;IACjB,MAAM,GAAG,UAAU,CAAC,aAAa,WAAW,CAAC;QAAE,WAAW,CAAC;IAAE;IAC7D,MAAM,GAAG,UAAU,CAAC,UAAU,WAAW,CAAC;QAAE,OAAO;IAAE;IACrD,MAAM,GAAG,UAAU,CAAC,QAAQ,WAAW,CAAC;QAAE,OAAO;IAAE;IACnD,MAAM,GAAG,UAAU,CAAC,YAAY,WAAW,CAAC;QAAE,OAAO;IAAE;AACzD"}},
    {"offset": {"line": 145, "column": 0}, "map": {"version":3,"sources":["file:///C:/WebProjects/contractlens-web/apps/web/lib/chroma.ts"],"sourcesContent":["import { ChromaClient } from \"chromadb\";\nimport OpenAI from \"openai\";\n\nconst CHROMA_URL = process.env.CHROMA_URL ?? \"http://localhost:8000\";\nconst COLLECTION_NAME = \"contractlens_chunks\";\n\nlet chromaClient: ChromaClient | null = null;\n\nfunction getChromaClient(): ChromaClient {\n  if (!chromaClient) {\n    chromaClient = new ChromaClient({ path: CHROMA_URL });\n  }\n  return chromaClient;\n}\n\nasync function embedQuery(text: string): Promise<number[][]> {\n  const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });\n  const res = await openai.embeddings.create({\n    model: \"text-embedding-3-small\",\n    input: [text],\n  });\n  return res.data.map((d) => d.embedding);\n}\n\nexport async function queryByDocId(\n  docId: string,\n  queryText: string,\n  nResults = 5\n): Promise<{ id: string; text: string; metadata: Record<string, unknown> }[]> {\n  const chroma = getChromaClient();\n  const collection = await chroma.getOrCreateCollection({\n    name: COLLECTION_NAME,\n  });\n\n  const queryEmbeddings = await embedQuery(queryText);\n\n  const results = await collection.query({\n    queryEmbeddings,\n    nResults,\n    where: { docId },\n  });\n\n  if (!results.ids?.[0] || !results.documents?.[0] || !results.metadatas?.[0]) {\n    return [];\n  }\n\n  return results.ids[0].map((id, i) => ({\n    id: id as string,\n    text: (results.documents![0][i] as string) ?? \"\",\n    metadata: (results.metadatas![0][i] as Record<string, unknown>) ?? {},\n  }));\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEA,MAAM,aAAa,QAAQ,GAAG,CAAC,UAAU,IAAI;AAC7C,MAAM,kBAAkB;AAExB,IAAI,eAAoC;AAExC,SAAS;IACP,IAAI,CAAC,cAAc;QACjB,eAAe,IAAI,+JAAY,CAAC;YAAE,MAAM;QAAW;IACrD;IACA,OAAO;AACT;AAEA,eAAe,WAAW,IAAY;IACpC,MAAM,SAAS,IAAI,6JAAM,CAAC;QAAE,QAAQ,QAAQ,GAAG,CAAC,cAAc;IAAC;IAC/D,MAAM,MAAM,MAAM,OAAO,UAAU,CAAC,MAAM,CAAC;QACzC,OAAO;QACP,OAAO;YAAC;SAAK;IACf;IACA,OAAO,IAAI,IAAI,CAAC,GAAG,CAAC,CAAC,IAAM,EAAE,SAAS;AACxC;AAEO,eAAe,aACpB,KAAa,EACb,SAAiB,EACjB,WAAW,CAAC;IAEZ,MAAM,SAAS;IACf,MAAM,aAAa,MAAM,OAAO,qBAAqB,CAAC;QACpD,MAAM;IACR;IAEA,MAAM,kBAAkB,MAAM,WAAW;IAEzC,MAAM,UAAU,MAAM,WAAW,KAAK,CAAC;QACrC;QACA;QACA,OAAO;YAAE;QAAM;IACjB;IAEA,IAAI,CAAC,QAAQ,GAAG,EAAE,CAAC,EAAE,IAAI,CAAC,QAAQ,SAAS,EAAE,CAAC,EAAE,IAAI,CAAC,QAAQ,SAAS,EAAE,CAAC,EAAE,EAAE;QAC3E,OAAO,EAAE;IACX;IAEA,OAAO,QAAQ,GAAG,CAAC,EAAE,CAAC,GAAG,CAAC,CAAC,IAAI,IAAM,CAAC;YACpC,IAAI;YACJ,MAAM,AAAC,QAAQ,SAAS,AAAC,CAAC,EAAE,CAAC,EAAE,IAAe;YAC9C,UAAU,AAAC,QAAQ,SAAS,AAAC,CAAC,EAAE,CAAC,EAAE,IAAgC,CAAC;QACtE,CAAC;AACH"}},
    {"offset": {"line": 202, "column": 0}, "map": {"version":3,"sources":["file:///C:/WebProjects/contractlens-web/apps/web/app/api/chat/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport { z } from \"zod\";\nimport OpenAI from \"openai\";\nimport { getDb } from \"@/lib/mongodb\";\nimport { queryByDocId } from \"@/lib/chroma\";\n\nconst ChatBodySchema = z.object({\n  docId: z.string().min(1),\n  messages: z.array(\n    z.object({\n      role: z.enum([\"user\", \"assistant\", \"system\"]),\n      content: z.string(),\n    })\n  ),\n});\n\nconst SYSTEM_PROMPT = `You are a contract analysis assistant. Answer ONLY based on the provided context from the document.\nIf the answer is not found in the context, say \"Not found in the provided document.\"\nAlways cite your sources by referencing the chunk ID (e.g., [chunk: docId:0]) when making claims.\nBe concise and professional. Do not provide legal advice.`;\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json();\n    const parsed = ChatBodySchema.safeParse(body);\n    if (!parsed.success) {\n      return NextResponse.json(\n        { error: \"Invalid request\", details: parsed.error.flatten() },\n        { status: 400 }\n      );\n    }\n\n    const { docId, messages } = parsed.data;\n    const lastMessage = messages.filter((m) => m.role === \"user\").pop();\n    if (!lastMessage) {\n      return NextResponse.json(\n        { error: \"At least one user message required\" },\n        { status: 400 }\n      );\n    }\n\n    const chunks = await queryByDocId(docId, lastMessage.content, 8);\n    const context = chunks\n      .map((c) => `[${c.id}]: ${c.text}`)\n      .join(\"\\n\\n\");\n\n    const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });\n    const completion = await openai.chat.completions.create({\n      model: \"gpt-4o-mini\",\n      messages: [\n        { role: \"system\", content: SYSTEM_PROMPT },\n        {\n          role: \"system\",\n          content: `Context from document:\\n\\n${context || \"(No relevant chunks found)\"}`,\n        },\n        ...messages,\n      ],\n    });\n\n    const choice = completion.choices[0];\n    const answer = choice?.message?.content ?? \"No response generated.\";\n    const usage = completion.usage;\n\n    const citations = chunks.map((c) => ({\n      docId,\n      chunkId: c.id,\n      snippet: c.text.slice(0, 200) + (c.text.length > 200 ? \"...\" : \"\"),\n    }));\n\n    const db = await getDb();\n    await db.collection(\"runs\").insertOne({\n      docId,\n      type: \"chat\",\n      createdAt: new Date(),\n      provider: \"openai\",\n      model: \"gpt-4o-mini\",\n      tokenUsage: usage\n        ? { prompt: usage.prompt_tokens, completion: usage.completion_tokens, total: usage.total_tokens }\n        : undefined,\n      inputs: { docId, messageCount: messages.length },\n      outputs: { answer, citationCount: citations.length },\n    });\n\n    return NextResponse.json({\n      answer,\n      citations,\n      usage: usage\n        ? { prompt: usage.prompt_tokens, completion: usage.completion_tokens, total: usage.total_tokens }\n        : undefined,\n    });\n  } catch (err) {\n    console.error(\"POST /api/chat error:\", err);\n    return NextResponse.json(\n      { error: \"Internal server error\" },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}