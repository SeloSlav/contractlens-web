module.exports=[6920,(e,t,r)=>{"use strict";r.byteLength=function(e){var t=c(e),r=t[0],i=t[1];return(r+i)*3/4-i},r.toByteArray=function(e){var t,r,i=c(e),s=i[0],o=i[1],l=new n((s+o)*3/4-o),u=0,h=o>0?s-4:s;for(r=0;r<h;r+=4)t=a[e.charCodeAt(r)]<<18|a[e.charCodeAt(r+1)]<<12|a[e.charCodeAt(r+2)]<<6|a[e.charCodeAt(r+3)],l[u++]=t>>16&255,l[u++]=t>>8&255,l[u++]=255&t;return 2===o&&(t=a[e.charCodeAt(r)]<<2|a[e.charCodeAt(r+1)]>>4,l[u++]=255&t),1===o&&(t=a[e.charCodeAt(r)]<<10|a[e.charCodeAt(r+1)]<<4|a[e.charCodeAt(r+2)]>>2,l[u++]=t>>8&255,l[u++]=255&t),l},r.fromByteArray=function(e){for(var t,r=e.length,a=r%3,n=[],s=0,o=r-a;s<o;s+=16383)n.push(function(e,t,r){for(var a,n=[],s=t;s<r;s+=3)a=(e[s]<<16&0xff0000)+(e[s+1]<<8&65280)+(255&e[s+2]),n.push(i[a>>18&63]+i[a>>12&63]+i[a>>6&63]+i[63&a]);return n.join("")}(e,s,s+16383>o?o:s+16383));return 1===a?n.push(i[(t=e[r-1])>>2]+i[t<<4&63]+"=="):2===a&&n.push(i[(t=(e[r-2]<<8)+e[r-1])>>10]+i[t>>4&63]+i[t<<2&63]+"="),n.join("")};for(var i=[],a=[],n="u">typeof Uint8Array?Uint8Array:Array,s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",o=0,l=s.length;o<l;++o)i[o]=s[o],a[s.charCodeAt(o)]=o;function c(e){var t=e.length;if(t%4>0)throw Error("Invalid string. Length must be a multiple of 4");var r=e.indexOf("=");-1===r&&(r=t);var i=r===t?0:4-r%4;return[r,i]}a[45]=62,a[95]=63},31353,e=>{"use strict";let t,r,i,a;var n,s,o=e.i(47909),l=e.i(74017),c=e.i(96250),u=e.i(59756),h=e.i(61916),p=e.i(74677),d=e.i(69741),f=e.i(22372),m=e.i(87718),g=e.i(95169),b=e.i(47587),y=e.i(66012),v=e.i(70101),_=e.i(26937),w=e.i(10372),k=e.i(93695);e.i(52474);var O=e.i(220),P=e.i(66486),A=e.i(67109);e.i(69070);var T=e.i(587);e.i(36964);var T=T,S=e.i(78500);class E extends Error{constructor(e,t){let r=e??"";t?.lc_error_code&&(r=`${r}

Troubleshooting URL: https://langchain-ai.github.io/langgraphjs/troubleshooting/errors/${t.lc_error_code}/
`),super(r),Object.defineProperty(this,"lc_error_code",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_error_code=t?.lc_error_code}}class j extends E{get is_bubble_up(){return!0}}class C extends E{constructor(e,t){super(e,t),this.name="GraphRecursionError"}static get unminifiable_name(){return"GraphRecursionError"}}class x extends E{constructor(e,t){super(e,t),this.name="GraphValueError"}static get unminifiable_name(){return"GraphValueError"}}class N extends j{constructor(e,t){super(JSON.stringify(e,null,2),t),Object.defineProperty(this,"interrupts",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name="GraphInterrupt",this.interrupts=e??[]}static get unminifiable_name(){return"GraphInterrupt"}}class I extends N{constructor(e,t){super([{value:e,when:"during"}],t),this.name="NodeInterrupt"}static get unminifiable_name(){return"NodeInterrupt"}}class M extends j{constructor(e){super(),Object.defineProperty(this,"command",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name="ParentCommand",this.command=e}static get unminifiable_name(){return"ParentCommand"}}function R(e){return void 0!==e&&e.name===M.unminifiable_name}function L(e){return void 0!==e&&!0===e.is_bubble_up}function $(e){return void 0!==e&&[N.unminifiable_name,I.unminifiable_name].includes(e.name)}class D extends E{constructor(e,t){super(e,t),this.name="EmptyInputError"}static get unminifiable_name(){return"EmptyInputError"}}class F extends E{constructor(e,t){super(e,t),this.name="EmptyChannelError"}static get unminifiable_name(){return"EmptyChannelError"}}class B extends E{constructor(e,t){super(e,t),this.name="InvalidUpdateError"}static get unminifiable_name(){return"InvalidUpdateError"}}class z extends E{constructor(e,t){super(e,t),this.name="MultipleSubgraphError"}static get unminifiable_name(){return"MultipleSubgraphError"}}class U extends E{constructor(e,t){super(e,t),this.name="UnreachableNodeError"}static get unminifiable_name(){return"UnreachableNodeError"}}class V extends E{constructor(e,t){super(e,t),this.name="RemoteException"}static get unminifiable_name(){return"RemoteException"}}e.s(["BaseLangGraphError",()=>E,"EmptyChannelError",()=>F,"EmptyInputError",()=>D,"GraphBubbleUp",()=>j,"GraphInterrupt",()=>N,"GraphRecursionError",()=>C,"GraphValueError",()=>x,"InvalidUpdateError",()=>B,"MultipleSubgraphsError",()=>z,"NodeInterrupt",()=>I,"ParentCommand",()=>M,"RemoteException",()=>V,"UnreachableNodeError",()=>U,"getSubgraphsSeenSet",0,()=>(void 0===globalThis[Symbol.for("LG_CHECKPOINT_SEEN_NS_SET")]&&(globalThis[Symbol.for("LG_CHECKPOINT_SEEN_NS_SET")]=new Set),globalThis[Symbol.for("LG_CHECKPOINT_SEEN_NS_SET")]),"isGraphBubbleUp",()=>L,"isGraphInterrupt",()=>$,"isParentCommand",()=>R],79045);var K=e.i(59905),Z=e.i(23157),W=e.i(36689);let G=0,q=0,J=function(e,i,a){let n=i&&a||0,s=i||Array(16),o=(e=e||{}).node,l=e.clockseq;if(e._v6||(o||(o=t),null==l&&(l=r)),null==o||null==l){let i=e.random||(e.rng||W.default)();null==o&&(o=[i[0],i[1],i[2],i[3],i[4],i[5]],t||e._v6||(o[0]|=1,t=o)),null==l&&(l=(i[6]<<8|i[7])&16383,void 0!==r||e._v6||(r=l))}let c=void 0!==e.msecs?e.msecs:Date.now(),u=void 0!==e.nsecs?e.nsecs:q+1,h=c-G+(u-q)/1e4;if(h<0&&void 0===e.clockseq&&(l=l+1&16383),(h<0||c>G)&&void 0===e.nsecs&&(u=0),u>=1e4)throw Error("uuid.v1(): Can't create more than 10M uuids/sec");G=c,q=u,r=l;let p=((0xfffffff&(c+=122192928e5))*1e4+u)%0x100000000;s[n++]=p>>>24&255,s[n++]=p>>>16&255,s[n++]=p>>>8&255,s[n++]=255&p;let d=c/0x100000000*1e4&0xfffffff;s[n++]=d>>>8&255,s[n++]=255&d,s[n++]=d>>>24&15|16,s[n++]=d>>>16&255,s[n++]=l>>>8|128,s[n++]=255&l;for(let e=0;e<6;++e)s[n+e]=o[e];return i||(0,Z.unsafeStringify)(s)};var H=e.i(65336);function Y(e){return function(e={},t,r=0){var i;let a,n=J({...e,_v6:!0},new Uint8Array(16));return a=function(e,t=!1){return Uint8Array.of((15&e[6])<<4|e[7]>>4&15,(15&e[7])<<4|(240&e[4])>>4,(15&e[4])<<4|(240&e[5])>>4,(15&e[5])<<4|(240&e[0])>>4,(15&e[0])<<4|(240&e[1])>>4,(15&e[1])<<4|(240&e[2])>>4,96|15&e[2],e[3],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15])}("string"==typeof(i=n)?(0,H.default)(i):i),n="string"==typeof i?(0,Z.unsafeStringify)(a):a,(0,Z.unsafeStringify)(n)}({clockseq:e})}function X(e,t){let r=t.replace(/-/g,"").match(/.{2}/g).map(e=>parseInt(e,16));return(0,K.v5)(e,new Uint8Array(r))}e.s(["uuid5",()=>X,"uuid6",()=>Y],2641);let Q="__error__",ee="__scheduled__",et="__interrupt__",er="__resume__";e.s(["ERROR",0,Q,"INTERRUPT",0,et,"RESUME",0,er,"SCHEDULED",0,ee,"TASKS",0,"__pregel_tasks"],11055);var ei=e.i(56740);let ea=[];e.s([],7873);var en={},es="0123456789abcdef".split(""),eo=[-0x80000000,8388608,32768,128],el=[24,16,8,0],ec=[];function eu(e){e?(ec[0]=ec[16]=ec[1]=ec[2]=ec[3]=ec[4]=ec[5]=ec[6]=ec[7]=ec[8]=ec[9]=ec[10]=ec[11]=ec[12]=ec[13]=ec[14]=ec[15]=0,this.blocks=ec):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=0x67452301,this.h1=0xefcdab89,this.h2=0x98badcfe,this.h3=0x10325476,this.h4=0xc3d2e1f0,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}eu.prototype.update=function(e){if(!this.finalized){var t="string"!=typeof e;t&&e.constructor===en.ArrayBuffer&&(e=new Uint8Array(e));for(var r,i,a=0,n=e.length||0,s=this.blocks;a<n;){if(this.hashed&&(this.hashed=!1,s[0]=this.block,s[16]=s[1]=s[2]=s[3]=s[4]=s[5]=s[6]=s[7]=s[8]=s[9]=s[10]=s[11]=s[12]=s[13]=s[14]=s[15]=0),t)for(i=this.start;a<n&&i<64;++a)s[i>>2]|=e[a]<<el[3&i++];else for(i=this.start;a<n&&i<64;++a)(r=e.charCodeAt(a))<128?s[i>>2]|=r<<el[3&i++]:(r<2048?s[i>>2]|=(192|r>>6)<<el[3&i++]:(r<55296||r>=57344?s[i>>2]|=(224|r>>12)<<el[3&i++]:(r=65536+((1023&r)<<10|1023&e.charCodeAt(++a)),s[i>>2]|=(240|r>>18)<<el[3&i++],s[i>>2]|=(128|r>>12&63)<<el[3&i++]),s[i>>2]|=(128|r>>6&63)<<el[3&i++]),s[i>>2]|=(128|63&r)<<el[3&i++]);this.lastByteIndex=i,this.bytes+=i-this.start,i>=64?(this.block=s[16],this.start=i-64,this.hash(),this.hashed=!0):this.start=i}return this.bytes>0xffffffff&&(this.hBytes+=this.bytes/0x100000000|0,this.bytes=this.bytes%0x100000000),this}},eu.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var e=this.blocks,t=this.lastByteIndex;e[16]=this.block,e[t>>2]|=eo[3&t],this.block=e[16],t>=56&&(this.hashed||this.hash(),e[0]=this.block,e[16]=e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=e[7]=e[8]=e[9]=e[10]=e[11]=e[12]=e[13]=e[14]=e[15]=0),e[14]=this.hBytes<<3|this.bytes>>>29,e[15]=this.bytes<<3,this.hash()}},eu.prototype.hash=function(){var e,t,r,i=this.h0,a=this.h1,n=this.h2,s=this.h3,o=this.h4,l=this.blocks;for(t=16;t<80;++t)r=l[t-3]^l[t-8]^l[t-14]^l[t-16],l[t]=r<<1|r>>>31;for(t=0;t<20;t+=5)e=a&n|~a&s,o=(r=i<<5|i>>>27)+e+o+0x5a827999+l[t]|0,e=i&(a=a<<30|a>>>2)|~i&n,s=(r=o<<5|o>>>27)+e+s+0x5a827999+l[t+1]|0,e=o&(i=i<<30|i>>>2)|~o&a,n=(r=s<<5|s>>>27)+e+n+0x5a827999+l[t+2]|0,e=s&(o=o<<30|o>>>2)|~s&i,a=(r=n<<5|n>>>27)+e+a+0x5a827999+l[t+3]|0,e=n&(s=s<<30|s>>>2)|~n&o,i=(r=a<<5|a>>>27)+e+i+0x5a827999+l[t+4]|0,n=n<<30|n>>>2;for(;t<40;t+=5)e=a^n^s,o=(r=i<<5|i>>>27)+e+o+0x6ed9eba1+l[t]|0,e=i^(a=a<<30|a>>>2)^n,s=(r=o<<5|o>>>27)+e+s+0x6ed9eba1+l[t+1]|0,e=o^(i=i<<30|i>>>2)^a,n=(r=s<<5|s>>>27)+e+n+0x6ed9eba1+l[t+2]|0,e=s^(o=o<<30|o>>>2)^i,a=(r=n<<5|n>>>27)+e+a+0x6ed9eba1+l[t+3]|0,e=n^(s=s<<30|s>>>2)^o,i=(r=a<<5|a>>>27)+e+i+0x6ed9eba1+l[t+4]|0,n=n<<30|n>>>2;for(;t<60;t+=5)e=a&n|a&s|n&s,o=(r=i<<5|i>>>27)+e+o-0x70e44324+l[t]|0,e=i&(a=a<<30|a>>>2)|i&n|a&n,s=(r=o<<5|o>>>27)+e+s-0x70e44324+l[t+1]|0,e=o&(i=i<<30|i>>>2)|o&a|i&a,n=(r=s<<5|s>>>27)+e+n-0x70e44324+l[t+2]|0,e=s&(o=o<<30|o>>>2)|s&i|o&i,a=(r=n<<5|n>>>27)+e+a-0x70e44324+l[t+3]|0,e=n&(s=s<<30|s>>>2)|n&o|s&o,i=(r=a<<5|a>>>27)+e+i-0x70e44324+l[t+4]|0,n=n<<30|n>>>2;for(;t<80;t+=5)e=a^n^s,o=(r=i<<5|i>>>27)+e+o-0x359d3e2a+l[t]|0,e=i^(a=a<<30|a>>>2)^n,s=(r=o<<5|o>>>27)+e+s-0x359d3e2a+l[t+1]|0,e=o^(i=i<<30|i>>>2)^a,n=(r=s<<5|s>>>27)+e+n-0x359d3e2a+l[t+2]|0,e=s^(o=o<<30|o>>>2)^i,a=(r=n<<5|n>>>27)+e+a-0x359d3e2a+l[t+3]|0,e=n^(s=s<<30|s>>>2)^o,i=(r=a<<5|a>>>27)+e+i-0x359d3e2a+l[t+4]|0,n=n<<30|n>>>2;this.h0=this.h0+i|0,this.h1=this.h1+a|0,this.h2=this.h2+n|0,this.h3=this.h3+s|0,this.h4=this.h4+o|0},eu.prototype.hex=function(){this.finalize();var e=this.h0,t=this.h1,r=this.h2,i=this.h3,a=this.h4;return es[e>>28&15]+es[e>>24&15]+es[e>>20&15]+es[e>>16&15]+es[e>>12&15]+es[e>>8&15]+es[e>>4&15]+es[15&e]+es[t>>28&15]+es[t>>24&15]+es[t>>20&15]+es[t>>16&15]+es[t>>12&15]+es[t>>8&15]+es[t>>4&15]+es[15&t]+es[r>>28&15]+es[r>>24&15]+es[r>>20&15]+es[r>>16&15]+es[r>>12&15]+es[r>>8&15]+es[r>>4&15]+es[15&r]+es[i>>28&15]+es[i>>24&15]+es[i>>20&15]+es[i>>16&15]+es[i>>12&15]+es[i>>8&15]+es[i>>4&15]+es[15&i]+es[a>>28&15]+es[a>>24&15]+es[a>>20&15]+es[a>>16&15]+es[a>>12&15]+es[a>>8&15]+es[a>>4&15]+es[15&a]},eu.prototype.toString=eu.prototype.hex,eu.prototype.digest=function(){this.finalize();var e=this.h0,t=this.h1,r=this.h2,i=this.h3,a=this.h4;return[e>>24&255,e>>16&255,e>>8&255,255&e,t>>24&255,t>>16&255,t>>8&255,255&t,r>>24&255,r>>16&255,r>>8&255,255&r,i>>24&255,i>>16&255,i>>8&255,255&i,a>>24&255,a>>16&255,a>>8&255,255&a]},eu.prototype.array=eu.prototype.digest,eu.prototype.arrayBuffer=function(){this.finalize();var e=new ArrayBuffer(20),t=new DataView(e);return t.setUint32(0,this.h0),t.setUint32(4,this.h1),t.setUint32(8,this.h2),t.setUint32(12,this.h3),t.setUint32(16,this.h4),e};let eh=!1,ep=e=>(eh||(console.warn(`The default method for hashing keys is insecure and will be replaced in a future version,
but hasn't been replaced yet as to not break existing caches. It's recommended that you use
a more secure hashing algorithm to avoid cache poisoning.

See this page for more information:
|
â””> https://js.langchain.com/docs/troubleshooting/warnings/insecure-cache-algorithm`),eh=!0),new eu(!0).update(e).hex());var ed="0123456789abcdef".split(""),ef=[-0x80000000,8388608,32768,128],em=[24,16,8,0],eg=[0x428a2f98,0x71374491,0xb5c0fbcf,0xe9b5dba5,0x3956c25b,0x59f111f1,0x923f82a4,0xab1c5ed5,0xd807aa98,0x12835b01,0x243185be,0x550c7dc3,0x72be5d74,0x80deb1fe,0x9bdc06a7,0xc19bf174,0xe49b69c1,0xefbe4786,0xfc19dc6,0x240ca1cc,0x2de92c6f,0x4a7484aa,0x5cb0a9dc,0x76f988da,0x983e5152,0xa831c66d,0xb00327c8,0xbf597fc7,0xc6e00bf3,0xd5a79147,0x6ca6351,0x14292967,0x27b70a85,0x2e1b2138,0x4d2c6dfc,0x53380d13,0x650a7354,0x766a0abb,0x81c2c92e,0x92722c85,0xa2bfe8a1,0xa81a664b,0xc24b8b70,0xc76c51a3,0xd192e819,0xd6990624,0xf40e3585,0x106aa070,0x19a4c116,0x1e376c08,0x2748774c,0x34b0bcb5,0x391c0cb3,0x4ed8aa4a,0x5b9cca4f,0x682e6ff3,0x748f82ee,0x78a5636f,0x84c87814,0x8cc70208,0x90befffa,0xa4506ceb,0xbef9a3f7,0xc67178f2],eb=[];function ey(e,t){t?(eb[0]=eb[16]=eb[1]=eb[2]=eb[3]=eb[4]=eb[5]=eb[6]=eb[7]=eb[8]=eb[9]=eb[10]=eb[11]=eb[12]=eb[13]=eb[14]=eb[15]=0,this.blocks=eb):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e?(this.h0=0xc1059ed8,this.h1=0x367cd507,this.h2=0x3070dd17,this.h3=0xf70e5939,this.h4=0xffc00b31,this.h5=0x68581511,this.h6=0x64f98fa7,this.h7=0xbefa4fa4):(this.h0=0x6a09e667,this.h1=0xbb67ae85,this.h2=0x3c6ef372,this.h3=0xa54ff53a,this.h4=0x510e527f,this.h5=0x9b05688c,this.h6=0x1f83d9ab,this.h7=0x5be0cd19),this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0,this.is224=e}ey.prototype.update=function(e){if(!this.finalized){var t,r=typeof e;if("string"!==r){if("object"===r){if(null===e)throw Error(ERROR);else if(ARRAY_BUFFER&&e.constructor===ArrayBuffer)e=new Uint8Array(e);else if(!Array.isArray(e)&&(!ARRAY_BUFFER||!ArrayBuffer.isView(e)))throw Error(ERROR)}else throw Error(ERROR);t=!0}for(var i,a,n=0,s=e.length,o=this.blocks;n<s;){if(this.hashed&&(this.hashed=!1,o[0]=this.block,this.block=o[16]=o[1]=o[2]=o[3]=o[4]=o[5]=o[6]=o[7]=o[8]=o[9]=o[10]=o[11]=o[12]=o[13]=o[14]=o[15]=0),t)for(a=this.start;n<s&&a<64;++n)o[a>>>2]|=e[n]<<em[3&a++];else for(a=this.start;n<s&&a<64;++n)(i=e.charCodeAt(n))<128?o[a>>>2]|=i<<em[3&a++]:(i<2048?o[a>>>2]|=(192|i>>>6)<<em[3&a++]:(i<55296||i>=57344?o[a>>>2]|=(224|i>>>12)<<em[3&a++]:(i=65536+((1023&i)<<10|1023&e.charCodeAt(++n)),o[a>>>2]|=(240|i>>>18)<<em[3&a++],o[a>>>2]|=(128|i>>>12&63)<<em[3&a++]),o[a>>>2]|=(128|i>>>6&63)<<em[3&a++]),o[a>>>2]|=(128|63&i)<<em[3&a++]);this.lastByteIndex=a,this.bytes+=a-this.start,a>=64?(this.block=o[16],this.start=a-64,this.hash(),this.hashed=!0):this.start=a}return this.bytes>0xffffffff&&(this.hBytes+=this.bytes/0x100000000|0,this.bytes=this.bytes%0x100000000),this}},ey.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var e=this.blocks,t=this.lastByteIndex;e[16]=this.block,e[t>>>2]|=ef[3&t],this.block=e[16],t>=56&&(this.hashed||this.hash(),e[0]=this.block,e[16]=e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=e[7]=e[8]=e[9]=e[10]=e[11]=e[12]=e[13]=e[14]=e[15]=0),e[14]=this.hBytes<<3|this.bytes>>>29,e[15]=this.bytes<<3,this.hash()}},ey.prototype.hash=function(){var e,t,r,i,a,n,s,o,l,c,u=this.h0,h=this.h1,p=this.h2,d=this.h3,f=this.h4,m=this.h5,g=this.h6,b=this.h7,y=this.blocks;for(e=16;e<64;++e)t=((a=y[e-15])>>>7|a<<25)^(a>>>18|a<<14)^a>>>3,r=((a=y[e-2])>>>17|a<<15)^(a>>>19|a<<13)^a>>>10,y[e]=y[e-16]+t+y[e-7]+r|0;for(e=0,c=h&p;e<64;e+=4)this.first?(this.is224?(s=300032,b=(a=y[0]-0x543c9a5b)-0x8f1a6c7|0,d=a+0x170e9b5|0):(s=0x2a01a605,b=(a=y[0]-0xc881298)-0x5ab00ac6|0,d=a+0x8909ae5|0),this.first=!1):(t=(u>>>2|u<<30)^(u>>>13|u<<19)^(u>>>22|u<<10),r=(f>>>6|f<<26)^(f>>>11|f<<21)^(f>>>25|f<<7),i=(s=u&h)^u&p^c,a=b+r+(f&m^~f&g)+eg[e]+y[e],n=t+i,b=d+a|0,d=a+n|0),t=(d>>>2|d<<30)^(d>>>13|d<<19)^(d>>>22|d<<10),r=(b>>>6|b<<26)^(b>>>11|b<<21)^(b>>>25|b<<7),i=(o=d&u)^d&h^s,a=m+r+(g&b^~g&f)+eg[e+1]+y[e+1],n=t+i,g=p+a|0,t=((p=a+n|0)>>>2|p<<30)^(p>>>13|p<<19)^(p>>>22|p<<10),r=(g>>>6|g<<26)^(g>>>11|g<<21)^(g>>>25|g<<7),i=(l=p&d)^p&u^o,a=f+r+(m&g^~m&b)+eg[e+2]+y[e+2],n=t+i,m=h+a|0,t=((h=a+n|0)>>>2|h<<30)^(h>>>13|h<<19)^(h>>>22|h<<10),r=(m>>>6|m<<26)^(m>>>11|m<<21)^(m>>>25|m<<7),i=(c=h&p)^h&d^l,a=f+r+(m&g^~m&b)+eg[e+3]+y[e+3],n=t+i,f=u+a|0,u=a+n|0,this.chromeBugWorkAround=!0;this.h0=this.h0+u|0,this.h1=this.h1+h|0,this.h2=this.h2+p|0,this.h3=this.h3+d|0,this.h4=this.h4+f|0,this.h5=this.h5+m|0,this.h6=this.h6+g|0,this.h7=this.h7+b|0},ey.prototype.hex=function(){this.finalize();var e=this.h0,t=this.h1,r=this.h2,i=this.h3,a=this.h4,n=this.h5,s=this.h6,o=this.h7,l=ed[e>>>28&15]+ed[e>>>24&15]+ed[e>>>20&15]+ed[e>>>16&15]+ed[e>>>12&15]+ed[e>>>8&15]+ed[e>>>4&15]+ed[15&e]+ed[t>>>28&15]+ed[t>>>24&15]+ed[t>>>20&15]+ed[t>>>16&15]+ed[t>>>12&15]+ed[t>>>8&15]+ed[t>>>4&15]+ed[15&t]+ed[r>>>28&15]+ed[r>>>24&15]+ed[r>>>20&15]+ed[r>>>16&15]+ed[r>>>12&15]+ed[r>>>8&15]+ed[r>>>4&15]+ed[15&r]+ed[i>>>28&15]+ed[i>>>24&15]+ed[i>>>20&15]+ed[i>>>16&15]+ed[i>>>12&15]+ed[i>>>8&15]+ed[i>>>4&15]+ed[15&i]+ed[a>>>28&15]+ed[a>>>24&15]+ed[a>>>20&15]+ed[a>>>16&15]+ed[a>>>12&15]+ed[a>>>8&15]+ed[a>>>4&15]+ed[15&a]+ed[n>>>28&15]+ed[n>>>24&15]+ed[n>>>20&15]+ed[n>>>16&15]+ed[n>>>12&15]+ed[n>>>8&15]+ed[n>>>4&15]+ed[15&n]+ed[s>>>28&15]+ed[s>>>24&15]+ed[s>>>20&15]+ed[s>>>16&15]+ed[s>>>12&15]+ed[s>>>8&15]+ed[s>>>4&15]+ed[15&s];return this.is224||(l+=ed[o>>>28&15]+ed[o>>>24&15]+ed[o>>>20&15]+ed[o>>>16&15]+ed[o>>>12&15]+ed[o>>>8&15]+ed[o>>>4&15]+ed[15&o]),l},ey.prototype.toString=ey.prototype.hex,ey.prototype.digest=function(){this.finalize();var e=this.h0,t=this.h1,r=this.h2,i=this.h3,a=this.h4,n=this.h5,s=this.h6,o=this.h7,l=[e>>>24&255,e>>>16&255,e>>>8&255,255&e,t>>>24&255,t>>>16&255,t>>>8&255,255&t,r>>>24&255,r>>>16&255,r>>>8&255,255&r,i>>>24&255,i>>>16&255,i>>>8&255,255&i,a>>>24&255,a>>>16&255,a>>>8&255,255&a,n>>>24&255,n>>>16&255,n>>>8&255,255&n,s>>>24&255,s>>>16&255,s>>>8&255,255&s];return this.is224||l.push(o>>>24&255,o>>>16&255,o>>>8&255,255&o),l},ey.prototype.array=ey.prototype.digest,ey.prototype.arrayBuffer=function(){this.finalize();var e=new ArrayBuffer(this.is224?28:32),t=new DataView(e);return t.setUint32(0,this.h0),t.setUint32(4,this.h1),t.setUint32(8,this.h2),t.setUint32(12,this.h3),t.setUint32(16,this.h4),t.setUint32(20,this.h5),t.setUint32(24,this.h6),this.is224||t.setUint32(28,this.h7),e},e.s([],37872);var ev=e.i(29494);let e_=(...e)=>ep(e.join("_"));function ew(e){return void 0!==e.message?{text:e.text,message:(0,ev.mapStoredMessageToChatMessage)(e.message)}:{text:e.text}}function ek(e){let t={text:e.text};return void 0!==e.message&&(t.message=e.message.toDict()),t}class eO{constructor(){Object.defineProperty(this,"keyEncoder",{enumerable:!0,configurable:!0,writable:!0,value:e_})}makeDefaultKeyEncoder(e){this.keyEncoder=e}}let eP=new Map;class eA extends eO{constructor(e){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=e??new Map}lookup(e,t){return Promise.resolve(this.cache.get(this.keyEncoder(e,t))??null)}async update(e,t,r){this.cache.set(this.keyEncoder(e,t),r)}static global(){return new eA(eP)}}e.s(["BaseCache",()=>eO,"InMemoryCache",()=>eA,"deserializeStoredGeneration",()=>ew,"getCacheKey",0,e_,"serializeGeneration",()=>ek],83507);var eT=e.i(62394),eS=e.i(6696);e.i(31059);var eE=ei;e.i(37253);var ej=e.i(60427),eC=e.i(9139);class ex extends eE.Serializable{async addMessages(e){for(let t of e)await this.addMessage(t)}}class eN extends eE.Serializable{addUserMessage(e){return this.addMessage(new ej.HumanMessage(e))}addAIChatMessage(e){return this.addMessage(new eC.AIMessage(e))}addAIMessage(e){return this.addMessage(new eC.AIMessage(e))}async addMessages(e){for(let t of e)await this.addMessage(t)}clear(){throw Error("Not implemented.")}}class eI extends eN{constructor(e){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","stores","message","in_memory"]}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.messages=e??[]}async getMessages(){return this.messages}async addMessage(e){this.messages.push(e)}async clear(){this.messages=[]}}e.s(["BaseChatMessageHistory",()=>ex,"BaseListChatMessageHistory",()=>eN,"InMemoryChatMessageHistory",()=>eI],865);class eM{constructor(e){Object.defineProperty(this,"pageContent",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.pageContent=void 0!==e.pageContent?e.pageContent.toString():"",this.metadata=e.metadata??{},this.id=e.id}}e.s(["Document",()=>eM],85709);var eR=e.i(20204);class eL extends eR.Runnable{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","documents","transformers"]})}invoke(e,t){return this.transformDocuments(e)}}class e$ extends eL{async transformDocuments(e){let t=[];for(let r of e){let e=await this._transformDocument(r);t.push(e)}return t}}e.s(["BaseDocumentTransformer",()=>eL,"MappingDocumentTransformer",()=>e$],50855),e.s([],43245);var eD=e.i(64527);class eF{constructor(e){Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.caller=new eD.AsyncCaller(e??{})}}e.s(["Embeddings",()=>eF],38624);var eB=ei;class ez extends eB.Serializable{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","example_selectors","base"]})}}e.s(["BaseExampleSelector",()=>ez],56256);class eU{async getPromptAsync(e,t){return this.getPrompt(e).partial(t?.partialVariables??{})}}class eV extends eU{constructor(e,t=[]){super(),Object.defineProperty(this,"defaultPrompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"conditionals",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.defaultPrompt=e,this.conditionals=t}getPrompt(e){for(let[t,r]of this.conditionals)if(t(e))return r;return this.defaultPrompt}}function eK(e){return"base_llm"===e._modelType()}function eZ(e){return"base_chat_model"===e._modelType()}function eW(e){return e.split(/\n| /).length}e.s(["BasePromptSelector",()=>eU,"ConditionalPromptSelector",()=>eV,"isChatModel",()=>eZ,"isLLM",()=>eK],71737);class eG extends ez{constructor(e){super(e),Object.defineProperty(this,"examples",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"examplePrompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"getTextLength",{enumerable:!0,configurable:!0,writable:!0,value:eW}),Object.defineProperty(this,"maxLength",{enumerable:!0,configurable:!0,writable:!0,value:2048}),Object.defineProperty(this,"exampleTextLengths",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.examplePrompt=e.examplePrompt,this.maxLength=e.maxLength??2048,this.getTextLength=e.getTextLength??eW}async addExample(e){this.examples.push(e);let t=await this.examplePrompt.format(e);this.exampleTextLengths.push(this.getTextLength(t))}async calculateExampleTextLengths(e,t){if(e.length>0)return e;let{examples:r,examplePrompt:i}=t;return(await Promise.all(r.map(e=>i.format(e)))).map(e=>this.getTextLength(e))}async selectExamples(e){let t=Object.values(e).join(" "),r=this.maxLength-this.getTextLength(t),i=0,a=[];for(;r>0&&i<this.examples.length;){let e=r-this.exampleTextLengths[i];if(e<0)break;a.push(this.examples[i]),r=e,i+=1}return a}static async fromExamples(e,t){let r=new eG(t);return await Promise.all(e.map(e=>r.addExample(e))),r}}function eq(e){return Object.keys(e).sort().map(t=>e[t])}e.s(["LengthBasedExampleSelector",()=>eG],21609);class eJ extends ez{constructor(e){if(super(e),Object.defineProperty(this,"vectorStoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleKeys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputKeys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.exampleKeys=e.exampleKeys,this.inputKeys=e.inputKeys,void 0!==e.vectorStore)this.vectorStoreRetriever=e.vectorStore.asRetriever({k:e.k??4,filter:e.filter});else if(e.vectorStoreRetriever)this.vectorStoreRetriever=e.vectorStoreRetriever;else throw Error('You must specify one of "vectorStore" and "vectorStoreRetriever".')}async addExample(e){let t=eq((this.inputKeys??Object.keys(e)).reduce((t,r)=>({...t,[r]:e[r]}),{})).join(" ");await this.vectorStoreRetriever.addDocuments([new eM({pageContent:t,metadata:e})])}async selectExamples(e){let t=eq((this.inputKeys??Object.keys(e)).reduce((t,r)=>({...t,[r]:e[r]}),{})).join(" "),r=(await this.vectorStoreRetriever.invoke(t)).map(e=>e.metadata);return this.exampleKeys?r.map(e=>this.exampleKeys.reduce((t,r)=>({...t,[r]:e[r]}),{})):r}static async fromExamples(e,t,r,i={}){let a=i.inputKeys??null,n=e.map(e=>eq(a?a.reduce((t,r)=>({...t,[r]:e[r]}),{}):e).join(" "));return new eJ({vectorStore:await r.fromTexts(n,e,t,i),k:i.k??4,exampleKeys:i.exampleKeys,inputKeys:i.inputKeys})}}e.s(["SemanticSimilarityExampleSelector",()=>eJ],59920),e.s([],77039);var eH=e.i(63025),eY=e.i(6920),eX=Object.defineProperty,eQ=class{specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(e,t){for(const[t,r]of(this.patStr=e.pat_str,Object.entries(e.bpe_ranks.split("\n").filter(Boolean).reduce((e,t)=>{let[r,i,...a]=t.split(" "),n=Number.parseInt(i,10);return a.forEach((t,r)=>e[t]=n+r),e},{})))){const e=eY.default.toByteArray(t);this.rankMap.set(e.join(","),r),this.textMap.set(r,e)}this.specialTokens={...e.special_tokens,...t},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((e,[t,r])=>(e[r]=this.textEncoder.encode(t),e),{})}encode(e,t=[],r="all"){let i=RegExp(this.patStr,"ug"),a=eQ.specialTokenRegex(Object.keys(this.specialTokens)),n=[],s=new Set("all"===t?Object.keys(this.specialTokens):t),o=new Set("all"===r?Object.keys(this.specialTokens).filter(e=>!s.has(e)):r);if(o.size>0){let t=eQ.specialTokenRegex([...o]),r=e.match(t);if(null!=r)throw Error(`The text contains a special token that is not allowed: ${r[0]}`)}let l=0;for(;;){let t=null,r=l;for(;a.lastIndex=r,!(null==(t=a.exec(e))||s.has(t[0]));)r=t.index+1;let o=t?.index??e.length;for(let t of e.substring(l,o).matchAll(i)){let e=this.textEncoder.encode(t[0]),r=this.rankMap.get(e.join(","));if(null!=r){n.push(r);continue}n.push(...function(e,t){return 1===e.length?[t.get(e.join(","))]:(function(e,t){let r=Array.from({length:e.length},(e,t)=>({start:t,end:t+1}));for(;r.length>1;){let i=null;for(let a=0;a<r.length-1;a++){let n=e.slice(r[a].start,r[a+1].end),s=t.get(n.join(","));null!=s&&(null==i||s<i[0])&&(i=[s,a])}if(null!=i){let e=i[1];r[e]={start:r[e].start,end:r[e+1].end},r.splice(e+1,1)}else break}return r})(e,t).map(r=>t.get(e.slice(r.start,r.end).join(","))).filter(e=>null!=e)}(e,this.rankMap))}if(null==t)break;let c=this.specialTokens[t[0]];n.push(c),l=t.index+t[0].length}return n}decode(e){let t=[],r=0;for(let i=0;i<e.length;++i){let a=e[i],n=this.textMap.get(a)??this.inverseSpecialTokens[a];null!=n&&(t.push(n),r+=n.length)}let i=new Uint8Array(r),a=0;for(let e of t)i.set(e,a),a+=e.length;return this.textDecoder.decode(i)}};n="specialTokenRegex",s=e=>RegExp(e.map(e=>e.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")).join("|"),"g"),(a="symbol"!=typeof n?n+"":n)in eQ?eX(eQ,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):eQ[a]=s;let e0={},e1=new eD.AsyncCaller({});async function e2(e){return e in e0||(e0[e]=e1.fetch(`https://tiktoken.pages.dev/js/${e}.json`).then(e=>e.json()).then(e=>new eQ(e)).catch(t=>{throw delete e0[e],t})),await e0[e]}async function e5(e){return e2(function(e){switch(e){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-instruct-0914":case"gpt-3.5-turbo-instruct":case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"gpt-3.5-turbo-0125":case"gpt-4-turbo":case"gpt-4-turbo-2024-04-09":case"gpt-4-turbo-preview":case"gpt-4-0125-preview":case"text-embedding-ada-002":case"text-embedding-3-small":case"text-embedding-3-large":return"cl100k_base";case"gpt-4o":case"gpt-4o-2024-05-13":case"gpt-4o-2024-08-06":case"gpt-4o-2024-11-20":case"gpt-4o-mini-2024-07-18":case"gpt-4o-mini":case"gpt-4o-search-preview":case"gpt-4o-search-preview-2025-03-11":case"gpt-4o-mini-search-preview":case"gpt-4o-mini-search-preview-2025-03-11":case"gpt-4o-audio-preview":case"gpt-4o-audio-preview-2024-12-17":case"gpt-4o-audio-preview-2024-10-01":case"gpt-4o-mini-audio-preview":case"gpt-4o-mini-audio-preview-2024-12-17":case"o1":case"o1-2024-12-17":case"o1-mini":case"o1-mini-2024-09-12":case"o1-preview":case"o1-preview-2024-09-12":case"o1-pro":case"o1-pro-2025-03-19":case"o3":case"o3-2025-04-16":case"o3-mini":case"o3-mini-2025-01-31":case"o4-mini":case"o4-mini-2025-04-16":case"chatgpt-4o-latest":case"gpt-4o-realtime":case"gpt-4o-realtime-preview-2024-10-01":case"gpt-4o-realtime-preview-2024-12-17":case"gpt-4o-mini-realtime-preview":case"gpt-4o-mini-realtime-preview-2024-12-17":case"gpt-4.1":case"gpt-4.1-2025-04-14":case"gpt-4.1-mini":case"gpt-4.1-mini-2025-04-14":case"gpt-4.1-nano":case"gpt-4.1-nano-2025-04-14":case"gpt-4.5-preview":case"gpt-4.5-preview-2025-02-27":case"gpt-5":case"gpt-5-2025-08-07":case"gpt-5-nano":case"gpt-5-nano-2025-08-07":case"gpt-5-mini":case"gpt-5-mini-2025-08-07":case"gpt-5-chat-latest":return"o200k_base";default:throw Error("Unknown model")}}(e))}e.s(["encodingForModel",()=>e5,"getEncoding",()=>e2],11933);var e4=eR;let e3=e=>e.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":e.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":e.startsWith("gpt-4-32k")?"gpt-4-32k":e.startsWith("gpt-4-")?"gpt-4":e.startsWith("gpt-4o")?"gpt-4o":e,e8=e=>{switch(e3(e)){case"gpt-3.5-turbo-16k":return 16384;case"gpt-3.5-turbo":return 4096;case"gpt-4-32k":return 32768;case"gpt-4":return 8192;case"text-davinci-003":default:return 4097;case"text-curie-001":case"text-babbage-001":case"text-ada-001":case"code-cushman-001":return 2048;case"code-davinci-002":return 8e3}};function e6(e){return"object"==typeof e&&!!e&&("type"in e&&"function"===e.type&&"function"in e&&"object"==typeof e.function&&!!e.function&&"name"in e.function&&"parameters"in e.function||!1)}let e9=async({prompt:e,modelName:t})=>{let r;try{r=(await e5(e3(t))).encode(e).length}catch(t){console.warn("Failed to calculate number of tokens, falling back to approximate count"),r=Math.ceil(e.length/4)}return e8(t)-r};class e7 extends e4.Runnable{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){super(e),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??!1,this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}}class te extends e7{get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}constructor({callbacks:e,callbackManager:t,...r}){const{cache:i,...a}=r;super({callbacks:e??t,...a}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),"object"==typeof i?this.cache=i:i?this.cache=eA.global():this.cache=void 0,this.caller=new eD.AsyncCaller(r??{})}async getNumTokens(e){let t,r=Math.ceil((t="string"==typeof e?e:e.map(e=>"string"==typeof e?e:"text"===e.type&&"text"in e?e.text:"").join("")).length/4);if(!this._encoding)try{this._encoding=await e5("modelName"in this?e3(this.modelName):"gpt2")}catch(e){console.warn("Failed to calculate number of tokens, falling back to approximate count",e)}if(this._encoding)try{r=this._encoding.encode(t).length}catch(e){console.warn("Failed to calculate number of tokens, falling back to approximate count",e)}return r}static _convertInputToPromptValue(e){return"string"==typeof e?new eH.StringPromptValue(e):Array.isArray(e)?new eH.ChatPromptValue(e.map(ev.coerceMessageLikeToMessage)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall({config:e,...t}){return Object.entries({...this._identifyingParams(),...t,_type:this._llmType(),_model:this._modelType()}).filter(([e,t])=>void 0!==t).map(([e,t])=>`${e}:${JSON.stringify(t)}`).sort().join(",")}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw Error("Use .toJSON() instead")}}e.s(["BaseLangChain",()=>e7,"BaseLanguageModel",()=>te,"calculateMaxTokens",0,e9,"getEmbeddingContextSize",0,e=>"text-embedding-ada-002"===e?8191:2046,"getModelContextSize",0,e8,"getModelNameForTiktoken",0,e3,"isOpenAITool",()=>e6],81892);var tt=e.i(40470),tr=e.i(89743),ti=e.i(76044),ta=e.i(90406),tn=eR,ts=e.i(40516);class to extends tn.Runnable{static lc_name(){return"RunnablePassthrough"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e&&(this.func=e.func)}async invoke(e,t){let r=(0,ts.ensureConfig)(t);return this.func&&await this.func(e,r),this._callWithConfig(e=>Promise.resolve(e),e,r)}async *transform(e,t){let r,i=(0,ts.ensureConfig)(t),a=!0;for await(let t of this._transformStreamWithConfig(e,e=>e,i))if(yield t,a)if(void 0===r)r=t;else try{r=(0,ta.concat)(r,t)}catch{r=void 0,a=!1}this.func&&void 0!==r&&await this.func(r,i)}static assign(e){return new tn.RunnableAssign(new tn.RunnableMap({steps:e}))}}var tl=e.i(38073),tc=e.i(85337);function tu(){let e=new TextEncoder;return new TransformStream({transform(t,r){r.enqueue(e.encode("string"==typeof t.content?t.content:JSON.stringify(t.content)))}})}function th(e){let t=[];for(let r of e){let e=r;if(Array.isArray(r.content))for(let t=0;t<r.content.length;t++){let i=r.content[t];((0,tr.isURLContentBlock)(i)||(0,tr.isBase64ContentBlock)(i))&&e===r&&(e=new r.constructor({...e,content:[...r.content.slice(0,t),(0,tr.convertToOpenAIImageBlock)(i),...r.content.slice(t+1)]}))}t.push(e)}return t}class tp extends te{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]}),Object.defineProperty(this,"disableStreaming",{enumerable:!0,configurable:!0,writable:!0,value:!1})}_separateRunnableConfigFromCallOptionsCompat(e){let[t,r]=super._separateRunnableConfigFromCallOptions(e);return r.signal=t.signal,[t,r]}async invoke(e,t){let r=tp._convertInputToPromptValue(e);return(await this.generatePrompt([r],t,t?.callbacks)).generations[0][0].message}async *_streamResponseChunks(e,t,r){throw Error("Not implemented.")}async *_streamIterator(e,t){if(this._streamResponseChunks===tp.prototype._streamResponseChunks||this.disableStreaming)yield this.invoke(e,t);else{let r,i,a=tp._convertInputToPromptValue(e).toChatMessages(),[n,s]=this._separateRunnableConfigFromCallOptionsCompat(t),o={...n.metadata,...this.getLsParams(s)},l=await eS.CallbackManager.configure(n.callbacks,this.callbacks,n.tags,this.tags,o,this.metadata,{verbose:this.verbose}),c={options:s,invocation_params:this?.invocationParams(s),batch_size:1},u=await l?.handleChatModelStart(this.toJSON(),[th(a)],n.runId,void 0,c,void 0,void 0,n.runName);try{for await(let e of this._streamResponseChunks(a,s,u?.[0])){if(null==e.message.id){let t=u?.at(0)?.runId;null!=t&&e.message._updateId(`run-${t}`)}e.message.response_metadata={...e.generationInfo,...e.message.response_metadata},yield e.message,r=r?r.concat(e):e,(0,eC.isAIMessageChunk)(e.message)&&void 0!==e.message.usage_metadata&&(i={tokenUsage:{promptTokens:e.message.usage_metadata.input_tokens,completionTokens:e.message.usage_metadata.output_tokens,totalTokens:e.message.usage_metadata.total_tokens}})}}catch(e){throw await Promise.all((u??[]).map(t=>t?.handleLLMError(e))),e}await Promise.all((u??[]).map(e=>e?.handleLLMEnd({generations:[[r]],llmOutput:i})))}}getLsParams(e){let t=this.getName().startsWith("Chat")?this.getName().replace("Chat",""):this.getName();return{ls_model_type:"chat",ls_stop:e.stop,ls_provider:t}}async _generateUncached(e,t,r,i){let a,n=e.map(e=>e.map(ev.coerceMessageLikeToMessage));if(void 0!==i&&i.length===n.length)a=i;else{let e={...r.metadata,...this.getLsParams(t)},i=await eS.CallbackManager.configure(r.callbacks,this.callbacks,r.tags,this.tags,e,this.metadata,{verbose:this.verbose}),s={options:t,invocation_params:this?.invocationParams(t),batch_size:1};a=await i?.handleChatModelStart(this.toJSON(),n.map(th),r.runId,void 0,s,void 0,void 0,r.runName)}let s=[],o=[];if(a?.[0].handlers.find(eT.callbackHandlerPrefersStreaming)&&!this.disableStreaming&&1===n.length&&this._streamResponseChunks!==tp.prototype._streamResponseChunks)try{let e,r;for await(let i of(await this._streamResponseChunks(n[0],t,a?.[0]))){if(null==i.message.id){let e=a?.at(0)?.runId;null!=e&&i.message._updateId(`run-${e}`)}e=void 0===e?i:(0,ta.concat)(e,i),(0,eC.isAIMessageChunk)(i.message)&&void 0!==i.message.usage_metadata&&(r={tokenUsage:{promptTokens:i.message.usage_metadata.input_tokens,completionTokens:i.message.usage_metadata.output_tokens,totalTokens:i.message.usage_metadata.total_tokens}})}if(void 0===e)throw Error("Received empty response from chat model call.");s.push([e]),await a?.[0].handleLLMEnd({generations:s,llmOutput:r})}catch(e){throw await a?.[0].handleLLMError(e),e}else{let e=await Promise.allSettled(n.map((e,r)=>this._generate(e,{...t,promptIndex:r},a?.[r])));await Promise.all(e.map(async(e,t)=>{if("fulfilled"!==e.status)return await a?.[t]?.handleLLMError(e.reason),Promise.reject(e.reason);{let r=e.value;for(let e of r.generations){if(null==e.message.id){let t=a?.at(0)?.runId;null!=t&&e.message._updateId(`run-${t}`)}e.message.response_metadata={...e.generationInfo,...e.message.response_metadata}}return 1===r.generations.length&&(r.generations[0].message.response_metadata={...r.llmOutput,...r.generations[0].message.response_metadata}),s[t]=r.generations,o[t]=r.llmOutput,a?.[t]?.handleLLMEnd({generations:[r.generations],llmOutput:r.llmOutput})}}))}let l={generations:s,llmOutput:o.length?this._combineLLMOutput?.(...o):void 0};return Object.defineProperty(l,ti.RUN_KEY,{value:a?{runIds:a?.map(e=>e.runId)}:void 0,configurable:!0}),l}async _generateCached({messages:e,cache:t,llmStringKey:r,parsedOptions:i,handledOptions:a}){let n=e.map(e=>e.map(ev.coerceMessageLikeToMessage)),s={...a.metadata,...this.getLsParams(i)},o=await eS.CallbackManager.configure(a.callbacks,this.callbacks,a.tags,this.tags,s,this.metadata,{verbose:this.verbose}),l={options:i,invocation_params:this?.invocationParams(i),batch_size:1},c=await o?.handleChatModelStart(this.toJSON(),n.map(th),a.runId,void 0,l,void 0,void 0,a.runName),u=[],h=(await Promise.allSettled(n.map(async(e,i)=>{let a=tp._convertInputToPromptValue(e).toString(),n=await t.lookup(a,r);return null==n&&u.push(i),n}))).map((e,t)=>({result:e,runManager:c?.[t]})).filter(({result:e})=>"fulfilled"===e.status&&null!=e.value||"rejected"===e.status),p=[];await Promise.all(h.map(async({result:e,runManager:t},r)=>{if("fulfilled"!==e.status)return await t?.handleLLMError(e.reason,void 0,void 0,void 0,{cached:!0}),Promise.reject(e.reason);{let i=e.value;return p[r]=i.map(e=>("message"in e&&(0,tt.isBaseMessage)(e.message)&&(0,eC.isAIMessage)(e.message)&&(e.message.usage_metadata={input_tokens:0,output_tokens:0,total_tokens:0}),e.generationInfo={...e.generationInfo,tokenUsage:{}},e)),i.length&&await t?.handleLLMNewToken(i[0].text),t?.handleLLMEnd({generations:[i]},void 0,void 0,void 0,{cached:!0})}}));let d={generations:p,missingPromptIndices:u,startedRunManagers:c};return Object.defineProperty(d,ti.RUN_KEY,{value:c?{runIds:c?.map(e=>e.runId)}:void 0,configurable:!0}),d}async generate(e,t,r){let i;i=Array.isArray(t)?{stop:t}:t;let a=e.map(e=>e.map(ev.coerceMessageLikeToMessage)),[n,s]=this._separateRunnableConfigFromCallOptionsCompat(i);if(n.callbacks=n.callbacks??r,!this.cache)return this._generateUncached(a,s,n);let{cache:o}=this,l=this._getSerializedCacheKeyParametersForCall(s),{generations:c,missingPromptIndices:u,startedRunManagers:h}=await this._generateCached({messages:a,cache:o,llmStringKey:l,parsedOptions:s,handledOptions:n}),p={};if(u.length>0){let e=await this._generateUncached(u.map(e=>a[e]),s,n,void 0!==h?u.map(e=>h?.[e]):void 0);await Promise.all(e.generations.map(async(e,t)=>{let r=u[t];c[r]=e;let i=tp._convertInputToPromptValue(a[r]).toString();return o.update(i,l,e)})),p=e.llmOutput??{}}return{generations:c,llmOutput:p}}invocationParams(e){return{}}_modelType(){return"base_chat_model"}serialize(){return{...this.invocationParams(),_type:this._llmType(),_model:this._modelType()}}async generatePrompt(e,t,r){let i=e.map(e=>e.toChatMessages());return this.generate(i,t,r)}async call(e,t,r){return(await this.generate([e.map(ev.coerceMessageLikeToMessage)],t,r)).generations[0][0].message}async callPrompt(e,t,r){let i=e.toChatMessages();return this.call(i,t,r)}async predictMessages(e,t,r){return this.call(e,t,r)}async predict(e,t,r){let i=new ej.HumanMessage(e),a=await this.call([i],t,r);if("string"!=typeof a.content)throw Error("Cannot use predict when output is not a string.");return a.content}withStructuredOutput(e,t){let r;if("function"!=typeof this.bindTools)throw Error('Chat model must implement ".bindTools()" to use withStructuredOutput.');if(t?.strict)throw Error('"strict" mode is not supported for this model by default.');let i=t?.name,a=(0,tl.getSchemaDescription)(e)??"A function available to call.",n=t?.method,s=t?.includeRaw;if("jsonMode"===n)throw Error('Base withStructuredOutput implementation only supports "functionCalling" as a method.');let o=i??"extract";(0,tl.isInteropZodSchema)(e)?r=[{type:"function",function:{name:o,description:a,parameters:(0,tc.toJsonSchema)(e)}}]:("name"in e&&(o=e.name),r=[{type:"function",function:{name:o,description:a,parameters:e}}]);let l=this.bindTools(r),c=eR.RunnableLambda.from(e=>{if(!e.tool_calls||0===e.tool_calls.length)throw Error("No tool calls found in the response.");let t=e.tool_calls.find(e=>e.name===o);if(!t)throw Error(`No tool call found with name ${o}.`);return t.args});if(!s)return l.pipe(c).withConfig({runName:"StructuredOutput"});let u=to.assign({parsed:(e,t)=>c.invoke(e.raw,t)}),h=to.assign({parsed:()=>null}),p=u.withFallbacks({fallbacks:[h]});return eR.RunnableSequence.from([{raw:l},p]).withConfig({runName:"StructuredOutputRunnable"})}}class td extends tp{async _generate(e,t,r){let i=await this._call(e,t,r),a=new eC.AIMessage(i);if("string"!=typeof a.content)throw Error("Cannot generate with a simple chat model when output is not a string.");return{generations:[{text:a.content,message:a}]}}}e.s(["BaseChatModel",()=>tp,"SimpleChatModel",()=>td,"createChatMessageChunkEncoderStream",()=>tu],6242);class tf extends te{constructor({concurrency:e,...t}){super(e?{maxConcurrency:e,...t}:t),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","llms",this._llmType()]})}async invoke(e,t){let r=tf._convertInputToPromptValue(e);return(await this.generatePrompt([r],t,t?.callbacks)).generations[0][0].text}async *_streamResponseChunks(e,t,r){throw Error("Not implemented.")}_separateRunnableConfigFromCallOptionsCompat(e){let[t,r]=super._separateRunnableConfigFromCallOptions(e);return r.signal=t.signal,[t,r]}async *_streamIterator(e,t){if(this._streamResponseChunks===tf.prototype._streamResponseChunks)yield this.invoke(e,t);else{let r=tf._convertInputToPromptValue(e),[i,a]=this._separateRunnableConfigFromCallOptionsCompat(t),n=await eS.CallbackManager.configure(i.callbacks,this.callbacks,i.tags,this.tags,i.metadata,this.metadata,{verbose:this.verbose}),s={options:a,invocation_params:this?.invocationParams(a),batch_size:1},o=await n?.handleLLMStart(this.toJSON(),[r.toString()],i.runId,void 0,s,void 0,void 0,i.runName),l=new ti.GenerationChunk({text:""});try{for await(let e of this._streamResponseChunks(r.toString(),a,o?.[0]))l=l?l.concat(e):e,"string"==typeof e.text&&(yield e.text)}catch(e){throw await Promise.all((o??[]).map(t=>t?.handleLLMError(e))),e}await Promise.all((o??[]).map(e=>e?.handleLLMEnd({generations:[[l]]})))}}async generatePrompt(e,t,r){let i=e.map(e=>e.toString());return this.generate(i,t,r)}invocationParams(e){return{}}_flattenLLMResult(e){let t=[];for(let r=0;r<e.generations.length;r+=1){let i=e.generations[r];if(0===r)t.push({generations:[i],llmOutput:e.llmOutput});else{let r=e.llmOutput?{...e.llmOutput,tokenUsage:{}}:void 0;t.push({generations:[i],llmOutput:r})}}return t}async _generateUncached(e,t,r,i){let a,n;if(void 0!==i&&i.length===e.length)a=i;else{let i=await eS.CallbackManager.configure(r.callbacks,this.callbacks,r.tags,this.tags,r.metadata,this.metadata,{verbose:this.verbose}),n={options:t,invocation_params:this?.invocationParams(t),batch_size:e.length};a=await i?.handleLLMStart(this.toJSON(),e,r.runId,void 0,n,void 0,void 0,r?.runName)}if(a?.[0].handlers.find(eT.callbackHandlerPrefersStreaming)&&1===e.length&&this._streamResponseChunks!==tf.prototype._streamResponseChunks)try{let r;for await(let i of(await this._streamResponseChunks(e[0],t,a?.[0])))r=void 0===r?i:(0,ta.concat)(r,i);if(void 0===r)throw Error("Received empty response from chat model call.");n={generations:[[r]],llmOutput:{}},await a?.[0].handleLLMEnd(n)}catch(e){throw await a?.[0].handleLLMError(e),e}else{try{n=await this._generate(e,t,a?.[0])}catch(e){throw await Promise.all((a??[]).map(t=>t?.handleLLMError(e))),e}let r=this._flattenLLMResult(n);await Promise.all((a??[]).map((e,t)=>e?.handleLLMEnd(r[t])))}let s=a?.map(e=>e.runId)||void 0;return Object.defineProperty(n,ti.RUN_KEY,{value:s?{runIds:s}:void 0,configurable:!0}),n}async _generateCached({prompts:e,cache:t,llmStringKey:r,parsedOptions:i,handledOptions:a,runId:n}){let s=await eS.CallbackManager.configure(a.callbacks,this.callbacks,a.tags,this.tags,a.metadata,this.metadata,{verbose:this.verbose}),o={options:i,invocation_params:this?.invocationParams(i),batch_size:e.length},l=await s?.handleLLMStart(this.toJSON(),e,n,void 0,o,void 0,void 0,a?.runName),c=[],u=(await Promise.allSettled(e.map(async(e,i)=>{let a=await t.lookup(e,r);return null==a&&c.push(i),a}))).map((e,t)=>({result:e,runManager:l?.[t]})).filter(({result:e})=>"fulfilled"===e.status&&null!=e.value||"rejected"===e.status),h=[];await Promise.all(u.map(async({result:e,runManager:t},r)=>{if("fulfilled"!==e.status)return await t?.handleLLMError(e.reason,void 0,void 0,void 0,{cached:!0}),Promise.reject(e.reason);{let i=e.value;return h[r]=i.map(e=>(e.generationInfo={...e.generationInfo,tokenUsage:{}},e)),i.length&&await t?.handleLLMNewToken(i[0].text),t?.handleLLMEnd({generations:[i]},void 0,void 0,void 0,{cached:!0})}}));let p={generations:h,missingPromptIndices:c,startedRunManagers:l};return Object.defineProperty(p,ti.RUN_KEY,{value:l?{runIds:l?.map(e=>e.runId)}:void 0,configurable:!0}),p}async generate(e,t,r){let i;if(!Array.isArray(e))throw Error("Argument 'prompts' is expected to be a string[]");i=Array.isArray(t)?{stop:t}:t;let[a,n]=this._separateRunnableConfigFromCallOptionsCompat(i);if(a.callbacks=a.callbacks??r,!this.cache)return this._generateUncached(e,n,a);let{cache:s}=this,o=this._getSerializedCacheKeyParametersForCall(n),{generations:l,missingPromptIndices:c,startedRunManagers:u}=await this._generateCached({prompts:e,cache:s,llmStringKey:o,parsedOptions:n,handledOptions:a,runId:a.runId}),h={};if(c.length>0){let t=await this._generateUncached(c.map(t=>e[t]),n,a,void 0!==u?c.map(e=>u?.[e]):void 0);await Promise.all(t.generations.map(async(t,r)=>{let i=c[r];return l[i]=t,s.update(e[i],o,t)})),h=t.llmOutput??{}}return{generations:l,llmOutput:h}}async call(e,t,r){let{generations:i}=await this.generate([e],t,r);return i[0][0].text}async predict(e,t,r){return this.call(e,t,r)}async predictMessages(e,t,r){let i=(0,ev.getBufferString)(e),a=await this.call(i,t,r);return new eC.AIMessage(a)}_identifyingParams(){return{}}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}_modelType(){return"base_llm"}}class tm extends tf{async _generate(e,t,r){return{generations:await Promise.all(e.map((e,i)=>this._call(e,{...t,promptIndex:i},r).then(e=>[{text:e}])))}}}e.s(["BaseLLM",()=>tf,"LLM",()=>tm],38009);class tg{}let tb=(e,t)=>{if(void 0!==t)return e[t];let r=Object.keys(e);if(1===r.length)return e[r[0]]};function ty(e,t){let r=Object.keys(e).filter(e=>!t.includes(e)&&"stop"!==e);if(1!==r.length)throw Error(`One input key expected, but got ${r.length}`);return r[0]}e.s(["BaseMemory",()=>tg,"getInputValue",0,(e,t)=>{let r=tb(e,t);if(!r){let t=Object.keys(e);throw Error(`input values have ${t.length} keys, you must specify an input key or pass only 1 key as input`)}return r},"getOutputValue",0,(e,t)=>{let r=tb(e,t);if(!r&&""!==r){let t=Object.keys(e);throw Error(`output values have ${t.length} keys, you must specify an output key or pass only 1 key as output`)}return r},"getPromptInputKey",()=>ty],45873);var tv=eR;class t_ extends tv.Runnable{static lc_name(){return"RouterRunnable"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnables",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnables=e.runnables}async invoke(e,t){let{key:r,input:i}=e,a=this.runnables[r];if(void 0===a)throw Error(`No runnable associated with key "${r}".`);return a.invoke(i,(0,ts.ensureConfig)(t))}async batch(e,t,r){let i=e.map(e=>e.key),a=e.map(e=>e.input);if(void 0!==i.find(e=>void 0===this.runnables[e]))throw Error("One or more keys do not have a corresponding runnable.");let n=i.map(e=>this.runnables[e]),s=this._getOptionsList(t??{},e.length),o=s[0]?.maxConcurrency??r?.maxConcurrency,l=o&&o>0?o:e.length,c=[];for(let e=0;e<a.length;e+=l){let t=a.slice(e,e+l).map((e,t)=>n[t].invoke(e,s[t])),r=await Promise.all(t);c.push(r)}return c.flat()}async stream(e,t){let{key:r,input:i}=e,a=this.runnables[r];if(void 0===a)throw Error(`No runnable associated with key "${r}".`);return a.stream(i,t)}}var tw=eR;class tk extends tw.Runnable{static lc_name(){return"RunnableBranch"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"default",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"branches",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.branches=e.branches,this.default=e.default}static from(e){if(e.length<1)throw Error("RunnableBranch requires at least one branch");return new this({branches:e.slice(0,-1).map(([e,t])=>[(0,tw._coerceToRunnable)(e),(0,tw._coerceToRunnable)(t)]),default:(0,tw._coerceToRunnable)(e[e.length-1])})}async _invoke(e,t,r){let i;for(let a=0;a<this.branches.length;a+=1){let[n,s]=this.branches[a];if(await n.invoke(e,(0,ts.patchConfig)(t,{callbacks:r?.getChild(`condition:${a+1}`)}))){i=await s.invoke(e,(0,ts.patchConfig)(t,{callbacks:r?.getChild(`branch:${a+1}`)}));break}}return i||(i=await this.default.invoke(e,(0,ts.patchConfig)(t,{callbacks:r?.getChild("branch:default")}))),i}async invoke(e,t={}){return this._callWithConfig(this._invoke,e,t)}async *_streamIterator(e,t){let r,i,a=await (0,ts.getCallbackManagerForConfig)(t),n=await a?.handleChainStart(this.toJSON(),(0,tw._coerceToDict)(e,"input"),t?.runId,void 0,void 0,void 0,t?.runName),s=!0;try{for(let a=0;a<this.branches.length;a+=1){let[o,l]=this.branches[a];if(await o.invoke(e,(0,ts.patchConfig)(t,{callbacks:n?.getChild(`condition:${a+1}`)}))){for await(let o of i=await l.stream(e,(0,ts.patchConfig)(t,{callbacks:n?.getChild(`branch:${a+1}`)})))if(yield o,s)if(void 0===r)r=o;else try{r=(0,ta.concat)(r,o)}catch(e){r=void 0,s=!1}break}}if(void 0===i){for await(let a of i=await this.default.stream(e,(0,ts.patchConfig)(t,{callbacks:n?.getChild("branch:default")})))if(yield a,s)if(void 0===r)r=a;else try{r=(0,ta.concat)(r,a)}catch(e){r=void 0,s=!1}}}catch(e){throw await n?.handleChainError(e),e}await n?.handleChainEnd(r??{})}}var tO=eR;class tP extends tO.RunnableBinding{constructor(e){let t=tO.RunnableLambda.from((e,t)=>this._enterHistory(e,t??{})).withConfig({runName:"loadHistory"});const r=e.historyMessagesKey??e.inputMessagesKey;r&&(t=to.assign({[r]:t}).withConfig({runName:"insertHistory"}));const i=t.pipe(e.runnable.withListeners({onEnd:(e,t)=>this._exitHistory(e,t??{})})).withConfig({runName:"RunnableWithMessageHistory"}),a=e.config??{};super({...e,config:a,bound:i}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputMessagesKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputMessagesKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"historyMessagesKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"getMessageHistory",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.getMessageHistory=e.getMessageHistory,this.inputMessagesKey=e.inputMessagesKey,this.outputMessagesKey=e.outputMessagesKey,this.historyMessagesKey=e.historyMessagesKey}_getInputMessages(e){let t;if("object"!=typeof e||Array.isArray(e)||(0,tt.isBaseMessage)(e))t=e;else{let r;r=this.inputMessagesKey?this.inputMessagesKey:1===Object.keys(e).length?Object.keys(e)[0]:"input",t=Array.isArray(e[r])&&Array.isArray(e[r][0])?e[r][0]:e[r]}if("string"==typeof t)return[new ej.HumanMessage(t)];if(Array.isArray(t))return t;if((0,tt.isBaseMessage)(t))return[t];throw Error(`Expected a string, BaseMessage, or array of BaseMessages.
Got ${JSON.stringify(t,null,2)}`)}_getOutputMessages(e){let t;if(Array.isArray(e)||(0,tt.isBaseMessage)(e)||"string"==typeof e)t=e;else{let r;r=void 0!==this.outputMessagesKey?this.outputMessagesKey:1===Object.keys(e).length?Object.keys(e)[0]:"output",t=void 0!==e.generations?e.generations[0][0].message:e[r]}if("string"==typeof t)return[new eC.AIMessage(t)];if(Array.isArray(t))return t;if((0,tt.isBaseMessage)(t))return[t];throw Error(`Expected a string, BaseMessage, or array of BaseMessages. Received: ${JSON.stringify(t,null,2)}`)}async _enterHistory(e,t){let r=t?.configurable?.messageHistory,i=await r.getMessages();return void 0===this.historyMessagesKey?i.concat(this._getInputMessages(e)):i}async _exitHistory(e,t){let r,i=t.configurable?.messageHistory;r=Array.isArray(e.inputs)&&Array.isArray(e.inputs[0])?e.inputs[0]:e.inputs;let a=this._getInputMessages(r);if(void 0===this.historyMessagesKey){let e=await i.getMessages();a=a.slice(e.length)}let n=e.outputs;if(!n)throw Error(`Output values from 'Run' undefined. Run: ${JSON.stringify(e,null,2)}`);let s=this._getOutputMessages(n);await i.addMessages([...a,...s])}async _mergeConfig(...e){let t=await super._mergeConfig(...e);if(!t.configurable||!t.configurable.sessionId){let e={[this.inputMessagesKey??"input"]:"foo"};throw Error(`sessionId is required. Pass it in as part of the config argument to .invoke() or .stream()
eg. chain.invoke(${JSON.stringify(e)}, ${JSON.stringify({configurable:{sessionId:"123"}})})`)}let{sessionId:r}=t.configurable;return t.configurable.messageHistory=await this.getMessageHistory(r),t}}e.s([],42713);var tA=eR,tT=e.i(69065);class tS extends tA.Runnable{parseResultWithPrompt(e,t,r){return this.parseResult(e,r)}_baseMessageToString(e){return"string"==typeof e.content?e.content:this._baseMessageContentToString(e.content)}_baseMessageContentToString(e){return JSON.stringify(e)}async invoke(e,t){return"string"==typeof e?this._callWithConfig(async(e,t)=>this.parseResult([{text:e}],t?.callbacks),e,{...t,runType:"parser"}):this._callWithConfig(async(e,t)=>this.parseResult([{message:e,text:this._baseMessageToString(e)}],t?.callbacks),e,{...t,runType:"parser"})}}class tE extends tS{parseResult(e,t){return this.parse(e[0].text,t)}async parseWithPrompt(e,t,r){return this.parse(e,r)}_type(){throw Error("_type not implemented")}}class tj extends Error{constructor(e,t,r,i=!1){if(super(e),Object.defineProperty(this,"llmOutput",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"observation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sendToLLM",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmOutput=t,this.observation=r,this.sendToLLM=i,i&&(void 0===r||void 0===t))throw Error("Arguments 'observation' & 'llmOutput' are required if 'sendToLlm' is true");(0,tT.addLangChainErrorFields)(this,"OUTPUT_PARSING_FAILURE")}}e.s(["BaseLLMOutputParser",()=>tS,"BaseOutputParser",()=>tE,"OutputParserException",()=>tj],93834),e.i(62144);var tC=e.i(45668);class tx extends tE{async *_transform(e){for await(let t of e)"string"==typeof t?yield this.parseResult([{text:t}]):yield this.parseResult([{message:t,text:this._baseMessageToString(t)}])}async *transform(e,t){yield*this._transformStreamWithConfig(e,this._transform.bind(this),{...t,runType:"parser"})}}class tN extends tx{constructor(e){super(e),Object.defineProperty(this,"diff",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.diff=e?.diff??this.diff}async *_transform(e){let t,r;for await(let i of e){let e;if("string"!=typeof i&&"string"!=typeof i.content)throw Error("Cannot handle non-string output.");if((0,tt.isBaseMessageChunk)(i)){if("string"!=typeof i.content)throw Error("Cannot handle non-string message output.");e=new ti.ChatGenerationChunk({message:i,text:i.content})}else if((0,tt.isBaseMessage)(i)){if("string"!=typeof i.content)throw Error("Cannot handle non-string message output.");e=new ti.ChatGenerationChunk({message:(0,ev.convertToChunk)(i),text:i.content})}else e=new ti.GenerationChunk({text:i});r=void 0===r?e:r.concat(e);let a=await this.parsePartialResult([r]);null==a||(0,tC.deepCompareStrict)(a,t)||(this.diff?yield this._diff(t,a):yield a,t=a)}}getFormatInstructions(){return""}}e.s(["BaseCumulativeTransformOutputParser",()=>tN,"BaseTransformOutputParser",()=>tx],73763);class tI extends tx{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers","bytes"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"textEncoder",{enumerable:!0,configurable:!0,writable:!0,value:new TextEncoder})}static lc_name(){return"BytesOutputParser"}parse(e){return Promise.resolve(this.textEncoder.encode(e))}getFormatInstructions(){return""}}e.s(["BytesOutputParser",()=>tI],19888);class tM extends tx{constructor(){super(...arguments),Object.defineProperty(this,"re",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}async *_transform(e){let t="";for await(let r of e)if("string"==typeof r?t+=r:t+=r.content,this.re){let e=[...t.matchAll(this.re)];if(e.length>1){let r=0;for(let t of e.slice(0,-1))yield[t[1]],r+=(t.index??0)+t[0].length;t=t.slice(r)}}else{let e=await this.parse(t);if(e.length>1){for(let t of e.slice(0,-1))yield[t];t=e[e.length-1]}}for(let e of(await this.parse(t)))yield[e]}}class tR extends tM{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers","list"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"CommaSeparatedListOutputParser"}async parse(e){try{return e.trim().split(",").map(e=>e.trim())}catch(t){throw new tj(`Could not parse output: ${e}`,e)}}getFormatInstructions(){return"Your response should be a list of comma separated values, eg: `foo, bar, baz`"}}class tL extends tM{constructor({length:e,separator:t}){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers","list"]}),Object.defineProperty(this,"length",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"separator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.length=e,this.separator=t||","}async parse(e){try{let t=e.trim().split(this.separator).map(e=>e.trim());if(void 0!==this.length&&t.length!==this.length)throw new tj(`Incorrect number of items. Expected ${this.length}, got ${t.length}.`);return t}catch(t){if(Object.getPrototypeOf(t)===tj.prototype)throw t;throw new tj(`Could not parse output: ${e}`)}}getFormatInstructions(){return`Your response should be a list of ${void 0===this.length?"":`${this.length} `}items separated by "${this.separator}" (eg: \`foo${this.separator} bar${this.separator} baz\`)`}}class t$ extends tM{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers","list"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"re",{enumerable:!0,configurable:!0,writable:!0,value:/\d+\.\s([^\n]+)/g})}static lc_name(){return"NumberedListOutputParser"}getFormatInstructions(){return`Your response should be a numbered list with each item on a new line. For example: 

1. foo

2. bar

3. baz`}async parse(e){return[...e.matchAll(this.re)??[]].map(e=>e[1])}}class tD extends tM{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers","list"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"re",{enumerable:!0,configurable:!0,writable:!0,value:/^\s*[-*]\s([^\n]+)$/gm})}static lc_name(){return"NumberedListOutputParser"}getFormatInstructions(){return`Your response should be a numbered list with each item on a new line. For example: 

1. foo

2. bar

3. baz`}async parse(e){return[...e.matchAll(this.re)??[]].map(e=>e[1])}}e.s(["CommaSeparatedListOutputParser",()=>tR,"CustomListOutputParser",()=>tL,"ListOutputParser",()=>tM,"MarkdownListOutputParser",()=>tD,"NumberedListOutputParser",()=>t$],24973);class tF extends tx{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers","string"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"StrOutputParser"}parse(e){return Promise.resolve(e)}getFormatInstructions(){return""}_textContentToString(e){return e.text}_imageUrlContentToString(e){throw Error('Cannot coerce a multimodal "image_url" message part into a string.')}_messageContentComplexToString(e){switch(e.type){case"text":case"text_delta":if("text"in e)return this._textContentToString(e);break;case"image_url":if("image_url"in e)return this._imageUrlContentToString(e);break;default:throw Error(`Cannot coerce "${e.type}" message part into a string.`)}throw Error(`Invalid content type: ${e.type}`)}_baseMessageContentToString(e){return e.reduce((e,t)=>e+this._messageContentComplexToString(t),"")}}e.s(["StringOutputParser",()=>tF],24058);var tB=e.i(22632);class tz extends tE{static lc_name(){return"StructuredOutputParser"}toJSON(){return this.toJSONNotImplemented()}constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","structured"]})}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){return new this(tB.z.object(Object.fromEntries(Object.entries(e).map(([e,t])=>[e,tB.z.string().describe(t)]))))}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.

"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.

For example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}
would match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.
Thus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.

Your output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!

Here is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:
\`\`\`json
${JSON.stringify((0,tc.toJsonSchema)(this.schema))}
\`\`\`
`}async parse(e){try{let t=e.trim(),r=(t.match(/^```(?:json)?\s*([\s\S]*?)```/)?.[1]||t.match(/```json\s*([\s\S]*?)```/)?.[1]||t).replace(/"([^"\\]*(\\.[^"\\]*)*)"/g,(e,t)=>{let r=t.replace(/\n/g,"\\n");return`"${r}"`}).replace(/\n/g,"");return await (0,tl.interopParseAsync)(this.schema,JSON.parse(r))}catch(t){throw new tj(`Failed to parse. Text: "${e}". Error: ${t}`,e)}}}class tU extends tz{static lc_name(){return"JsonMarkdownStructuredOutputParser"}getFormatInstructions(e){let t=e?.interpolationDepth??1;if(t<1)throw Error("f string interpolation depth must be at least 1");return`Return a markdown code snippet with a JSON object formatted to look like:
\`\`\`json
${this._schemaToInstruction((0,tc.toJsonSchema)(this.schema)).replaceAll("{","{".repeat(t)).replaceAll("}","}".repeat(t))}
\`\`\``}_schemaToInstruction(e,t=2){if("type"in e){let r,i=!1;if(Array.isArray(e.type)){let t=e.type.findIndex(e=>"null"===e);-1!==t&&(i=!0,e.type.splice(t,1)),r=e.type.join(" | ")}else r=e.type;if("object"===e.type&&e.properties){let r=e.description?` // ${e.description}`:"",i=Object.entries(e.properties).map(([r,i])=>{let a=e.required?.includes(r)?"":" (optional)";return`${" ".repeat(t)}"${r}": ${this._schemaToInstruction(i,t+2)}${a}`}).join("\n");return`{
${i}
${" ".repeat(t-2)}}${r}`}if("array"===e.type&&e.items){let r=e.description?` // ${e.description}`:"";return`array[
${" ".repeat(t)}${this._schemaToInstruction(e.items,t+2)}
${" ".repeat(t-2)}] ${r}`}let a=i?" (nullable)":"",n=e.description?` // ${e.description}`:"";return`${r}${n}${a}`}if("anyOf"in e)return e.anyOf.map(e=>this._schemaToInstruction(e,t)).join(`
${" ".repeat(t-2)}`);throw Error("unsupported schema type")}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){return new this(tB.z.object(Object.fromEntries(Object.entries(e).map(([e,t])=>[e,tB.z.string().describe(t)]))))}}class tV extends tE{constructor({inputSchema:e}){super(...arguments),Object.defineProperty(this,"structuredInputParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.structuredInputParser=new tU(e)}async parse(e){let t;try{t=await this.structuredInputParser.parse(e)}catch(t){throw new tj(`Failed to parse. Text: "${e}". Error: ${t}`,e)}return this.outputProcessor(t)}getFormatInstructions(){return this.structuredInputParser.getFormatInstructions()}}e.s(["AsymmetricStructuredOutputParser",()=>tV,"JsonMarkdownStructuredOutputParser",()=>tU,"StructuredOutputParser",()=>tz],30724),e.i(70803),e.s([],71540);var tK=e.i(18755),tZ=e.i(2438);class tW extends tN{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"JsonOutputParser"}_concatOutputChunks(e,t){return this.diff?super._concatOutputChunks(e,t):t}_diff(e,t){if(t)return e?(0,tK.compare)(e,t):[{op:"replace",path:"",value:t}]}async parsePartialResult(e){return(0,tZ.parseJsonMarkdown)(e[0].text)}async parse(e){return(0,tZ.parseJsonMarkdown)(e,JSON.parse)}getFormatInstructions(){return""}}e.s(["JsonOutputParser",()=>tW],16914);let tG=function(){let e={};e.parser=function(e,t){return new r(e,t)},e.SAXParser=r,e.SAXStream=l,e.createStream=function(e,t){return new l(e,t)},e.MAX_BUFFER_LENGTH=65536;let t=["comment","sgmlDecl","textNode","tagName","doctype","procInstName","procInstBody","entity","attribName","attribValue","cdata","script"];function r(i,a){if(!(this instanceof r))return new r(i,a);(function(e){for(var r=0,i=t.length;r<i;r++)e[t[r]]=""})(this),this.q=this.c="",this.bufferCheckPosition=e.MAX_BUFFER_LENGTH,this.opt=a||{},this.opt.lowercase=this.opt.lowercase||this.opt.lowercasetags,this.looseCase=this.opt.lowercase?"toLowerCase":"toUpperCase",this.tags=[],this.closed=this.closedRoot=this.sawRoot=!1,this.tag=this.error=null,this.strict=!!i,this.noscript=!!(i||this.opt.noscript),this.state=v.BEGIN,this.strictEntities=this.opt.strictEntities,this.ENTITIES=this.strictEntities?Object.create(e.XML_ENTITIES):Object.create(e.ENTITIES),this.attribList=[],this.opt.xmlns&&(this.ns=Object.create(h)),this.trackPosition=!1!==this.opt.position,this.trackPosition&&(this.position=this.line=this.column=0),w(this,"onready")}e.EVENTS=["text","processinginstruction","sgmldeclaration","doctype","comment","opentagstart","attribute","opentag","closetag","opencdata","cdata","closecdata","error","end","ready","script","opennamespace","closenamespace"],Object.create||(Object.create=function(e){function t(){}return t.prototype=e,new t}),Object.keys||(Object.keys=function(e){var t=[];for(var r in e)e.hasOwnProperty(r)&&t.push(r);return t}),r.prototype={end:function(){T(this)},write:function(r){if(this.error)throw this.error;if(this.closed)return A(this,"Cannot write after close. Assign an onready handler.");if(null===r)return T(this);"object"==typeof r&&(r=r.toString());for(var i=0,a="";a=M(r,i++),this.c=a,a;)switch(this.trackPosition&&(this.position++,"\n"===a?(this.line++,this.column=0):this.column++),this.state){case v.BEGIN:if(this.state=v.BEGIN_WHITESPACE,"\uFEFF"===a)continue;I(this,a);continue;case v.BEGIN_WHITESPACE:I(this,a);continue;case v.TEXT:if(this.sawRoot&&!this.closedRoot){for(var n=i-1;a&&"<"!==a&&"&"!==a;)(a=M(r,i++))&&this.trackPosition&&(this.position++,"\n"===a?(this.line++,this.column=0):this.column++);this.textNode+=r.substring(n,i-1)}"<"!==a||this.sawRoot&&this.closedRoot&&!this.strict?(g(a)||this.sawRoot&&!this.closedRoot||S(this,"Text data outside of root node."),"&"===a?this.state=v.TEXT_ENTITY:this.textNode+=a):(this.state=v.OPEN_WAKA,this.startTagPosition=this.position);continue;case v.SCRIPT:"<"===a?this.state=v.SCRIPT_ENDING:this.script+=a;continue;case v.SCRIPT_ENDING:"/"===a?this.state=v.CLOSE_TAG:(this.script+="<"+a,this.state=v.SCRIPT);continue;case v.OPEN_WAKA:"!"===a?(this.state=v.SGML_DECL,this.sgmlDecl=""):g(a)||(y(p,a)?(this.state=v.OPEN_TAG,this.tagName=a):"/"===a?(this.state=v.CLOSE_TAG,this.tagName=""):"?"===a?(this.state=v.PROC_INST,this.procInstName=this.procInstBody=""):(S(this,"Unencoded <"),this.startTagPosition+1<this.position&&(a=Array(this.position-this.startTagPosition).join(" ")+a),this.textNode+="<"+a,this.state=v.TEXT));continue;case v.SGML_DECL:"[CDATA["===(this.sgmlDecl+a).toUpperCase()?(k(this,"onopencdata"),this.state=v.CDATA,this.sgmlDecl="",this.cdata=""):this.sgmlDecl+a==="--"?(this.state=v.COMMENT,this.comment="",this.sgmlDecl=""):"DOCTYPE"===(this.sgmlDecl+a).toUpperCase()?(this.state=v.DOCTYPE,(this.doctype||this.sawRoot)&&S(this,"Inappropriately located doctype declaration"),this.doctype="",this.sgmlDecl=""):">"===a?(k(this,"onsgmldeclaration",this.sgmlDecl),this.sgmlDecl="",this.state=v.TEXT):(b(a)&&(this.state=v.SGML_DECL_QUOTED),this.sgmlDecl+=a);continue;case v.SGML_DECL_QUOTED:a===this.q&&(this.state=v.SGML_DECL,this.q=""),this.sgmlDecl+=a;continue;case v.DOCTYPE:">"===a?(this.state=v.TEXT,k(this,"ondoctype",this.doctype),this.doctype=!0):(this.doctype+=a,"["===a?this.state=v.DOCTYPE_DTD:b(a)&&(this.state=v.DOCTYPE_QUOTED,this.q=a));continue;case v.DOCTYPE_QUOTED:this.doctype+=a,a===this.q&&(this.q="",this.state=v.DOCTYPE);continue;case v.DOCTYPE_DTD:this.doctype+=a,"]"===a?this.state=v.DOCTYPE:b(a)&&(this.state=v.DOCTYPE_DTD_QUOTED,this.q=a);continue;case v.DOCTYPE_DTD_QUOTED:this.doctype+=a,a===this.q&&(this.state=v.DOCTYPE_DTD,this.q="");continue;case v.COMMENT:"-"===a?this.state=v.COMMENT_ENDING:this.comment+=a;continue;case v.COMMENT_ENDING:"-"===a?(this.state=v.COMMENT_ENDED,this.comment=P(this.opt,this.comment),this.comment&&k(this,"oncomment",this.comment),this.comment=""):(this.comment+="-"+a,this.state=v.COMMENT);continue;case v.COMMENT_ENDED:">"!==a?(S(this,"Malformed comment"),this.comment+="--"+a,this.state=v.COMMENT):this.state=v.TEXT;continue;case v.CDATA:"]"===a?this.state=v.CDATA_ENDING:this.cdata+=a;continue;case v.CDATA_ENDING:"]"===a?this.state=v.CDATA_ENDING_2:(this.cdata+="]"+a,this.state=v.CDATA);continue;case v.CDATA_ENDING_2:">"===a?(this.cdata&&k(this,"oncdata",this.cdata),k(this,"onclosecdata"),this.cdata="",this.state=v.TEXT):"]"===a?this.cdata+="]":(this.cdata+="]]"+a,this.state=v.CDATA);continue;case v.PROC_INST:"?"===a?this.state=v.PROC_INST_ENDING:g(a)?this.state=v.PROC_INST_BODY:this.procInstName+=a;continue;case v.PROC_INST_BODY:!this.procInstBody&&g(a)||("?"===a?this.state=v.PROC_INST_ENDING:this.procInstBody+=a);continue;case v.PROC_INST_ENDING:">"===a?(k(this,"onprocessinginstruction",{name:this.procInstName,body:this.procInstBody}),this.procInstName=this.procInstBody="",this.state=v.TEXT):(this.procInstBody+="?"+a,this.state=v.PROC_INST_BODY);continue;case v.OPEN_TAG:y(d,a)?this.tagName+=a:(!function(e){e.strict||(e.tagName=e.tagName[e.looseCase]());var t=e.tags[e.tags.length-1]||e,r=e.tag={name:e.tagName,attributes:{}};e.opt.xmlns&&(r.ns=t.ns),e.attribList.length=0,k(e,"onopentagstart",r)}(this),">"===a?C(this):"/"===a?this.state=v.OPEN_TAG_SLASH:(g(a)||S(this,"Invalid character in tag name"),this.state=v.ATTRIB));continue;case v.OPEN_TAG_SLASH:">"===a?(C(this,!0),x(this)):(S(this,"Forward-slash in opening tag not followed by >"),this.state=v.ATTRIB);continue;case v.ATTRIB:g(a)||(">"===a?C(this):"/"===a?this.state=v.OPEN_TAG_SLASH:y(p,a)?(this.attribName=a,this.attribValue="",this.state=v.ATTRIB_NAME):S(this,"Invalid attribute name"));continue;case v.ATTRIB_NAME:"="===a?this.state=v.ATTRIB_VALUE:">"===a?(S(this,"Attribute without value"),this.attribValue=this.attribName,j(this),C(this)):g(a)?this.state=v.ATTRIB_NAME_SAW_WHITE:y(d,a)?this.attribName+=a:S(this,"Invalid attribute name");continue;case v.ATTRIB_NAME_SAW_WHITE:if("="===a)this.state=v.ATTRIB_VALUE;else{if(g(a))continue;S(this,"Attribute without value"),this.tag.attributes[this.attribName]="",this.attribValue="",k(this,"onattribute",{name:this.attribName,value:""}),this.attribName="",">"===a?C(this):y(p,a)?(this.attribName=a,this.state=v.ATTRIB_NAME):(S(this,"Invalid attribute name"),this.state=v.ATTRIB)}continue;case v.ATTRIB_VALUE:g(a)||(b(a)?(this.q=a,this.state=v.ATTRIB_VALUE_QUOTED):(S(this,"Unquoted attribute value"),this.state=v.ATTRIB_VALUE_UNQUOTED,this.attribValue=a));continue;case v.ATTRIB_VALUE_QUOTED:if(a!==this.q){"&"===a?this.state=v.ATTRIB_VALUE_ENTITY_Q:this.attribValue+=a;continue}j(this),this.q="",this.state=v.ATTRIB_VALUE_CLOSED;continue;case v.ATTRIB_VALUE_CLOSED:g(a)?this.state=v.ATTRIB:">"===a?C(this):"/"===a?this.state=v.OPEN_TAG_SLASH:y(p,a)?(S(this,"No whitespace between attributes"),this.attribName=a,this.attribValue="",this.state=v.ATTRIB_NAME):S(this,"Invalid attribute name");continue;case v.ATTRIB_VALUE_UNQUOTED:if(!(">"===(s=a)||g(s))){"&"===a?this.state=v.ATTRIB_VALUE_ENTITY_U:this.attribValue+=a;continue}j(this),">"===a?C(this):this.state=v.ATTRIB;continue;case v.CLOSE_TAG:this.tagName?">"===a?x(this):y(d,a)?this.tagName+=a:this.script?(this.script+="</"+this.tagName,this.tagName="",this.state=v.SCRIPT):(g(a)||S(this,"Invalid tagname in closing tag"),this.state=v.CLOSE_TAG_SAW_WHITE):g(a)||(y(p,a)?this.tagName=a:this.script?(this.script+="</"+a,this.state=v.SCRIPT):S(this,"Invalid tagname in closing tag."));continue;case v.CLOSE_TAG_SAW_WHITE:if(g(a))continue;">"===a?x(this):S(this,"Invalid characters in closing tag");continue;case v.TEXT_ENTITY:case v.ATTRIB_VALUE_ENTITY_Q:case v.ATTRIB_VALUE_ENTITY_U:switch(this.state){case v.TEXT_ENTITY:o=v.TEXT,l="textNode";break;case v.ATTRIB_VALUE_ENTITY_Q:o=v.ATTRIB_VALUE_QUOTED,l="attribValue";break;case v.ATTRIB_VALUE_ENTITY_U:o=v.ATTRIB_VALUE_UNQUOTED,l="attribValue"}if(";"===a)if(this.opt.unparsedEntities){var s,o,l,c=N(this);this.entity="",this.state=o,this.write(c)}else this[l]+=N(this),this.entity="",this.state=o;else y(this.entity.length?m:f,a)?this.entity+=a:(S(this,"Invalid character in entity name"),this[l]+="&"+this.entity+a,this.entity="",this.state=o);continue;default:throw Error(this,"Unknown state: "+this.state)}return this.position>=this.bufferCheckPosition&&function(r){for(var i=Math.max(e.MAX_BUFFER_LENGTH,10),a=0,n=0,s=t.length;n<s;n++){var o=r[t[n]].length;if(o>i)switch(t[n]){case"textNode":O(r);break;case"cdata":k(r,"oncdata",r.cdata),r.cdata="";break;case"script":k(r,"onscript",r.script),r.script="";break;default:A(r,"Max buffer length exceeded: "+t[n])}a=Math.max(a,o)}r.bufferCheckPosition=e.MAX_BUFFER_LENGTH-a+r.position}(this),this},resume:function(){return this.error=null,this},close:function(){return this.write(null)},flush:function(){O(this),""!==this.cdata&&(k(this,"oncdata",this.cdata),this.cdata=""),""!==this.script&&(k(this,"onscript",this.script),this.script="")}};var i,a,n,s=ReadableStream;s||(s=function(){});var o=e.EVENTS.filter(function(e){return"error"!==e&&"end"!==e});function l(e,t){if(!(this instanceof l))return new l(e,t);s.apply(this),this._parser=new r(e,t),this.writable=!0,this.readable=!0;var i=this;this._parser.onend=function(){i.emit("end")},this._parser.onerror=function(e){i.emit("error",e),i._parser.error=null},this._decoder=null,o.forEach(function(e){Object.defineProperty(i,"on"+e,{get:function(){return i._parser["on"+e]},set:function(t){if(!t)return i.removeAllListeners(e),i._parser["on"+e]=t,t;i.on(e,t)},enumerable:!0,configurable:!1})})}l.prototype=Object.create(s.prototype,{constructor:{value:l}}),l.prototype.write=function(e){return this._parser.write(e.toString()),this.emit("data",e),!0},l.prototype.end=function(e){return e&&e.length&&this.write(e),this._parser.end(),!0},l.prototype.on=function(e,t){var r=this;return r._parser["on"+e]||-1===o.indexOf(e)||(r._parser["on"+e]=function(){var t=1==arguments.length?[arguments[0]]:Array.apply(null,arguments);t.splice(0,0,e),r.emit.apply(r,t)}),s.prototype.on.call(r,e,t)};var c="http://www.w3.org/XML/1998/namespace",u="http://www.w3.org/2000/xmlns/",h={xml:c,xmlns:u},p=/[:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]/,d=/[:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\u00B7\u0300-\u036F\u203F-\u2040.\d-]/,f=/[#:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]/,m=/[#:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\u00B7\u0300-\u036F\u203F-\u2040.\d-]/;function g(e){return" "===e||"\n"===e||"\r"===e||"	"===e}function b(e){return'"'===e||"'"===e}function y(e,t){return e.test(t)}var v=0;for(var _ in e.STATE={BEGIN:v++,BEGIN_WHITESPACE:v++,TEXT:v++,TEXT_ENTITY:v++,OPEN_WAKA:v++,SGML_DECL:v++,SGML_DECL_QUOTED:v++,DOCTYPE:v++,DOCTYPE_QUOTED:v++,DOCTYPE_DTD:v++,DOCTYPE_DTD_QUOTED:v++,COMMENT_STARTING:v++,COMMENT:v++,COMMENT_ENDING:v++,COMMENT_ENDED:v++,CDATA:v++,CDATA_ENDING:v++,CDATA_ENDING_2:v++,PROC_INST:v++,PROC_INST_BODY:v++,PROC_INST_ENDING:v++,OPEN_TAG:v++,OPEN_TAG_SLASH:v++,ATTRIB:v++,ATTRIB_NAME:v++,ATTRIB_NAME_SAW_WHITE:v++,ATTRIB_VALUE:v++,ATTRIB_VALUE_QUOTED:v++,ATTRIB_VALUE_CLOSED:v++,ATTRIB_VALUE_UNQUOTED:v++,ATTRIB_VALUE_ENTITY_Q:v++,ATTRIB_VALUE_ENTITY_U:v++,CLOSE_TAG:v++,CLOSE_TAG_SAW_WHITE:v++,SCRIPT:v++,SCRIPT_ENDING:v++},e.XML_ENTITIES={amp:"&",gt:">",lt:"<",quot:'"',apos:"'"},e.ENTITIES={amp:"&",gt:">",lt:"<",quot:'"',apos:"'",AElig:198,Aacute:193,Acirc:194,Agrave:192,Aring:197,Atilde:195,Auml:196,Ccedil:199,ETH:208,Eacute:201,Ecirc:202,Egrave:200,Euml:203,Iacute:205,Icirc:206,Igrave:204,Iuml:207,Ntilde:209,Oacute:211,Ocirc:212,Ograve:210,Oslash:216,Otilde:213,Ouml:214,THORN:222,Uacute:218,Ucirc:219,Ugrave:217,Uuml:220,Yacute:221,aacute:225,acirc:226,aelig:230,agrave:224,aring:229,atilde:227,auml:228,ccedil:231,eacute:233,ecirc:234,egrave:232,eth:240,euml:235,iacute:237,icirc:238,igrave:236,iuml:239,ntilde:241,oacute:243,ocirc:244,ograve:242,oslash:248,otilde:245,ouml:246,szlig:223,thorn:254,uacute:250,ucirc:251,ugrave:249,uuml:252,yacute:253,yuml:255,copy:169,reg:174,nbsp:160,iexcl:161,cent:162,pound:163,curren:164,yen:165,brvbar:166,sect:167,uml:168,ordf:170,laquo:171,not:172,shy:173,macr:175,deg:176,plusmn:177,sup1:185,sup2:178,sup3:179,acute:180,micro:181,para:182,middot:183,cedil:184,ordm:186,raquo:187,frac14:188,frac12:189,frac34:190,iquest:191,times:215,divide:247,OElig:338,oelig:339,Scaron:352,scaron:353,Yuml:376,fnof:402,circ:710,tilde:732,Alpha:913,Beta:914,Gamma:915,Delta:916,Epsilon:917,Zeta:918,Eta:919,Theta:920,Iota:921,Kappa:922,Lambda:923,Mu:924,Nu:925,Xi:926,Omicron:927,Pi:928,Rho:929,Sigma:931,Tau:932,Upsilon:933,Phi:934,Chi:935,Psi:936,Omega:937,alpha:945,beta:946,gamma:947,delta:948,epsilon:949,zeta:950,eta:951,theta:952,iota:953,kappa:954,lambda:955,mu:956,nu:957,xi:958,omicron:959,pi:960,rho:961,sigmaf:962,sigma:963,tau:964,upsilon:965,phi:966,chi:967,psi:968,omega:969,thetasym:977,upsih:978,piv:982,ensp:8194,emsp:8195,thinsp:8201,zwnj:8204,zwj:8205,lrm:8206,rlm:8207,ndash:8211,mdash:8212,lsquo:8216,rsquo:8217,sbquo:8218,ldquo:8220,rdquo:8221,bdquo:8222,dagger:8224,Dagger:8225,bull:8226,hellip:8230,permil:8240,prime:8242,Prime:8243,lsaquo:8249,rsaquo:8250,oline:8254,frasl:8260,euro:8364,image:8465,weierp:8472,real:8476,trade:8482,alefsym:8501,larr:8592,uarr:8593,rarr:8594,darr:8595,harr:8596,crarr:8629,lArr:8656,uArr:8657,rArr:8658,dArr:8659,hArr:8660,forall:8704,part:8706,exist:8707,empty:8709,nabla:8711,isin:8712,notin:8713,ni:8715,prod:8719,sum:8721,minus:8722,lowast:8727,radic:8730,prop:8733,infin:8734,ang:8736,and:8743,or:8744,cap:8745,cup:8746,int:8747,there4:8756,sim:8764,cong:8773,asymp:8776,ne:8800,equiv:8801,le:8804,ge:8805,sub:8834,sup:8835,nsub:8836,sube:8838,supe:8839,oplus:8853,otimes:8855,perp:8869,sdot:8901,lceil:8968,rceil:8969,lfloor:8970,rfloor:8971,lang:9001,rang:9002,loz:9674,spades:9824,clubs:9827,hearts:9829,diams:9830},Object.keys(e.ENTITIES).forEach(function(t){var r=e.ENTITIES[t],i="number"==typeof r?String.fromCharCode(r):r;e.ENTITIES[t]=i}),e.STATE)e.STATE[e.STATE[_]]=_;function w(e,t,r){e[t]&&e[t](r)}function k(e,t,r){e.textNode&&O(e),w(e,t,r)}function O(e){e.textNode=P(e.opt,e.textNode),e.textNode&&w(e,"ontext",e.textNode),e.textNode=""}function P(e,t){return e.trim&&(t=t.trim()),e.normalize&&(t=t.replace(/\s+/g," ")),t}function A(e,t){return O(e),e.trackPosition&&(t+="\nLine: "+e.line+"\nColumn: "+e.column+"\nChar: "+e.c),e.error=t=Error(t),w(e,"onerror",t),e}function T(e){return e.sawRoot&&!e.closedRoot&&S(e,"Unclosed root tag"),e.state!==v.BEGIN&&e.state!==v.BEGIN_WHITESPACE&&e.state!==v.TEXT&&A(e,"Unexpected end"),O(e),e.c="",e.closed=!0,w(e,"onend"),r.call(e,e.strict,e.opt),e}function S(e,t){if("object"!=typeof e||!(e instanceof r))throw Error("bad call to strictFail");e.strict&&A(e,t)}function E(e,t){var r=0>e.indexOf(":")?["",e]:e.split(":"),i=r[0],a=r[1];return t&&"xmlns"===e&&(i="xmlns",a=""),{prefix:i,local:a}}function j(e){if(e.strict||(e.attribName=e.attribName[e.looseCase]()),-1!==e.attribList.indexOf(e.attribName)||e.tag.attributes.hasOwnProperty(e.attribName)){e.attribName=e.attribValue="";return}if(e.opt.xmlns){var t=E(e.attribName,!0),r=t.prefix,i=t.local;if("xmlns"===r)if("xml"===i&&e.attribValue!==c)S(e,"xml: prefix must be bound to "+c+"\nActual: "+e.attribValue);else if("xmlns"===i&&e.attribValue!==u)S(e,"xmlns: prefix must be bound to "+u+"\nActual: "+e.attribValue);else{var a=e.tag,n=e.tags[e.tags.length-1]||e;a.ns===n.ns&&(a.ns=Object.create(n.ns)),a.ns[i]=e.attribValue}e.attribList.push([e.attribName,e.attribValue])}else e.tag.attributes[e.attribName]=e.attribValue,k(e,"onattribute",{name:e.attribName,value:e.attribValue});e.attribName=e.attribValue=""}function C(e,t){if(e.opt.xmlns){var r=e.tag,i=E(e.tagName);r.prefix=i.prefix,r.local=i.local,r.uri=r.ns[i.prefix]||"",r.prefix&&!r.uri&&(S(e,"Unbound namespace prefix: "+JSON.stringify(e.tagName)),r.uri=i.prefix);var a=e.tags[e.tags.length-1]||e;r.ns&&a.ns!==r.ns&&Object.keys(r.ns).forEach(function(t){k(e,"onopennamespace",{prefix:t,uri:r.ns[t]})});for(var n=0,s=e.attribList.length;n<s;n++){var o=e.attribList[n],l=o[0],c=o[1],u=E(l,!0),h=u.prefix,p=u.local,d=""===h?"":r.ns[h]||"",f={name:l,value:c,prefix:h,local:p,uri:d};h&&"xmlns"!==h&&!d&&(S(e,"Unbound namespace prefix: "+JSON.stringify(h)),f.uri=h),e.tag.attributes[l]=f,k(e,"onattribute",f)}e.attribList.length=0}e.tag.isSelfClosing=!!t,e.sawRoot=!0,e.tags.push(e.tag),k(e,"onopentag",e.tag),t||(e.noscript||"script"!==e.tagName.toLowerCase()?e.state=v.TEXT:e.state=v.SCRIPT,e.tag=null,e.tagName=""),e.attribName=e.attribValue="",e.attribList.length=0}function x(e){if(!e.tagName){S(e,"Weird empty close tag."),e.textNode+="</>",e.state=v.TEXT;return}if(e.script){if("script"!==e.tagName){e.script+="</"+e.tagName+">",e.tagName="",e.state=v.SCRIPT;return}k(e,"onscript",e.script),e.script=""}var t=e.tags.length,r=e.tagName;e.strict||(r=r[e.looseCase]());for(var i=r;t--;)if(e.tags[t].name!==i)S(e,"Unexpected close tag");else break;if(t<0){S(e,"Unmatched closing tag: "+e.tagName),e.textNode+="</"+e.tagName+">",e.state=v.TEXT;return}e.tagName=r;for(var a=e.tags.length;a-- >t;){var n=e.tag=e.tags.pop();e.tagName=e.tag.name,k(e,"onclosetag",e.tagName);var s={};for(var o in n.ns)s[o]=n.ns[o];var l=e.tags[e.tags.length-1]||e;e.opt.xmlns&&n.ns!==l.ns&&Object.keys(n.ns).forEach(function(t){var r=n.ns[t];k(e,"onclosenamespace",{prefix:t,uri:r})})}0===t&&(e.closedRoot=!0),e.tagName=e.attribValue=e.attribName="",e.attribList.length=0,e.state=v.TEXT}function N(e){var t,r=e.entity,i=r.toLowerCase(),a="";return e.ENTITIES[r]?e.ENTITIES[r]:e.ENTITIES[i]?e.ENTITIES[i]:("#"===(r=i).charAt(0)&&(a="x"===r.charAt(1)?(t=parseInt(r=r.slice(2),16)).toString(16):(t=parseInt(r=r.slice(1),10)).toString(10)),r=r.replace(/^0+/,""),isNaN(t)||a.toLowerCase()!==r)?(S(e,"Invalid character entity"),"&"+e.entity+";"):String.fromCodePoint(t)}function I(e,t){"<"===t?(e.state=v.OPEN_WAKA,e.startTagPosition=e.position):g(t)||(S(e,"Non-whitespace before first tag."),e.textNode=t,e.state=v.TEXT)}function M(e,t){var r="";return t<e.length&&(r=e.charAt(t)),r}return v=e.STATE,String.fromCodePoint||(i=String.fromCharCode,a=Math.floor,n=function(){var e,t,r=[],n=-1,s=arguments.length;if(!s)return"";for(var o="";++n<s;){var l=Number(arguments[n]);if(!isFinite(l)||l<0||l>1114111||a(l)!==l)throw RangeError("Invalid code point: "+l);l<=65535?r.push(l):(l-=65536,e=(l>>10)+55296,t=l%1024+56320,r.push(e,t)),(n+1===s||r.length>16384)&&(o+=i.apply(null,r),r.length=0)}return o},Object.defineProperty?Object.defineProperty(String,"fromCodePoint",{value:n,configurable:!0,writable:!0}):String.fromCodePoint=n),e}(),tq=`The output should be formatted as a XML file.
1. Output should conform to the tags below. 
2. If tags are not given, make them on your own.
3. Remember to always open and close all the tags.

As an example, for the tags ["foo", "bar", "baz"]:
1. String "<foo>
   <bar>
      <baz></baz>
   </bar>
</foo>" is a well-formatted instance of the schema. 
2. String "<foo>
   <bar>
   </foo>" is a badly-formatted instance.
3. String "<foo>
   <tag>
   </tag>
</foo>" is a badly-formatted instance.

Here are the output tags:
\`\`\`
{tags}
\`\`\``;class tJ extends tN{constructor(e){super(e),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.tags=e?.tags}static lc_name(){return"XMLOutputParser"}_diff(e,t){if(t)return e?(0,tK.compare)(e,t):[{op:"replace",path:"",value:t}]}async parsePartialResult(e){return tY(e[0].text)}async parse(e){return tY(e)}getFormatInstructions(){return this.tags&&this.tags.length>0?tq.replace("{tags}",this.tags?.join(", ")??""):tq}}let tH=e=>{if(0===Object.keys(e).length)return{};let t={};return e.children.length>0?t[e.name]=e.children.map(tH):t[e.name]=e.text??void 0,t};function tY(e){let t=e.split("\n").map(e=>e.replace(/^\s+/,"")).join("\n").trim(),r=tG.parser(!0),i={},a=[];r.onopentag=e=>{let t={name:e.name,attributes:e.attributes,children:[],text:"",isSelfClosing:e.isSelfClosing};a.length>0?a[a.length-1].children.push(t):i=t,e.isSelfClosing||a.push(t)},r.onclosetag=()=>{if(a.length>0){let e=a.pop();0===a.length&&e&&(i=e)}},r.ontext=e=>{if(a.length>0){let t=a[a.length-1];t.text+=e}},r.onattribute=e=>{a.length>0&&(a[a.length-1].attributes[e.name]=e.value)};let n=/```(xml)?(.*)```/s.exec(t),s=n?n[2]:t;return r.write(s).close(),i&&"?xml"===i.name&&(i=i.children[0]),tH(i)}e.s(["XMLOutputParser",()=>tJ,"XML_FORMAT_INSTRUCTIONS",0,tq,"parseXMLMarkdown",()=>tY],57614),e.s([],39056);var tX=e.i(82979),tQ=e.i(24939),t0=e.i(37121),t1=tX;class t2 extends t1.BasePromptTemplate{static lc_name(){return"PipelinePromptTemplate"}constructor(e){super({...e,inputVariables:[]}),Object.defineProperty(this,"pipelinePrompts",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"finalPrompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.pipelinePrompts=e.pipelinePrompts,this.finalPrompt=e.finalPrompt,this.inputVariables=this.computeInputValues()}computeInputValues(){let e=this.pipelinePrompts.map(e=>e.name);return[...new Set(this.pipelinePrompts.map(t=>t.prompt.inputVariables.filter(t=>!e.includes(t))).flat())]}static extractRequiredInputValues(e,t){return t.reduce((t,r)=>(t[r]=e[r],t),{})}async formatPipelinePrompts(e){let t=await this.mergePartialAndUserVariables(e);for(let{name:e,prompt:r}of this.pipelinePrompts){let i=t2.extractRequiredInputValues(t,r.inputVariables);r instanceof tQ.ChatPromptTemplate?t[e]=await r.formatMessages(i):t[e]=await r.format(i)}return t2.extractRequiredInputValues(t,this.finalPrompt.inputVariables)}async formatPromptValue(e){return this.finalPrompt.formatPromptValue(await this.formatPipelinePrompts(e))}async format(e){return this.finalPrompt.format(await this.formatPipelinePrompts(e))}async partial(e){let t={...this};return t.inputVariables=this.inputVariables.filter(t=>!(t in e)),t.partialVariables={...this.partialVariables??{},...e},new t2(t)}serialize(){throw Error("Not implemented.")}_getPromptType(){return"pipeline"}}e.s(["PipelinePromptTemplate",()=>t2],94154);var t5=e.i(70347);e.s([],64319);var t4=e.i(3305),t3=e.i(20025),t8=e.i(64178),t6=tQ;function t9(e){return"object"==typeof e&&null!=e&&"withStructuredOutput"in e&&"function"==typeof e.withStructuredOutput}class t7 extends t6.ChatPromptTemplate{get lc_aliases(){return{...super.lc_aliases,schema:"schema_"}}constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"method",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","structured"]}),this.schema=e.schema,this.method=e.method}pipe(e){if(t9(e))return super.pipe(e.withStructuredOutput(this.schema));if("object"==typeof e&&null!=e&&"lc_id"in e&&Array.isArray(e.lc_id)&&"langchain_core/runnables/RunnableBinding"===e.lc_id.join("/")&&t9(e.bound))return super.pipe(new eR.RunnableBinding({bound:e.bound.withStructuredOutput(this.schema,...this.method?[{method:this.method}]:[]),kwargs:e.kwargs??{},config:e.config,configFactories:e.configFactories}));throw Error('Structured prompts need to be piped to a language model that supports the "withStructuredOutput()" method.')}static fromMessagesAndSchema(e,t,r){return t7.fromMessages(e,{schema:t,method:r})}}e.s(["StructuredPrompt",()=>t7],17324);var re=e.i(5155);e.s([],14170);var rt=eR;class rr extends rt.Runnable{constructor(e){super(e),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.callbacks=e?.callbacks,this.tags=e?.tags??[],this.metadata=e?.metadata??{},this.verbose=e?.verbose??!1}_getRelevantDocuments(e,t){throw Error("Not implemented!")}async invoke(e,t){return this.getRelevantDocuments(e,(0,ts.ensureConfig)(t))}async getRelevantDocuments(e,t){let r=(0,ts.ensureConfig)((0,eS.parseCallbackConfigArg)(t)),i=await eS.CallbackManager.configure(r.callbacks,this.callbacks,r.tags,this.tags,r.metadata,this.metadata,{verbose:this.verbose}),a=await i?.handleRetrieverStart(this.toJSON(),e,r.runId,void 0,void 0,void 0,r.runName);try{let t=await this._getRelevantDocuments(e,a);return await a?.handleRetrieverEnd(t),t}catch(e){throw await a?.handleRetrieverError(e),e}}}e.s(["BaseRetriever",()=>rr],3349);var ri=ei;class ra extends ri.Serializable{}class rn extends ra{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","storage"]}),Object.defineProperty(this,"store",{enumerable:!0,configurable:!0,writable:!0,value:{}})}async mget(e){return e.map(e=>this.store[e])}async mset(e){for(let[t,r]of e)this.store[t]=r}async mdelete(e){for(let t of e)delete this.store[t]}async *yieldKeys(e){for(let t of Object.keys(this.store))(void 0===e||t.startsWith(e))&&(yield t)}}e.s(["BaseStore",()=>ra,"InMemoryStore",()=>rn],37572);var rs=e.i(70536),ro=e.i(71863),rl=T,rc=e.i(42416);function ru(e){return void 0!==e&&Array.isArray(e.lc_namespace)}function rh(e){return void 0!==e&&eR.Runnable.isRunnable(e)&&"lc_name"in e.constructor&&"function"==typeof e.constructor.lc_name&&"RunnableToolLike"===e.constructor.lc_name()}function rp(e){return!!e&&"object"==typeof e&&"name"in e&&"schema"in e&&((0,tl.isInteropZodSchema)(e.schema)||null!=e.schema&&"object"==typeof e.schema&&"type"in e.schema&&"string"==typeof e.schema.type&&["null","boolean","object","array","number","string"].includes(e.schema.type))}function rd(e){return rp(e)||rh(e)||ru(e)}class rf extends e7{get lc_namespace(){return["langchain","tools"]}constructor(e){super(e??{}),Object.defineProperty(this,"returnDirect",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"verboseParsingErrors",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"responseFormat",{enumerable:!0,configurable:!0,writable:!0,value:"content"}),Object.defineProperty(this,"defaultConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verboseParsingErrors=e?.verboseParsingErrors??this.verboseParsingErrors,this.responseFormat=e?.responseFormat??this.responseFormat,this.defaultConfig=e?.defaultConfig??this.defaultConfig,this.metadata=e?.metadata??this.metadata}async invoke(e,t){let r,i=(0,ts.ensureConfig)((0,ts.mergeConfigs)(this.defaultConfig,t));return(0,rc._isToolCall)(e)?(r=e.args,i={...i,toolCall:e}):r=e,this.call(r,i)}async call(e,t,r){let i,a,n,s,o,l=(0,rc._isToolCall)(e)?e.args:e;if((0,tl.isInteropZodSchema)(this.schema))try{i=await (0,tl.interopParseAsync)(this.schema,l)}catch(r){let t="Received tool input did not match expected schema";throw this.verboseParsingErrors&&(t=`${t}
Details: ${r.message}`),new rc.ToolInputParsingException(t,JSON.stringify(e))}else{let t=(0,rs.validate)(l,this.schema);if(!t.valid){let r="Received tool input did not match expected schema";throw this.verboseParsingErrors&&(r=`${r}
Details: ${t.errors.map(e=>`${e.keywordLocation}: ${e.error}`).join("\n")}`),new rc.ToolInputParsingException(r,JSON.stringify(e))}i=l}let c=(0,eS.parseCallbackConfigArg)(t),u=eS.CallbackManager.configure(c.callbacks,this.callbacks,c.tags||r,this.tags,c.metadata,this.metadata,{verbose:this.verbose}),h=await u?.handleToolStart(this.toJSON(),"string"==typeof e?e:JSON.stringify(e),c.runId,void 0,void 0,void 0,c.runName);delete c.runId;try{a=await this._call(i,h,c)}catch(e){throw await h?.handleToolError(e),e}if("content_and_artifact"===this.responseFormat)if(Array.isArray(a)&&2===a.length)[n,s]=a;else throw Error(`Tool response format is "content_and_artifact" but the output was not a two-tuple.
Result: ${JSON.stringify(a)}`);else n=a;(0,rc._isToolCall)(e)&&(o=e.id),!o&&(0,rc._configHasToolCallId)(c)&&(o=c.toolCall.id);let p=function(e){let{content:t,artifact:r,toolCallId:i,metadata:a}=e;return!i||(0,ro.isDirectToolOutput)(t)?t:new ro.ToolMessage("string"==typeof t||Array.isArray(t)&&t.every(e=>"object"==typeof e)?{status:"success",content:t,artifact:r,tool_call_id:i,name:e.name,metadata:a}:{status:"success",content:function(e){try{return JSON.stringify(e,null,2)??""}catch(t){return`${e}`}}(t),artifact:r,tool_call_id:i,name:e.name,metadata:a})}({content:n,artifact:s,toolCallId:o,name:this.name,metadata:this.metadata});return await h?.handleToolEnd(p),p}}class rm extends rf{constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:tB.z.object({input:tB.z.string().optional()}).transform(e=>e.input)})}call(e,t){return super.call("string"==typeof e||null==e?{input:e}:e,t)}}class rg extends rm{static lc_name(){return"DynamicTool"}constructor(e){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.description=e.description,this.func=e.func,this.returnDirect=e.returnDirect??this.returnDirect}async call(e,t){let r=(0,eS.parseCallbackConfigArg)(t);return void 0===r.runName&&(r.runName=this.name),super.call(e,r)}async _call(e,t,r){return this.func(e,t,r)}}class rb extends rf{static lc_name(){return"DynamicStructuredTool"}constructor(e){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.description=e.description,this.func=e.func,this.returnDirect=e.returnDirect??this.returnDirect,this.schema=e.schema}async call(e,t,r){let i=(0,eS.parseCallbackConfigArg)(t);return void 0===i.runName&&(i.runName=this.name),super.call(e,i,r)}_call(e,t,r){return this.func(e,t,r)}}class ry{getTools(){return this.tools}}function rv(e,t){let r=(0,tl.isSimpleStringZodSchema)(t.schema),i=(0,tc.validatesOnlyStrings)(t.schema);if(!t.schema||r||i)return new rg({...t,description:t.description??(t.schema&&(0,tl.getSchemaDescription)(t.schema))??`${t.name} tool`,func:async(t,r,i)=>new Promise((a,n)=>{let s=(0,ts.patchConfig)(i,{callbacks:r?.getChild()});rl.AsyncLocalStorageProviderSingleton.runWithConfig((0,ts.pickRunnableConfigKeys)(s),async()=>{try{a(e(t,s))}catch(e){n(e)}})})});let a=t.schema,n=t.description??t.schema.description??`${t.name} tool`;return new rb({...t,description:n,schema:a,func:async(t,r,i)=>new Promise((a,n)=>{let s=(0,ts.patchConfig)(i,{callbacks:r?.getChild()});rl.AsyncLocalStorageProviderSingleton.runWithConfig((0,ts.pickRunnableConfigKeys)(s),async()=>{try{a(e(t,s))}catch(e){n(e)}})})})}e.s(["BaseToolkit",()=>ry,"DynamicStructuredTool",()=>rb,"DynamicTool",()=>rg,"StructuredTool",()=>rf,"Tool",()=>rm,"tool",()=>rv],77938);var r_=e.i(91325),rw=e.i(4017),rk=e.i(46833),rO=e.i(96827),rP=r_;class rA extends rP.BaseTracer{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"endpoint",{enumerable:!0,configurable:!0,writable:!0,value:(0,rO.getEnvironmentVariable)("LANGCHAIN_ENDPOINT")||"http://localhost:1984"}),Object.defineProperty(this,"headers",{enumerable:!0,configurable:!0,writable:!0,value:{"Content-Type":"application/json"}}),Object.defineProperty(this,"session",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const e=(0,rO.getEnvironmentVariable)("LANGCHAIN_API_KEY");e&&(this.headers["x-api-key"]=e)}async newSession(e){let t={start_time:Date.now(),name:e},r=await this.persistSession(t);return this.session=r,r}async loadSession(e){let t=`${this.endpoint}/sessions?name=${e}`;return this._handleSessionResponse(t)}async loadDefaultSession(){let e=`${this.endpoint}/sessions?name=default`;return this._handleSessionResponse(e)}async convertV2RunToRun(e){let t,r=this.session??await this.loadDefaultSession(),i=e.serialized;if("llm"===e.run_type){let a=e.inputs.prompts?e.inputs.prompts:e.inputs.messages.map(e=>(0,ev.getBufferString)(e));t={uuid:e.id,start_time:e.start_time,end_time:e.end_time,execution_order:e.execution_order,child_execution_order:e.child_execution_order,serialized:i,type:e.run_type,session_id:r.id,prompts:a,response:e.outputs}}else if("chain"===e.run_type){let a=await Promise.all(e.child_runs.map(e=>this.convertV2RunToRun(e)));t={uuid:e.id,start_time:e.start_time,end_time:e.end_time,execution_order:e.execution_order,child_execution_order:e.child_execution_order,serialized:i,type:e.run_type,session_id:r.id,inputs:e.inputs,outputs:e.outputs,child_llm_runs:a.filter(e=>"llm"===e.type),child_chain_runs:a.filter(e=>"chain"===e.type),child_tool_runs:a.filter(e=>"tool"===e.type)}}else if("tool"===e.run_type){let a=await Promise.all(e.child_runs.map(e=>this.convertV2RunToRun(e)));t={uuid:e.id,start_time:e.start_time,end_time:e.end_time,execution_order:e.execution_order,child_execution_order:e.child_execution_order,serialized:i,type:e.run_type,session_id:r.id,tool_input:e.inputs.input,output:e.outputs?.output,action:JSON.stringify(i),child_llm_runs:a.filter(e=>"llm"===e.type),child_chain_runs:a.filter(e=>"chain"===e.type),child_tool_runs:a.filter(e=>"tool"===e.type)}}else throw Error(`Unknown run type: ${e.run_type}`);return t}async persistRun(e){let t,r;t="llm"===(r=void 0!==e.run_type?await this.convertV2RunToRun(e):e).type?`${this.endpoint}/llm-runs`:"chain"===r.type?`${this.endpoint}/chain-runs`:`${this.endpoint}/tool-runs`;let i=await fetch(t,{method:"POST",headers:this.headers,body:JSON.stringify(r)});i.ok||console.error(`Failed to persist run: ${i.status} ${i.statusText}`)}async persistSession(e){let t=`${this.endpoint}/sessions`,r=await fetch(t,{method:"POST",headers:this.headers,body:JSON.stringify(e)});return r.ok?{id:(await r.json()).id,...e}:(console.error(`Failed to persist session: ${r.status} ${r.statusText}, using default session.`),{id:1,...e})}async _handleSessionResponse(e){let t,r=await fetch(e,{method:"GET",headers:this.headers});if(!r.ok)return console.error(`Failed to load session: ${r.status} ${r.statusText}`),t={id:1,start_time:Date.now()},this.session=t,t;let i=await r.json();return 0===i.length?t={id:1,start_time:Date.now()}:[t]=i,this.session=t,t}}async function rT(e){let t=new rA;return e?await t.loadSession(e):await t.loadDefaultSession(),t}async function rS(){return new rk.LangChainTracer}e.s(["LangChainTracerV1",()=>rA],30481),e.s(["getTracingCallbackHandler",()=>rT,"getTracingV2CallbackHandler",()=>rS],31712);var rE=e.i(99815),rj=r_;class rC extends rj.BaseTracer{constructor({exampleId:e}={}){super({_awaitHandler:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"run_collector"}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracedRuns",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.exampleId=e,this.tracedRuns=[]}async persistRun(e){let t={...e};t.reference_example_id=this.exampleId,this.tracedRuns.push(t)}}function rx(e,t){let r="number"==typeof t?void 0:t;return{name:e.name,description:e.description,parameters:(0,tc.toJsonSchema)(e.schema),...r?.strict!==void 0?{strict:r.strict}:{}}}function rN(e,t){let r,i="number"==typeof t?void 0:t;return r=rd(e)?{type:"function",function:rx(e)}:e,i?.strict!==void 0&&(r.function.strict=i.strict),r}function rI(e,t){let r=0,i=0,a=0;for(let n=0;n<e.length;n++)r+=e[n]*t[n],i+=e[n]*e[n],a+=t[n]*t[n];return r/(Math.sqrt(i)*Math.sqrt(a))}function rM(e,t){let r=0;for(let i=0;i<e.length;i++)r+=e[i]*t[i];return r}function rR(e,t){return Math.sqrt(function(e,t){let r=0;for(let i=0;i<e.length;i++)r+=(e[i]-t[i])*(e[i]-t[i]);return r}(e,t))}function rL(e,t,r){if(0===e.length||0===e[0].length||0===t.length||0===t[0].length)return[[]];if(e[0].length!==t[0].length)throw Error(`Number of columns in X and Y must be the same. X has shape ${[e.length,e[0].length]} and Y has shape ${[t.length,t[0].length]}.`);return e.map(e=>t.map(t=>r(e,t)).map(e=>Number.isNaN(e)?0:e))}function r$(e,t=!1){let r=e.reduce((e,t)=>Math.max(e,rU(t).maxValue),0);return e.map(e=>e.map(e=>t?1-e/r:e/r))}function rD(e,t){return rL(e,t,rI)}function rF(e,t){return rL(e,t,rM)}function rB(e,t){return rL(e,t,rR)}function rz(e,t,r=.5,i=4){if(0>=Math.min(i,t.length))return[];let a=rD(Array.isArray(e[0])?e:[e],t)[0],n=rU(a).maxIndex,s=[t[n]],o=[n];for(;o.length<Math.min(i,t.length);){let e=-1/0,i=-1,n=rD(t,s);a.forEach((t,a)=>{if(o.includes(a))return;let s=r*t-(1-r)*Math.max(...n[a]);s>e&&(e=s,i=a)}),s.push(t[i]),o.push(i)}return o}function rU(e){if(0===e.length)return{maxIndex:-1,maxValue:NaN};let t=e[0],r=0;for(let i=1;i<e.length;i+=1)e[i]>t&&(r=i,t=e[i]);return{maxIndex:r,maxValue:t}}e.s(["RunCollectorCallbackHandler",()=>rC],84663),e.s(["chunkArray",0,(e,t)=>e.reduce((e,r,i)=>{let a=Math.floor(i/t),n=e[a]||[];return e[a]=n.concat([r]),e},[])],43900),e.s(["convertToOpenAIFunction",()=>rx,"convertToOpenAITool",()=>rN],16844),e.s(["cosineSimilarity",()=>rD,"euclideanDistance",()=>rB,"innerProduct",()=>rF,"matrixFunc",()=>rL,"maximalMarginalRelevance",()=>rz,"normalize",()=>r$],5894);var rV=eR,rK=r_,rZ=ei;class rW extends rr{static lc_name(){return"VectorStoreRetriever"}get lc_namespace(){return["langchain_core","vectorstores"]}_vectorstoreType(){return this.vectorStore._vectorstoreType()}constructor(e){super(e),Object.defineProperty(this,"vectorStore",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"k",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(this,"searchType",{enumerable:!0,configurable:!0,writable:!0,value:"similarity"}),Object.defineProperty(this,"searchKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filter",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.vectorStore=e.vectorStore,this.k=e.k??this.k,this.searchType=e.searchType??this.searchType,this.filter=e.filter,"mmr"===e.searchType&&(this.searchKwargs=e.searchKwargs)}async _getRelevantDocuments(e,t){if("mmr"===this.searchType){if("function"!=typeof this.vectorStore.maxMarginalRelevanceSearch)throw Error(`The vector store backing this retriever, ${this._vectorstoreType()} does not support max marginal relevance search.`);return this.vectorStore.maxMarginalRelevanceSearch(e,{k:this.k,filter:this.filter,...this.searchKwargs},t?.getChild("vectorstore"))}return this.vectorStore.similaritySearch(e,this.k,this.filter,t?.getChild("vectorstore"))}async addDocuments(e,t){return this.vectorStore.addDocuments(e,t)}}class rG extends rZ.Serializable{constructor(e,t){super(t),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","vectorstores",this._vectorstoreType()]}),Object.defineProperty(this,"embeddings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.embeddings=e}async delete(e){throw Error("Not implemented.")}async similaritySearch(e,t=4,r,i){return(await this.similaritySearchVectorWithScore(await this.embeddings.embedQuery(e),t,r)).map(e=>e[0])}async similaritySearchWithScore(e,t=4,r,i){return this.similaritySearchVectorWithScore(await this.embeddings.embedQuery(e),t,r)}static fromTexts(e,t,r,i){throw Error("the Langchain vectorstore implementation you are using forgot to override this, please report a bug")}static fromDocuments(e,t,r){throw Error("the Langchain vectorstore implementation you are using forgot to override this, please report a bug")}asRetriever(e,t,r,i,a,n){if("number"==typeof e)return new rW({vectorStore:this,k:e,filter:t,tags:[...i??[],this._vectorstoreType()],metadata:a,verbose:n,callbacks:r});{let t={vectorStore:this,k:e?.k,filter:e?.filter,tags:[...e?.tags??[],this._vectorstoreType()],metadata:e?.metadata,verbose:e?.verbose,callbacks:e?.callbacks,searchType:e?.searchType};return new rW(e?.searchType==="mmr"?{...t,searchKwargs:e.searchKwargs}:{...t})}}}class rq extends rG{static load(e,t){throw Error("Not implemented")}}e.s(["SaveableVectorStore",()=>rq,"VectorStore",()=>rG,"VectorStoreRetriever",()=>rW],43169);class rJ extends tE{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["tests","fake"]})}getFormatInstructions(){return""}async parse(e){return e.split(",").map(e=>e.trim())}}class rH extends rV.Runnable{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["tests","fake"]}),Object.defineProperty(this,"returnOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.returnOptions=e.returnOptions}async invoke(e,t){return this.returnOptions?t??{}:{input:e}}}class rY extends tm{constructor(e){super(e),Object.defineProperty(this,"response",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"thrownErrorString",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.response=e.response,this.thrownErrorString=e.thrownErrorString}_llmType(){return"fake"}async _call(e,t,r){if(this.thrownErrorString)throw Error(this.thrownErrorString);let i=this.response??e;return await r?.handleLLMNewToken(i),i}}class rX extends tm{constructor(e){super(e),Object.defineProperty(this,"sleep",{enumerable:!0,configurable:!0,writable:!0,value:50}),Object.defineProperty(this,"responses",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"thrownErrorString",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.sleep=e.sleep??this.sleep,this.responses=e.responses,this.thrownErrorString=e.thrownErrorString}_llmType(){return"fake"}async _call(e){if(this.thrownErrorString)throw Error(this.thrownErrorString);let t=this.responses?.[0];return this.responses=this.responses?.slice(1),t??e}async *_streamResponseChunks(e,t,r){if(this.thrownErrorString)throw Error(this.thrownErrorString);let i=this.responses?.[0];for(let t of(this.responses=this.responses?.slice(1),i??e))await new Promise(e=>setTimeout(e,this.sleep)),yield{text:t,generationInfo:{}},await r?.handleLLMNewToken(t)}}class rQ extends tp{_combineLLMOutput(){return[]}_llmType(){return"fake"}async _generate(e,t,r){if(t?.stop?.length)return{generations:[{message:new eC.AIMessage(t.stop[0]),text:t.stop[0]}]};let i=e.map(e=>"string"==typeof e.content?e.content:JSON.stringify(e.content,null,2)).join("\n");return await r?.handleLLMNewToken(i),{generations:[{message:new eC.AIMessage(i),text:i}],llmOutput:{}}}}class r0 extends tp{constructor({sleep:e=50,responses:t=[],chunks:r=[],toolStyle:i="openai",thrownErrorString:a,...n}){super(n),Object.defineProperty(this,"sleep",{enumerable:!0,configurable:!0,writable:!0,value:50}),Object.defineProperty(this,"responses",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"chunks",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"toolStyle",{enumerable:!0,configurable:!0,writable:!0,value:"openai"}),Object.defineProperty(this,"thrownErrorString",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tools",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.sleep=e,this.responses=t,this.chunks=r,this.toolStyle=i,this.thrownErrorString=a}_llmType(){return"fake"}bindTools(e){let t=[...this.tools,...e],r=t.map(e=>{switch(this.toolStyle){case"openai":return{type:"function",function:{name:e.name,description:e.description,parameters:(0,tc.toJsonSchema)(e.schema)}};case"anthropic":return{name:e.name,description:e.description,input_schema:(0,tc.toJsonSchema)(e.schema)};case"bedrock":return{toolSpec:{name:e.name,description:e.description,inputSchema:(0,tc.toJsonSchema)(e.schema)}};case"google":return{name:e.name,description:e.description,parameters:(0,tc.toJsonSchema)(e.schema)};default:throw Error(`Unsupported tool style: ${this.toolStyle}`)}}),i="google"===this.toolStyle?[{functionDeclarations:r}]:r,a=new r0({sleep:this.sleep,responses:this.responses,chunks:this.chunks,toolStyle:this.toolStyle,thrownErrorString:this.thrownErrorString});return a.tools=t,a.withConfig({tools:i})}async _generate(e,t,r){if(this.thrownErrorString)throw Error(this.thrownErrorString);let i=this.responses?.[0]?.content??e[0].content??"";return{generations:[{text:"",message:new eC.AIMessage({content:i,tool_calls:this.chunks?.[0]?.tool_calls})}]}}async *_streamResponseChunks(e,t,r){if(this.thrownErrorString)throw Error(this.thrownErrorString);if(this.chunks?.length){for(let e of this.chunks){let t=new ti.ChatGenerationChunk({message:new eC.AIMessageChunk({content:e.content,tool_calls:e.tool_calls,additional_kwargs:e.additional_kwargs??{}}),text:e.content?.toString()??""});yield t,await r?.handleLLMNewToken(e.content,void 0,void 0,void 0,void 0,{chunk:t})}return}let i=this.responses?.[0]??new eC.AIMessage("string"==typeof e[0].content?e[0].content:"");for(let e of"string"==typeof i.content?i.content:""){await new Promise(e=>setTimeout(e,this.sleep));let t=new ti.ChatGenerationChunk({message:new eC.AIMessageChunk({content:e}),text:e});yield t,await r?.handleLLMNewToken(e,void 0,void 0,void 0,void 0,{chunk:t})}}}class r1 extends rr{constructor(e){super(),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["test","fake"]}),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:[new eM({pageContent:"foo"}),new eM({pageContent:"bar"})]}),this.output=e?.output??this.output}async _getRelevantDocuments(e){return this.output}}class r2 extends tp{static lc_name(){return"FakeListChatModel"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"responses",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"i",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"sleep",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"emitCustomEvent",{enumerable:!0,configurable:!0,writable:!0,value:!1});const{responses:t,sleep:r,emitCustomEvent:i}=e;this.responses=t,this.sleep=r,this.emitCustomEvent=i??this.emitCustomEvent}_combineLLMOutput(){return[]}_llmType(){return"fake-list"}async _generate(e,t,r){if(await this._sleepIfRequested(),t?.thrownErrorString)throw Error(t.thrownErrorString);if(this.emitCustomEvent&&await r?.handleCustomEvent("some_test_event",{someval:!0}),t?.stop?.length)return{generations:[this._formatGeneration(t.stop[0])]};{let e=this._currentResponse();return this._incrementResponse(),{generations:[this._formatGeneration(e)],llmOutput:{}}}}_formatGeneration(e){return{message:new eC.AIMessage(e),text:e}}async *_streamResponseChunks(e,t,r){let i=this._currentResponse();for await(let e of(this._incrementResponse(),this.emitCustomEvent&&await r?.handleCustomEvent("some_test_event",{someval:!0}),i)){if(await this._sleepIfRequested(),t?.thrownErrorString)throw Error(t.thrownErrorString);let i=this._createResponseChunk(e);yield i,r?.handleLLMNewToken(e)}}async _sleepIfRequested(){void 0!==this.sleep&&await this._sleep()}async _sleep(){return new Promise(e=>{setTimeout(()=>e(),this.sleep)})}_createResponseChunk(e){return new ti.ChatGenerationChunk({message:new eC.AIMessageChunk({content:e}),text:e})}_currentResponse(){return this.responses[this.i]}_incrementResponse(){this.i<this.responses.length-1?this.i+=1:this.i=0}withStructuredOutput(e,t){return rV.RunnableLambda.from(async e=>{let t=await this.invoke(e);if(t.tool_calls?.[0]?.args)return t.tool_calls[0].args;if("string"==typeof t.content)return JSON.parse(t.content);throw Error("No structured output found")})}}class r5 extends ex{constructor(){super(),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","message","fake"]}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:[]})}async getMessages(){return this.messages}async addMessage(e){this.messages.push(e)}async addUserMessage(e){this.messages.push(new ej.HumanMessage(e))}async addAIChatMessage(e){this.messages.push(new eC.AIMessage(e))}async clear(){this.messages=[]}}class r4 extends eN{constructor(){super(),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","message","fake"]}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:[]})}async addMessage(e){this.messages.push(e)}async getMessages(){return this.messages}}class r3 extends rK.BaseTracer{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"fake_tracer"}),Object.defineProperty(this,"runs",{enumerable:!0,configurable:!0,writable:!0,value:[]})}persistRun(e){return this.runs.push(e),Promise.resolve()}}class r8 extends rf{constructor(e){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.description=e.description,this.schema=e.schema}async _call(e,t){return JSON.stringify(e)}}class r6 extends eF{constructor(e){super(e??{})}embedDocuments(e){return Promise.resolve(e.map(()=>[.1,.2,.3,.4]))}embedQuery(e){return Promise.resolve([.1,.2,.3,.4])}}class r9 extends eF{constructor(e){super(e??{}),Object.defineProperty(this,"vectorSize",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.vectorSize=e?.vectorSize??4}async embedDocuments(e){return Promise.all(e.map(e=>this.embedQuery(e)))}async embedQuery(e){let t=e,r=(t=t.toLowerCase().replaceAll(/[^a-z ]/g,"")).length%this.vectorSize,i=0===r?0:this.vectorSize-r,a=t.length+i,n=(t=t.padEnd(a," ")).length/this.vectorSize,s=[];for(let e=0;e<t.length;e+=n)s.push(t.slice(e,e+n));return s.map(e=>{let t=0;for(let r=0;r<e.length;r+=1)t+=" "===e?0:e.charCodeAt(r);return t%26/26})}}class r7 extends rK.BaseTracer{constructor(){super(),Object.defineProperty(this,"runPromiseResolver",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"runPromise",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"single_run_extractor"}),this.runPromise=new Promise(e=>{this.runPromiseResolver=e})}async persistRun(e){this.runPromiseResolver(e)}async extract(){return this.runPromise}}class ie extends rG{_vectorstoreType(){return"memory"}constructor(e,{similarity:t,...r}={}){super(e,r),Object.defineProperty(this,"memoryVectors",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"similarity",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.similarity=t??rI}async addDocuments(e){let t=e.map(({pageContent:e})=>e);return this.addVectors(await this.embeddings.embedDocuments(t),e)}async addVectors(e,t){let r=e.map((e,r)=>({content:t[r].pageContent,embedding:e,metadata:t[r].metadata}));this.memoryVectors=this.memoryVectors.concat(r)}async similaritySearchVectorWithScore(e,t,r){let i=this.memoryVectors.filter(e=>!r||r(new eM({metadata:e.metadata,pageContent:e.content})));return i.map((t,r)=>({similarity:this.similarity(e,t.embedding),index:r})).sort((e,t)=>e.similarity>t.similarity?-1:0).slice(0,t).map(e=>[new eM({metadata:i[e.index].metadata,pageContent:i[e.index].content}),e.similarity])}static async fromTexts(e,t,r,i){let a=[];for(let r=0;r<e.length;r+=1){let i=Array.isArray(t)?t[r]:t,n=new eM({pageContent:e[r],metadata:i});a.push(n)}return ie.fromDocuments(a,r,i)}static async fromDocuments(e,t,r){let i=new this(t,r);return await i.addDocuments(e),i}static async fromExistingIndex(e,t){return new this(e,t)}}e.s(["FakeChatMessageHistory",()=>r5,"FakeChatModel",()=>rQ,"FakeEmbeddings",()=>r6,"FakeLLM",()=>rY,"FakeListChatMessageHistory",()=>r4,"FakeListChatModel",()=>r2,"FakeRetriever",()=>r1,"FakeRunnable",()=>rH,"FakeSplitIntoListParser",()=>rJ,"FakeStreamingChatModel",()=>r0,"FakeStreamingLLM",()=>rX,"FakeTool",()=>r8,"FakeTracer",()=>r3,"FakeVectorStore",()=>ie,"SingleRunExtractor",()=>r7,"SyntheticEmbeddings",()=>r9],74507),e.s([],43520),e.s([],2729),e.i(2729);var it=e.i(7873),ir=e.i(83507),ii=e.i(20281);e.s(["awaitAllCallbacks",()=>ii.awaitAllCallbacks,"consumeCallback",()=>ii.consumeCallback],47660);var ia=e.i(47660),is=e.i(865);e.i(43245),e.i(85709),e.i(50855),e.s(["BaseDocumentTransformer",()=>eL,"Document",()=>eM,"MappingDocumentTransformer",()=>e$],68871);var io=e.i(68871),il=e.i(38624);e.i(77039),e.i(56256),e.i(71737),e.i(21609),e.i(59920),e.s(["BaseExampleSelector",()=>ez,"BasePromptSelector",()=>eU,"ConditionalPromptSelector",()=>eV,"LengthBasedExampleSelector",()=>eG,"SemanticSimilarityExampleSelector",()=>eJ,"isChatModel",()=>eZ,"isLLM",()=>eK],9154);var ic=e.i(9154),iu=e.i(81892),ih=e.i(6242),ip=e.i(38009),id=e.i(45873),im=e.i(51191),ig=e.i(22480),ib=e.i(11614),iy=e.i(92660),iv=e.i(65955),i_=ro;e.s(["AIMessage",()=>eC.AIMessage,"AIMessageChunk",()=>eC.AIMessageChunk,"BaseMessage",()=>tt.BaseMessage,"BaseMessageChunk",()=>tt.BaseMessageChunk,"ChatMessage",()=>im.ChatMessage,"ChatMessageChunk",()=>im.ChatMessageChunk,"FunctionMessage",()=>ig.FunctionMessage,"FunctionMessageChunk",()=>ig.FunctionMessageChunk,"HumanMessage",()=>ej.HumanMessage,"HumanMessageChunk",()=>ej.HumanMessageChunk,"RemoveMessage",()=>iv.RemoveMessage,"SystemMessage",()=>ib.SystemMessage,"SystemMessageChunk",()=>ib.SystemMessageChunk,"ToolMessage",()=>i_.ToolMessage,"ToolMessageChunk",()=>i_.ToolMessageChunk,"_isMessageFieldWithRole",()=>tt._isMessageFieldWithRole,"_mergeDicts",()=>tt._mergeDicts,"_mergeLists",()=>tt._mergeLists,"_mergeObj",()=>tt._mergeObj,"_mergeStatus",()=>tt._mergeStatus,"coerceMessageLikeToMessage",()=>ev.coerceMessageLikeToMessage,"convertToChunk",()=>ev.convertToChunk,"convertToOpenAIImageBlock",()=>tr.convertToOpenAIImageBlock,"convertToProviderContentBlock",()=>tr.convertToProviderContentBlock,"defaultTextSplitter",()=>iy.defaultTextSplitter,"filterMessages",()=>iy.filterMessages,"getBufferString",()=>ev.getBufferString,"isAIMessage",()=>eC.isAIMessage,"isAIMessageChunk",()=>eC.isAIMessageChunk,"isBase64ContentBlock",()=>tr.isBase64ContentBlock,"isBaseMessage",()=>tt.isBaseMessage,"isBaseMessageChunk",()=>tt.isBaseMessageChunk,"isChatMessage",()=>im.isChatMessage,"isChatMessageChunk",()=>im.isChatMessageChunk,"isDataContentBlock",()=>tr.isDataContentBlock,"isFunctionMessage",()=>ig.isFunctionMessage,"isFunctionMessageChunk",()=>ig.isFunctionMessageChunk,"isHumanMessage",()=>ej.isHumanMessage,"isHumanMessageChunk",()=>ej.isHumanMessageChunk,"isIDContentBlock",()=>tr.isIDContentBlock,"isOpenAIToolCallArray",()=>tt.isOpenAIToolCallArray,"isPlainTextContentBlock",()=>tr.isPlainTextContentBlock,"isSystemMessage",()=>ib.isSystemMessage,"isSystemMessageChunk",()=>ib.isSystemMessageChunk,"isToolMessage",()=>i_.isToolMessage,"isToolMessageChunk",()=>i_.isToolMessageChunk,"isURLContentBlock",()=>tr.isURLContentBlock,"mapChatMessagesToStoredMessages",()=>ev.mapChatMessagesToStoredMessages,"mapStoredMessageToChatMessage",()=>ev.mapStoredMessageToChatMessage,"mapStoredMessagesToChatMessages",()=>ev.mapStoredMessagesToChatMessages,"mergeContent",()=>tt.mergeContent,"mergeMessageRuns",()=>iy.mergeMessageRuns,"parseBase64DataUrl",()=>tr.parseBase64DataUrl,"parseMimeType",()=>tr.parseMimeType,"trimMessages",()=>iy.trimMessages],3283);var iw=e.i(3283);e.i(39056),e.i(93834),e.i(19888),e.i(24973),e.i(24058),e.i(30724),e.i(73763),e.i(16914),e.s(["JsonOutputParser",()=>tW,"parseJsonMarkdown",()=>tZ.parseJsonMarkdown,"parsePartialJson",()=>tZ.parsePartialJson],79196),e.i(79196),e.i(57614),e.s(["AsymmetricStructuredOutputParser",()=>tV,"BaseCumulativeTransformOutputParser",()=>tN,"BaseLLMOutputParser",()=>tS,"BaseOutputParser",()=>tE,"BaseTransformOutputParser",()=>tx,"BytesOutputParser",()=>tI,"CommaSeparatedListOutputParser",()=>tR,"CustomListOutputParser",()=>tL,"JsonMarkdownStructuredOutputParser",()=>tU,"JsonOutputParser",()=>tW,"ListOutputParser",()=>tM,"MarkdownListOutputParser",()=>tD,"NumberedListOutputParser",()=>t$,"OutputParserException",()=>tj,"StringOutputParser",()=>tF,"StructuredOutputParser",()=>tz,"XMLOutputParser",()=>tJ,"XML_FORMAT_INSTRUCTIONS",0,tq,"parseJsonMarkdown",()=>tZ.parseJsonMarkdown,"parsePartialJson",()=>tZ.parsePartialJson,"parseXMLMarkdown",()=>tY],24309);var ik=e.i(24309);e.i(14170),e.i(94154),e.i(64319),e.i(17324),e.s(["AIMessagePromptTemplate",()=>tQ.AIMessagePromptTemplate,"BaseChatPromptTemplate",()=>tQ.BaseChatPromptTemplate,"BaseMessagePromptTemplate",()=>tQ.BaseMessagePromptTemplate,"BaseMessageStringPromptTemplate",()=>tQ.BaseMessageStringPromptTemplate,"BasePromptTemplate",()=>tX.BasePromptTemplate,"BaseStringPromptTemplate",()=>t4.BaseStringPromptTemplate,"ChatMessagePromptTemplate",()=>tQ.ChatMessagePromptTemplate,"ChatPromptTemplate",()=>tQ.ChatPromptTemplate,"DEFAULT_FORMATTER_MAPPING",()=>t3.DEFAULT_FORMATTER_MAPPING,"DEFAULT_PARSER_MAPPING",()=>t3.DEFAULT_PARSER_MAPPING,"DictPromptTemplate",()=>re.DictPromptTemplate,"FewShotChatMessagePromptTemplate",()=>t0.FewShotChatMessagePromptTemplate,"FewShotPromptTemplate",()=>t0.FewShotPromptTemplate,"HumanMessagePromptTemplate",()=>tQ.HumanMessagePromptTemplate,"ImagePromptTemplate",()=>t8.ImagePromptTemplate,"MessagesPlaceholder",()=>tQ.MessagesPlaceholder,"PipelinePromptTemplate",()=>t2,"PromptTemplate",()=>t5.PromptTemplate,"StructuredPrompt",()=>t7,"SystemMessagePromptTemplate",()=>tQ.SystemMessagePromptTemplate,"checkValidTemplate",()=>t3.checkValidTemplate,"interpolateFString",()=>t3.interpolateFString,"interpolateMustache",()=>t3.interpolateMustache,"parseFString",()=>t3.parseFString,"parseMustache",()=>t3.parseMustache,"parseTemplate",()=>t3.parseTemplate,"renderTemplate",()=>t3.renderTemplate],94203);var iO=e.i(94203);e.i(42713);var iP=eR,iA=ts;e.s(["RouterRunnable",()=>t_,"Runnable",()=>iP.Runnable,"RunnableAssign",()=>iP.RunnableAssign,"RunnableBinding",()=>iP.RunnableBinding,"RunnableBranch",()=>tk,"RunnableEach",()=>iP.RunnableEach,"RunnableLambda",()=>iP.RunnableLambda,"RunnableMap",()=>iP.RunnableMap,"RunnableParallel",()=>iP.RunnableParallel,"RunnablePassthrough",()=>to,"RunnablePick",()=>iP.RunnablePick,"RunnableRetry",()=>iP.RunnableRetry,"RunnableSequence",()=>iP.RunnableSequence,"RunnableToolLike",()=>iP.RunnableToolLike,"RunnableWithFallbacks",()=>iP.RunnableWithFallbacks,"RunnableWithMessageHistory",()=>tP,"_coerceToRunnable",()=>iP._coerceToRunnable,"ensureConfig",()=>iA.ensureConfig,"getCallbackManagerForConfig",()=>iA.getCallbackManagerForConfig,"mergeConfigs",()=>iA.mergeConfigs,"patchConfig",()=>iA.patchConfig,"pickRunnableConfigKeys",()=>iA.pickRunnableConfigKeys],86596);var iT=e.i(86596),iS=e.i(3349),iE=e.i(37572);e.i(77938),e.s(["BaseToolkit",()=>ry,"DynamicStructuredTool",()=>rb,"DynamicTool",()=>rg,"StructuredTool",()=>rf,"Tool",()=>rm,"ToolInputParsingException",()=>rc.ToolInputParsingException,"isLangChainTool",()=>rd,"isRunnableToolLike",()=>rh,"isStructuredTool",()=>ru,"isStructuredToolParams",()=>rp,"tool",()=>rv],56778);var ij=e.i(56778),iC=e.i(31712),ix=e.i(84663),iN=e.i(30481),iI=e.i(43900);e.i(16844),e.s(["convertToOpenAIFunction",()=>rx,"convertToOpenAITool",()=>rN,"isLangChainTool",()=>rd,"isRunnableToolLike",()=>rh,"isStructuredTool",()=>ru,"isStructuredToolParams",()=>rp],95460);var iM=e.i(95460);e.i(37872),e.s(["insecureHash",0,ep,"sha256",0,(...e)=>new ey(!1,!0).update(e.join("")).hex()],32332);var iR=e.i(32332);e.i(71540);var iL=e.i(7224);e.s(["applyPatch",()=>iL.applyPatch,"compare",()=>tK.compare],92610);var i$=e.i(92610),iD=e.i(58189);e.s(["Validator",()=>iD.Validator,"deepCompareStrict",()=>tC.deepCompareStrict,"toJsonSchema",()=>tc.toJsonSchema,"validatesOnlyStrings",()=>tc.validatesOnlyStrings],99369);var iF=e.i(99369),iB=e.i(5894),iz=e.i(74507),iU=e.i(11933);e.i(43520),e.s(["extendInteropZodObject",()=>tl.extendInteropZodObject,"getInteropZodDefaultGetter",()=>tl.getInteropZodDefaultGetter,"getInteropZodObjectShape",()=>tl.getInteropZodObjectShape,"getSchemaDescription",()=>tl.getSchemaDescription,"interopParse",()=>tl.interopParse,"interopParseAsync",()=>tl.interopParseAsync,"interopSafeParse",()=>tl.interopSafeParse,"interopSafeParseAsync",()=>tl.interopSafeParseAsync,"interopZodObjectPartial",()=>tl.interopZodObjectPartial,"interopZodObjectPassthrough",()=>tl.interopZodObjectPassthrough,"interopZodObjectStrict",()=>tl.interopZodObjectStrict,"interopZodTransformInputSchema",()=>tl.interopZodTransformInputSchema,"isInteropZodObject",()=>tl.isInteropZodObject,"isInteropZodSchema",()=>tl.isInteropZodSchema,"isShapelessZodSchema",()=>tl.isShapelessZodSchema,"isSimpleStringZodSchema",()=>tl.isSimpleStringZodSchema,"isZodArrayV4",()=>tl.isZodArrayV4,"isZodObjectV3",()=>tl.isZodObjectV3,"isZodObjectV4",()=>tl.isZodObjectV4,"isZodSchema",()=>tl.isZodSchema,"isZodSchemaV3",()=>tl.isZodSchemaV3,"isZodSchemaV4",()=>tl.isZodSchemaV4],49273);var iV=e.i(49273),iK=e.i(43169);e.s(["agents",0,it,"caches",0,ir,"callbacks__base",0,eT,"callbacks__manager",0,eS,"callbacks__promises",0,ia,"chat_history",0,is,"documents",0,io,"embeddings",0,il,"example_selectors",0,ic,"language_models__base",0,iu,"language_models__chat_models",0,ih,"language_models__llms",0,ip,"load__serializable",0,ei,"memory",0,id,"messages",0,iw,"output_parsers",0,ik,"outputs",0,ti,"prompt_values",0,eH,"prompts",0,iO,"retrievers",0,iS,"runnables",0,iT,"stores",0,iE,"tools",0,ij,"tracers__base",0,r_,"tracers__console",0,rw,"tracers__initialize",0,iC,"tracers__log_stream",0,rE,"tracers__run_collector",0,ix,"tracers__tracer_langchain",0,rk,"tracers__tracer_langchain_v1",0,iN,"utils__async_caller",0,eD,"utils__chunk_array",0,iI,"utils__env",0,rO,"utils__function_calling",0,iM,"utils__hash",0,iR,"utils__json_patch",0,i$,"utils__json_schema",0,iF,"utils__math",0,iB,"utils__stream",0,ta,"utils__testing",0,iz,"utils__tiktoken",0,iU,"utils__types",0,iV,"vectorstores",0,iK],32005);var iZ=e.i(32005),iW=e.i(73247),iG=e.i(72110);async function iq(e){let{optionalImportsMap:t,optionalImportEntrypoints:r,importMap:i,secretsMap:a,secretsFromEnv:n,path:s,depth:o,maxDepth:l}=this,c=s.join(".");if(o>l)throw Error(`Maximum recursion depth (${l}) exceeded during deserialization. This may indicate a malicious payload or you may need to increase maxDepth.`);if("object"!=typeof e||null==e)return e;if(Array.isArray(e))return Promise.all(e.map((e,t)=>iq.call({...this,path:[...s,`${t}`],depth:o+1},e)));if((0,iG.isEscapedObject)(e))return(0,iG.unescapeValue)(e);if("lc"in e&&"type"in e&&"id"in e&&1===e.lc&&"secret"===e.type){let[t]=e.id;if(t in a)return a[t];if(n){let e=(0,rO.getEnvironmentVariable)(t);if(e)return e}throw Error(`Missing secret "${t}" at ${c}`)}if("lc"in e&&"type"in e&&"id"in e&&1===e.lc&&"not_implemented"===e.type){let t=JSON.stringify(e);throw Error(`Trying to load an object that doesn't implement serialization: ${c} -> ${t}`)}if("lc"in e&&"type"in e&&"id"in e&&"kwargs"in e&&1===e.lc&&"constructor"===e.type){let a=JSON.stringify(e),[n,...l]=e.id.slice().reverse(),u=l.reverse(),h=null,p=[u.join("/")];"langchain_community"===u[0]&&p.push(["langchain",...u.slice(1)].join("/"));let d=p.find(e=>e in t);if(ea.concat(r).includes(u.join("/"))||d)if(void 0!==d)h=await t[d];else throw Error(`Missing key "${u.join("/")}" for ${c} in load(optionalImportsMap={})`);else{let e,t;if("langchain"===u[0]||"langchain_core"===u[0])e=({langchain_core:iZ,langchain:i})[u[0]],u.shift();else throw Error(`Invalid namespace: ${c} -> ${a}`);if(0===u.length)throw Error(`Invalid namespace: ${c} -> ${a}`);do{if((t=u.join("__"))in e)break;u.pop()}while(u.length>0)t in e&&(h=e[t])}if("object"!=typeof h||null===h)throw Error(`Invalid namespace: ${c} -> ${a}`);let f=h[n]??Object.values(h).find(e=>"function"==typeof e&&(0,ei.get_lc_unique_name)(e)===n);if("function"!=typeof f)throw Error(`Invalid identifer: ${c} -> ${a}`);let m=await iq.call({...this,path:[...s,"kwargs"],depth:o+1},e.kwargs),g=new f((0,iW.mapKeys)(m,iW.keyFromJson,function(e){let t={};for(let r=e;r&&r.prototype;r=Object.getPrototypeOf(r))Object.assign(t,Reflect.get(r.prototype,"lc_aliases"));return Object.entries(t).reduce((e,[t,r])=>(e[r]=t,e),{})}(f)));return Object.defineProperty(g.constructor,"name",{value:n}),g}let u={};for(let[t,r]of Object.entries(e))u[t]=await iq.call({...this,path:[...s,t],depth:o+1},r);return u}async function iJ(e,t){let r=JSON.parse(e),i={optionalImportsMap:t?.optionalImportsMap??{},optionalImportEntrypoints:t?.optionalImportEntrypoints??[],secretsMap:t?.secretsMap??{},secretsFromEnv:t?.secretsFromEnv??!1,importMap:t?.importMap??{},path:["$"],depth:0,maxDepth:t?.maxDepth??50};return iq.call(i,r)}var iH=[],iY=[];function iX(e,t,r,i){var a=Object.getOwnPropertyDescriptor(i,r);void 0!==a.get?a.configurable?(Object.defineProperty(i,r,{value:e}),iH.push([i,r,t,a])):iY.push([t,r,e]):(i[r]=e,iH.push([i,r,t]))}async function iQ(e){if(e&&"object"==typeof e)if(Array.isArray(e))return await Promise.all(e.map(e=>iQ(e)));else{let t={};for(let[r,i]of Object.entries(e))t[r]=await iQ(i);if(2===t.lc&&"undefined"===t.type)return;if(2===t.lc&&"constructor"===t.type&&Array.isArray(t.id))try{let e;switch(t.id[t.id.length-1]){case"Set":e=Set;break;case"Map":e=Map;break;case"RegExp":e=RegExp;break;case"Error":e=Error;break;default:return t}if(t.method)return e[t.method](...t.args||[]);return new e(...t.args||[])}catch(e){}else if(null!==t&&1===t.lc&&"constructor"===t.type&&Array.isArray(t.id))return iJ(JSON.stringify(t));return t}return e}function i0(e,t,r,i){return{lc:2,type:"constructor",id:[e.name],method:t??null,args:r??[],kwargs:i??{}}}class i1{_dumps(e){return new TextEncoder().encode(function(e,t,r,i){void 0===i&&(i={depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}),function e(t,r,i,a,n,s,o){if(s+=1,"object"==typeof t&&null!==t){for(l=0;l<a.length;l++)if(a[l]===t)return void iX("[Circular]",t,r,n);if(void 0!==o.depthLimit&&s>o.depthLimit||void 0!==o.edgesLimit&&i+1>o.edgesLimit)return void iX("[...]",t,r,n);if(a.push(t),Array.isArray(t))for(l=0;l<t.length;l++)e(t[l],l,l,a,t,s,o);else{var l,c=Object.keys(t);for(l=0;l<c.length;l++){var u=c[l];e(t[u],u,l,a,t,s,o)}}a.pop()}}(e,"",0,[],void 0,0,i);try{var a;n=0===iY.length?JSON.stringify(e,t,void 0):JSON.stringify(e,(a=t,a=void 0!==a?a:function(e,t){return t},function(e,t){if(iY.length>0)for(var r=0;r<iY.length;r++){var i=iY[r];if(i[1]===e&&i[0]===t){t=i[2],iY.splice(r,1);break}}return a.call(this,e,t)}),void 0)}catch(e){return JSON.stringify("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;0!==iH.length;){var n,s=iH.pop();4===s.length?Object.defineProperty(s[0],s[1],s[3]):s[0][s[1]]=s[2]}}return n}(e,(e,t)=>(function(e){if(void 0===e)return{lc:2,type:"undefined"};if(e instanceof Set||e instanceof Map)return i0(e.constructor,void 0,[Array.from(e)]);if(e instanceof RegExp)return i0(RegExp,void 0,[e.source,e.flags]);if(e instanceof Error)return i0(e.constructor,void 0,[e.message]);if(e?.lg_name==="Send")return{node:e.node,args:e.args};else return e})(t)))}dumpsTyped(e){return e instanceof Uint8Array?["bytes",e]:["json",this._dumps(e)]}async _loads(e){return iQ(JSON.parse(e))}async loadsTyped(e,t){if("bytes"===e)return"string"==typeof t?new TextEncoder().encode(t):t;if("json"===e)return this._loads("string"==typeof t?t:new TextDecoder().decode(t));throw Error(`Unknown serialization type: ${e}`)}}function i2(e){if("object"!=typeof e||null===e)return e;let t=Array.isArray(e)?[]:{};for(let r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=i2(e[r]));return t}function i5(){return{v:1,id:Y(-2),ts:new Date().toISOString(),channel_values:{},channel_versions:{},versions_seen:{},pending_sends:[]}}function i4(e){return{v:e.v,id:e.id,ts:e.ts,channel_values:{...e.channel_values},channel_versions:{...e.channel_versions},versions_seen:i2(e.versions_seen),pending_sends:[...e.pending_sends]}}class i3{constructor(e){Object.defineProperty(this,"serde",{enumerable:!0,configurable:!0,writable:!0,value:new i1}),this.serde=e||this.serde}async get(e){let t=await this.getTuple(e);return t?t.checkpoint:void 0}getNextVersion(e,t){if("string"==typeof e)throw Error("Please override this method to use string versions.");return void 0!==e&&"number"==typeof e?e+1:1}}function i8(e,t){return"number"==typeof e&&"number"==typeof t?Math.sign(e-t):String(e).localeCompare(String(t))}function i6(...e){return e.reduce((e,t,r)=>0===r?t:i8(e,t)>=0?e:t)}let i9={[Q]:-1,[ee]:-2,[et]:-3,[er]:-4};function i7(e){return e.configurable?.checkpoint_id||e.configurable?.thread_ts||""}e.s(["BaseCheckpointSaver",()=>i3,"WRITES_IDX_MAP",0,i9,"compareChannelVersions",()=>i8,"copyCheckpoint",()=>i4,"deepCopy",()=>i2,"emptyCheckpoint",()=>i5,"getCheckpointId",()=>i7,"maxChannelVersion",()=>i6],98038),e.s([],41738),e.s([],52536);class ae extends Error{constructor(e){super(e),this.name="InvalidNamespaceError"}}function at(e,t){let r=t.split("."),i=e;for(let e of r){if(e.includes("[")){let[t,r]=e.split("["),a=r.replace("]","");if(!i[t])return[];if("*"===a){let e=[];for(let r of i[t])"string"==typeof r&&e.push(r);return e}let n=parseInt(a,10);if(Number.isNaN(n))return[];i=i[t][n]}else i=i[e];if(void 0===i)return[]}return"string"==typeof i?[i]:[]}function ar(e){return e.split(".")}class ai{async get(e,t){return(await this.batch([{namespace:e,key:t}]))[0]}async search(e,t={}){let{filter:r,limit:i=10,offset:a=0,query:n}=t;return(await this.batch([{namespacePrefix:e,filter:r,limit:i,offset:a,query:n}]))[0]}async put(e,t,r,i){if(0===e.length)throw new ae("Namespace cannot be empty.");for(let t of e){if("string"!=typeof t)throw new ae(`Invalid namespace label '${t}' found in ${e}. Namespace labels must be strings, but got ${typeof t}.`);if(t.includes("."))throw new ae(`Invalid namespace label '${t}' found in ${e}. Namespace labels cannot contain periods ('.').`);if(""===t)throw new ae(`Namespace labels cannot be empty strings. Got ${t} in ${e}`)}if("langgraph"===e[0])throw new ae(`Root label for namespace cannot be "langgraph". Got: ${e}`);await this.batch([{namespace:e,key:t,value:r,index:i}])}async delete(e,t){await this.batch([{namespace:e,key:t,value:null}])}async listNamespaces(e={}){let{prefix:t,suffix:r,maxDepth:i,limit:a=100,offset:n=0}=e,s=[];return t&&s.push({matchType:"prefix",path:t}),r&&s.push({matchType:"suffix",path:r}),(await this.batch([{matchConditions:s.length?s:void 0,maxDepth:i,limit:a,offset:n}]))[0]}start(){}stop(){}}e.s(["BaseStore",()=>ai,"InvalidNamespaceError",()=>ae,"getTextAtPath",()=>at,"tokenizePath",()=>ar],71972);class aa extends ai{constructor(e){super(),Object.defineProperty(this,"lg_name",{enumerable:!0,configurable:!0,writable:!0,value:"AsyncBatchedStore"}),Object.defineProperty(this,"store",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"nextKey",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"running",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"processingTask",{enumerable:!0,configurable:!0,writable:!0,value:null}),this.store=(e=>"lg_name"in e&&"AsyncBatchedStore"===e.lg_name?e.store:e)(e)}get isRunning(){return this.running}async batch(e){throw Error("The `batch` method is not implemented on `AsyncBatchedStore`.\n Instead, it calls the `batch` method on the wrapped store.\n If you are seeing this error, something is wrong.")}async get(e,t){return this.enqueueOperation({namespace:e,key:t})}async search(e,t){let{filter:r,limit:i=10,offset:a=0,query:n}=t||{};return this.enqueueOperation({namespacePrefix:e,filter:r,limit:i,offset:a,query:n})}async put(e,t,r){return this.enqueueOperation({namespace:e,key:t,value:r})}async delete(e,t){return this.enqueueOperation({namespace:e,key:t,value:null})}start(){this.running||(this.running=!0,this.processingTask=this.processBatchQueue())}async stop(){this.running=!1,this.processingTask&&await this.processingTask}enqueueOperation(e){return new Promise((t,r)=>{let i=this.nextKey;this.nextKey+=1,this.queue.set(i,{operation:e,resolve:t,reject:r})})}async processBatchQueue(){for(;this.running;){if(await new Promise(e=>{setTimeout(e,0)}),0===this.queue.size)continue;let e=new Map(this.queue);this.queue.clear();try{let t=Array.from(e.values()).map(({operation:e})=>e),r=await this.store.batch(t);e.forEach(({resolve:t},i)=>{let a=Array.from(e.keys()).indexOf(i);t(r[a])})}catch(t){e.forEach(({reject:e})=>{e(t)})}}}toJSON(){return{queue:this.queue,nextKey:this.nextKey,running:this.running,store:"[LangGraphStore]"}}}function an(e){if(!e)return[];let t=[],r=[],i=0;for(;i<e.length;){let a=e[i];if("["===a){r.length&&(t.push(r.join("")),r=[]);let a=1,n=["["];for(i+=1;i<e.length&&a>0;)"["===e[i]?a+=1:"]"===e[i]&&(a-=1),n.push(e[i]),i+=1;t.push(n.join(""));continue}if("{"===a){r.length&&(t.push(r.join("")),r=[]);let a=1,n=["{"];for(i+=1;i<e.length&&a>0;)"{"===e[i]?a+=1:"}"===e[i]&&(a-=1),n.push(e[i]),i+=1;t.push(n.join(""));continue}"."===a?r.length&&(t.push(r.join("")),r=[]):r.push(a);i+=1}return r.length&&t.push(r.join("")),t}e.s(["AsyncBatchedStore",()=>aa],21197);class as extends ai{constructor(e){super(),Object.defineProperty(this,"data",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"vectors",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"_indexConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e?.index&&(this._indexConfig={...e.index,__tokenizedFields:(e.index.fields??["$"]).map(e=>[e,"$"===e?[e]:an(e)])})}async batch(e){let t=[],r=new Map,i=new Map;for(let a=0;a<e.length;a+=1){let n=e[a];if("key"in n&&"namespace"in n&&!("value"in n))t.push(this.getOperation(n));else if("namespacePrefix"in n){let e=this.filterItems(n);i.set(a,[n,e]),t.push(null)}else if("value"in n){let e=`${n.namespace.join(":")}:${n.key}`;r.set(e,n),t.push(null)}else"matchConditions"in n&&t.push(this.listNamespacesOperation(n))}if(i.size>0)if(this._indexConfig?.embeddings){let e=new Set;for(let[t]of i.values())t.query&&e.add(t.query);let r=e.size>0?await Promise.all(Array.from(e).map(e=>this._indexConfig.embeddings.embedQuery(e))):[],a=Object.fromEntries(Array.from(e).map((e,t)=>[e,r[t]]));for(let[e,[r,n]]of i.entries())if(r.query&&a[r.query]){let i=a[r.query],s=this.scoreResults(n,i,r.offset??0,r.limit??10);t[e]=s}else t[e]=this.paginateResults(n.map(e=>({...e,score:void 0})),r.offset??0,r.limit??10)}else for(let[e,[r,a]]of i.entries())t[e]=this.paginateResults(a.map(e=>({...e,score:void 0})),r.offset??0,r.limit??10);if(r.size>0&&this._indexConfig?.embeddings){let e=this.extractTexts(Array.from(r.values()));if(Object.keys(e).length>0){let t=await this._indexConfig.embeddings.embedDocuments(Object.keys(e));this.insertVectors(e,t)}}for(let e of r.values())this.putOperation(e);return t}getOperation(e){let t=e.namespace.join(":");return this.data.get(t)?.get(e.key)??null}putOperation(e){let t=e.namespace.join(":");this.data.has(t)||this.data.set(t,new Map);let r=this.data.get(t);if(null===e.value)r.delete(e.key);else{let t=new Date;if(r.has(e.key)){let i=r.get(e.key);i.value=e.value,i.updatedAt=t}else r.set(e.key,{value:e.value,key:e.key,namespace:e.namespace,createdAt:t,updatedAt:t})}}listNamespacesOperation(e){let t=Array.from(this.data.keys()).map(e=>e.split(":"));return e.matchConditions&&e.matchConditions.length>0&&(t=t.filter(t=>e.matchConditions.every(e=>this.doesMatch(e,t)))),void 0!==e.maxDepth&&(t=Array.from(new Set(t.map(t=>t.slice(0,e.maxDepth).join(":")))).map(e=>e.split(":"))),t.sort((e,t)=>e.join(":").localeCompare(t.join(":"))),t.slice(e.offset??0,(e.offset??0)+(e.limit??t.length))}doesMatch(e,t){let{matchType:r,path:i}=e;if("prefix"===r)return!(i.length>t.length)&&i.every((e,r)=>{let i=t[r];return"*"===e||i===e});if("suffix"===r)return!(i.length>t.length)&&i.every((e,r)=>{let a=t[t.length-i.length+r];return"*"===e||a===e});throw Error(`Unsupported match type: ${r}`)}filterItems(e){let t=[];for(let[r,i]of this.data.entries())r.startsWith(e.namespacePrefix.join(":"))&&t.push(...i.values());let r=t;return e.filter&&(r=t.filter(t=>Object.entries(e.filter).every(([e,r])=>{var i;return i=t.value[e],"object"==typeof r&&null!==r&&Object.keys(r).every(e=>"$eq"===e||"$ne"===e||"$gt"===e||"$gte"===e||"$lt"===e||"$lte"===e||"$in"===e||"$nin"===e)?Object.keys(r).filter(e=>e.startsWith("$")).every(e=>{let t=r[e];switch(e){case"$eq":return i===t;case"$ne":return i!==t;case"$gt":return Number(i)>Number(t);case"$gte":return Number(i)>=Number(t);case"$lt":return Number(i)<Number(t);case"$lte":return Number(i)<=Number(t);case"$in":return!!Array.isArray(t)&&t.includes(i);case"$nin":return!Array.isArray(t)||!t.includes(i);default:return!1}}):i===r}))),r}scoreResults(e,t,r=0,i=10){let a=[],n=[],s=[];for(let t of e){let e=this.getVectors(t);if(e.length)for(let r of e)a.push(t),n.push(r);else s.push(t)}let o=this.cosineSimilarity(t,n).map((e,t)=>[e,a[t]]).sort((e,t)=>t[0]-e[0]),l=new Set,c=[];for(let[e,t]of o){let a=`${t.namespace.join(":")}:${t.key}`;if(l.has(a))continue;let n=l.size;if(n>=r+i)break;if(n<r){l.add(a);continue}l.add(a),c.push([e,t])}if(s.length&&c.length<i)for(let e of s.slice(0,i-c.length)){let t=`${e.namespace.join(":")}:${e.key}`;l.has(t)||(l.add(t),c.push([void 0,e]))}return c.map(([e,t])=>({...t,score:e}))}paginateResults(e,t,r){return e.slice(t,t+r)}extractTexts(e){if(!e.length||!this._indexConfig)return{};let t={};for(let a of e)if(null!==a.value&&!1!==a.index)for(let[e,n]of null===a.index||void 0===a.index?this._indexConfig.__tokenizedFields??[]:a.index.map(e=>[e,an(e)])){var r,i;let s=(r=a.value,(i=n)&&"$"!==i?function e(t,r,i){if(i>=r.length)return"string"==typeof t||"number"==typeof t||"boolean"==typeof t?[String(t)]:null==t?[]:Array.isArray(t)||"object"==typeof t?[JSON.stringify(t,null,2)]:[];let a=r[i],n=[];if(0===i&&"$"===a&&n.push(JSON.stringify(t,null,2)),a.startsWith("[")&&a.endsWith("]")){if(!Array.isArray(t))return[];let s=a.slice(1,-1);if("*"===s)for(let a of t)n.push(...e(a,r,i+1));else try{let a=parseInt(s,10);a<0&&(a=t.length+a),a>=0&&a<t.length&&n.push(...e(t[a],r,i+1))}catch{return[]}}else if(a.startsWith("{")&&a.endsWith("}")){if("object"!=typeof t||null===t)return[];for(let e of a.slice(1,-1).split(",").map(e=>e.trim())){let r=an(e);if(r.length){let e=t;for(let t of r)if(e&&"object"==typeof e&&t in e)e=e[t];else{e=void 0;break}void 0!==e&&("string"==typeof e||"number"==typeof e||"boolean"==typeof e?n.push(String(e)):(Array.isArray(e)||"object"==typeof e)&&n.push(JSON.stringify(e,null,2)))}}}else if("*"===a){if(Array.isArray(t))for(let a of t)n.push(...e(a,r,i+1));else if("object"==typeof t&&null!==t)for(let a of Object.values(t))n.push(...e(a,r,i+1))}else"object"==typeof t&&null!==t&&a in t&&n.push(...e(t[a],r,i+1));return n}(r,Array.isArray(i)?i:an(i),0):[JSON.stringify(r,null,2)]);s.length&&(s.length>1?s.forEach((r,i)=>{t[r]||(t[r]=[]),t[r].push([a.namespace,a.key,`${e}.${i}`])}):(t[s[0]]||(t[s[0]]=[]),t[s[0]].push([a.namespace,a.key,e])))}return t}insertVectors(e,t){for(let[r,i]of Object.entries(e)){let e=t.shift();if(!e)throw Error(`No embedding found for text: ${r}`);for(let[t,r,a]of i){let i=t.join(":");this.vectors.has(i)||this.vectors.set(i,new Map);let n=this.vectors.get(i);n.has(r)||n.set(r,new Map),n.get(r).set(a,e)}}}getVectors(e){let t=e.namespace.join(":"),r=e.key;if(!this.vectors.has(t))return[];let i=this.vectors.get(t);if(!i.has(r))return[];let a=Array.from(i.get(r).values());return a.length?a:[]}cosineSimilarity(e,t){if(!t.length)return[];let r=t.map(t=>t.reduce((t,r,i)=>t+r*e[i],0)),i=Math.sqrt(e.reduce((e,t)=>e+t*t,0)),a=t.map(e=>Math.sqrt(e.reduce((e,t)=>e+t*t,0)));return r.map((e,t)=>{let r=a[t];return i&&r?e/(i*r):0})}get indexConfig(){return this._indexConfig}}class ao extends as{}e.s(["InMemoryStore",()=>as,"MemoryStore",()=>ao],44253),e.s([],14005);class al{constructor(e){Object.defineProperty(this,"serde",{enumerable:!0,configurable:!0,writable:!0,value:new i1}),this.serde=e||this.serde}}e.s(["BaseCache",()=>al],79896);class ac extends al{constructor(){super(...arguments),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:{}})}async get(e){if(!e.length)return[];let t=Date.now();return(await Promise.all(e.map(async e=>{let[r,i]=e,a=r.join(",");if(a in this.cache&&i in this.cache[a]){let r=this.cache[a][i];if(null==r.exp||t<r.exp)return[{key:e,value:await this.serde.loadsTyped(r.enc,r.val)}];delete this.cache[a][i]}return[]}))).flat()}async set(e){let t=Date.now();for(let{key:r,value:i,ttl:a}of e){let[e,n]=r,s=e.join(","),[o,l]=await this.serde.dumpsTyped(i),c=null!=a?1e3*a+t:null;this.cache[s]??={},this.cache[s][n]={enc:o,val:l,exp:c}}}async clear(e){if(!e.length){this.cache={};return}for(let t of e){let e=t.join(",");e in this.cache&&delete this.cache[e]}}}function au(e){return null!=e&&!0===e.lg_is_channel}e.s(["InMemoryCache",()=>ac],34939),e.s([],85227),e.s([],58443);class ah{constructor(){Object.defineProperty(this,"ValueType",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"UpdateType",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lg_is_channel",{enumerable:!0,configurable:!0,writable:!0,value:!0})}consume(){return!1}}function ap(e,t){let r=Object.fromEntries(Object.entries(e).filter(([,e])=>au(e))),i={};for(let e in r)if(Object.prototype.hasOwnProperty.call(r,e)){let a=t.channel_values[e];i[e]=r[e].fromCheckpoint(a)}return i}function ad(e,t,r){let i;if(void 0===t)i=e.channel_values;else for(let e of(i={},Object.keys(t)))try{i[e]=t[e].checkpoint()}catch(e){if(e.name===F.unminifiable_name);else throw e}return{v:1,id:Y(r),ts:new Date().toISOString(),channel_values:i,channel_versions:{...e.channel_versions},versions_seen:i2(e.versions_seen),pending_sends:e.pending_sends??[]}}class af extends ah{constructor(e,t){super(),Object.defineProperty(this,"lc_graph_name",{enumerable:!0,configurable:!0,writable:!0,value:"BinaryOperatorAggregate"}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"operator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"initialValueFactory",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.operator=e,this.initialValueFactory=t,this.value=t?.()}fromCheckpoint(e){let t=new af(this.operator,this.initialValueFactory);return void 0!==e&&(t.value=e),t}update(e){let t=e;if(!t.length)return!1;for(let e of(void 0===this.value&&([this.value]=t,t=t.slice(1)),t))void 0!==this.value&&(this.value=this.operator(this.value,e));return!0}get(){if(void 0===this.value)throw new F;return this.value}checkpoint(){if(void 0===this.value)throw new F;return this.value}}class am extends ah{constructor(){super(...arguments),Object.defineProperty(this,"lc_graph_name",{enumerable:!0,configurable:!0,writable:!0,value:"LastValue"}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:[]})}fromCheckpoint(e){let t=new am;return void 0!==e&&(t.value=[e]),t}update(e){if(0===e.length)return!1;if(1!==e.length)throw new B("LastValue can only receive one value per step.",{lc_error_code:"INVALID_CONCURRENT_GRAPH_UPDATE"});return this.value=[e[e.length-1]],!0}get(){if(0===this.value.length)throw new F;return this.value[0]}checkpoint(){if(0===this.value.length)throw new F;return this.value[0]}}let ag="__start__",ab="__end__",ay="__input__",av="__error__",a_="__pregel_send",aw="__pregel_call",ak="__pregel_read",aO="__pregel_checkpointer",aP="__pregel_resuming",aA="__pregel_task_id",aT="__pregel_stream",aS="__pregel_scratchpad",aE="__pregel_previous",aj="checkpoint_ns",aC="checkpoint_map",ax="__pregel_abort_signals",aN="__interrupt__",aI="__resume__",aM="__no_writes__",aR="__return__",aL="__previous__",a$="__pregel_runtime_placeholder__",aD="langsmith:hidden",aF="__self__",aB="__pregel_tasks",az="__pregel_push",aU="__pregel_pull",aV="00000000-0000-0000-0000-000000000000",aK=[aD,ay,aN,aI,av,aM,aB,a_,ak,aO,aT,aP,aA,aw,"__pregel_resume_value",aS,aE,aC,aj,"checkpoint_id"];function aZ(e){return null!=e&&"string"==typeof e.node&&void 0!==e.args}class aW{constructor(e,t){Object.defineProperty(this,"lg_name",{enumerable:!0,configurable:!0,writable:!0,value:"Send"}),Object.defineProperty(this,"node",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"args",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.node=e,this.args=aH(t)}toJSON(){return{lg_name:this.lg_name,node:this.node,args:this.args}}}function aG(e){return e instanceof aW}class aq{constructor(e){Object.defineProperty(this,"lg_name",{enumerable:!0,configurable:!0,writable:!0,value:"Command"}),Object.defineProperty(this,"lc_direct_tool_output",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"graph",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"update",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"resume",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"goto",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.resume=e.resume,this.graph=e.graph,this.update=e.update,e.goto&&(this.goto=Array.isArray(e.goto)?aH(e.goto):[aH(e.goto)])}_updateAsTuples(){return this.update&&"object"==typeof this.update&&!Array.isArray(this.update)?Object.entries(this.update):Array.isArray(this.update)&&this.update.every(e=>Array.isArray(e)&&2===e.length&&"string"==typeof e[0])?this.update:[["__root__",this.update]]}toJSON(){let e;return e="string"==typeof this.goto?this.goto:aG(this.goto)?this.goto.toJSON():this.goto?.map(e=>"string"==typeof e?e:e.toJSON()),{lg_name:this.lg_name,update:this.update,resume:this.resume,goto:e}}}function aJ(e){return"object"==typeof e&&null!=e&&"lg_name"in e&&"Command"===e.lg_name}function aH(e,t=new Map){if(null!=e&&"object"==typeof e){let r;if(t.has(e))return t.get(e);if(Array.isArray(e))r=[],t.set(e,r),e.forEach((e,i)=>{r[i]=aH(e,t)});else if(!aJ(e)||e instanceof aq)if(!aZ(e)||e instanceof aW)if(aJ(e)||aG(e))r=e,t.set(e,r);else if("lc_serializable"in e&&e.lc_serializable)r=e,t.set(e,r);else for(let[i,a]of(r={},t.set(e,r),Object.entries(e)))r[i]=aH(a,t);else r=new aW(e.node,e.args),t.set(e,r);else r=new aq(e),t.set(e,r);return r}return e}Object.defineProperty(aq,"PARENT",{enumerable:!0,configurable:!0,writable:!0,value:"__parent__"});class aY{constructor(e,t){Object.defineProperty(this,"runtime",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_promises",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"lg_is_managed_value",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.config=e}static async initialize(e,t){throw Error("Not implemented")}async promises(){return Promise.all(this._promises)}addPromise(e){this._promises.push(e)}}class aX extends aY{}let aQ="__channel_key_placeholder__";class a0 extends Map{constructor(e){super(e?Array.from(e):void 0)}replaceRuntimeValues(e,t){if(0!==this.size&&t&&!Array.from(this.values()).every(e=>!e.runtime))if("object"!=typeof t||Array.isArray(t)){if("object"==typeof t&&"constructor"in t)for(let r of Object.getOwnPropertyNames(Object.getPrototypeOf(t)))try{let i=t[r];for(let[a,n]of this.entries())n.runtime&&n.call(e)===i&&(t[r]={[a$]:a})}catch(e){if(e.name!==TypeError.name)throw e}}else for(let[r,i]of Object.entries(t))for(let[a,n]of this.entries())n.runtime&&n.call(e)===i&&(t[r]={[a$]:a})}replaceRuntimePlaceholders(e,t){if(0!==this.size&&t&&!Array.from(this.values()).every(e=>!e.runtime)){if("object"!=typeof t||Array.isArray(t)){if("object"==typeof t&&"constructor"in t)for(let r of Object.getOwnPropertyNames(Object.getPrototypeOf(t)))try{let i=t[r];if("object"==typeof i&&null!==i&&a$ in i){let a=this.get(i[a$]);a&&(t[r]=a.call(e))}}catch(e){if(e.name!==TypeError.name)throw e}}else for(let[r,i]of Object.entries(t))if("object"==typeof i&&null!==i&&a$ in i){let a=i[a$];"string"==typeof a&&(t[r]=this.get(a)?.call(e))}}}}function a1(e){return"object"==typeof e&&!!e&&"lg_is_managed_value"in e}function a2(e){return"object"==typeof e&&!!e&&"cls"in e&&"params"in e}class a5 extends aY{call(){}static async initialize(e,t){return Promise.resolve(new a5(e))}}e.s(["ChannelKeyPlaceholder",0,aQ,"ManagedValue",()=>aY,"ManagedValueMapping",()=>a0,"NoopManagedValue",()=>a5,"WritableManagedValue",()=>aX,"isConfiguredManagedValue",()=>a2,"isManagedValue",()=>a1],86359);class a4{constructor(e){Object.defineProperty(this,"lc_graph_name",{enumerable:!0,configurable:!0,writable:!0,value:"AnnotationRoot"}),Object.defineProperty(this,"spec",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.spec=e}}let a3=function(e){return a2(e)?e:e?a8(e):new am};function a8(e){return"object"==typeof e&&e&&"reducer"in e&&e.reducer?new af(e.reducer,e.default):"object"==typeof e&&e&&"value"in e&&e.value?new af(e.value,e.default):new am}a3.Root=e=>new a4(e);var iP=eR,a6=e.i(98034),a9=e.i(95545),iP=eR,iA=ts,T=T,T=T;let a7=["tags","metadata","callbacks","configurable"],ne=["tags","metadata","callbacks","runName","maxConcurrency","recursionLimit","configurable","runId","outputKeys","streamMode","store","writer","interruptBefore","interruptAfter","signal"];function nt(...e){let t={tags:[],metadata:{},callbacks:void 0,recursionLimit:25,configurable:{}},r=T.AsyncLocalStorageProviderSingleton.getRunnableConfig();if(void 0!==r){for(let[e,i]of Object.entries(r))if(void 0!==i)if(a7.includes(e)){let r;r=Array.isArray(i)?[...i]:"object"==typeof i?"callbacks"===e&&"copy"in i&&"function"==typeof i.copy?i.copy():{...i}:i,t[e]=r}else t[e]=i}for(let r of e)if(void 0!==r)for(let[e,i]of Object.entries(r))void 0!==i&&ne.includes(e)&&(t[e]=i);for(let[e,r]of Object.entries(t.configurable))t.metadata=t.metadata??{},e.startsWith("__")||"string"!=typeof r&&"number"!=typeof r&&"boolean"!=typeof r||e in t.metadata||(t.metadata[e]=r);return t}function nr(e){return e.split("|").filter(e=>!e.match(/^\d+$/)).map(e=>e.split(":")[0]).join("|")}class ni extends iP.Runnable{constructor(e){super(),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langgraph"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"trace",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"recurse",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.name=e.name??e.func.name,this.func=e.func,this.config=e.tags?{tags:e.tags}:void 0,this.trace=e.trace??this.trace,this.recurse=e.recurse??this.recurse}async _tracedInvoke(e,t,r){return new Promise((i,a)=>{let n=(0,iA.patchConfig)(t,{callbacks:r?.getChild()});T.AsyncLocalStorageProviderSingleton.runWithConfig(n,async()=>{try{let t=await this.func(e,n);i(t)}catch(e){a(e)}})})}async invoke(e,t){let r,i=nt(t),a=(0,iA.mergeConfigs)(this.config,i);return(r=this.trace?await this._callWithConfig(this._tracedInvoke,e,a):await T.AsyncLocalStorageProviderSingleton.runWithConfig(a,async()=>this.func(e,a)),iP.Runnable.isRunnable(r)&&this.recurse)?await T.AsyncLocalStorageProviderSingleton.runWithConfig(a,async()=>r.invoke(e,a)):r}}function*na(e,t){if(void 0===t)yield*e;else for(let r of e)yield[t,r]}async function nn(e){let t=[];for await(let r of(await e))t.push(r);return t}function ns(e){let t=[];for(let r of e)t.push(r);return t}function no(e,t){return e?"configurable"in e?{...e,configurable:{...e.configurable,...t}}:{...e,configurable:t}:{configurable:t}}Symbol.for("LG_SKIP_WRITE");let nl={[Symbol.for("LG_PASSTHROUGH")]:!0};function nc(e){return"object"==typeof e&&e?.[Symbol.for("LG_PASSTHROUGH")]!==void 0}let nu=Symbol("IS_WRITER");class nh extends ni{constructor(e,t){const r=`ChannelWrite<${e.map(e=>aG(e)?e.node:"channel"in e?e.channel:"...").join(",")}>`;super({writes:e,name:r,tags:t,func:async(e,t)=>this._write(e,t??{})}),Object.defineProperty(this,"writes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.writes=e}async _write(e,t){let r=this.writes.map(t=>nd(t)&&nc(t.value)?{mapper:t.mapper,value:e}:np(t)&&nc(t.value)?{channel:t.channel,value:e,skipNone:t.skipNone,mapper:t.mapper}:t);return await nh.doWrite(t,r),e}static async doWrite(e,t){for(let e of t){if(np(e)){if(e.channel===aB)throw new B("Cannot write to the reserved channel TASKS");if(nc(e.value))throw new B("PASSTHROUGH value must be replaced")}if(nd(e)&&nc(e.value))throw new B("PASSTHROUGH value must be replaced")}let r=[];for(let i of t)if(aG(i))r.push([aB,i]);else if(nd(i)){let t=await i.mapper.invoke(i.value,e);null!=t&&t.length>0&&r.push(...t)}else if(np(i)){let t=void 0!==i.mapper?await i.mapper.invoke(i.value,e):i.value;if("object"==typeof t&&t?.[Symbol.for("LG_SKIP_WRITE")]!==void 0||i.skipNone&&void 0===t)continue;r.push([i.channel,t])}else throw Error(`Invalid write entry: ${JSON.stringify(i)}`);(e.configurable?.[a_])(r)}static isWriter(e){return e instanceof nh||nu in e&&!!e[nu]}static registerWriter(e){return Object.defineProperty(e,nu,{value:!0})}}function np(e){return void 0!==e&&"string"==typeof e.channel}function nd(e){return void 0!==e&&!np(e)&&iP.Runnable.isRunnable(e.mapper)}class nf extends ni{constructor(e,t,r=!1){super({func:(e,t)=>nf.doRead(t,this.channel,this.fresh,this.mapper)}),Object.defineProperty(this,"lc_graph_name",{enumerable:!0,configurable:!0,writable:!0,value:"ChannelRead"}),Object.defineProperty(this,"channel",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fresh",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.fresh=r,this.mapper=t,this.channel=e,this.name=Array.isArray(e)?`ChannelRead<${e.join(",")}>`:`ChannelRead<${e}>`}static doRead(e,t,r,i){let a=e.configurable?.[ak];if(!a)throw Error("Runnable is not configured with a read function. Make sure to call in the context of a Pregel process");return i?i(a(t,r)):a(t,r)}}let nm=new to;class ng extends iP.RunnableBinding{constructor(e){const{channels:t,triggers:r,mapper:i,writers:a,bound:n,kwargs:s,metadata:o,retryPolicy:l,tags:c,subgraphs:u,ends:h}=e,p=[...e.config?.tags?e.config.tags:[],...c??[]];super({...e,bound:e.bound??nm,config:{...e.config?e.config:{},tags:p}}),Object.defineProperty(this,"lc_graph_name",{enumerable:!0,configurable:!0,writable:!0,value:"PregelNode"}),Object.defineProperty(this,"channels",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"triggers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:nm}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"retryPolicy",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"subgraphs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ends",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.channels=t,this.triggers=r,this.mapper=i,this.writers=a??this.writers,this.bound=n??this.bound,this.kwargs=s??this.kwargs,this.metadata=o??this.metadata,this.tags=p,this.retryPolicy=l,this.subgraphs=u,this.ends=h}getWriters(){let e=[...this.writers];for(;e.length>1&&e[e.length-1]instanceof nh&&e[e.length-2]instanceof nh;){let t=e.slice(-2),r=t[0].writes.concat(t[1].writes);e[e.length-2]=new nh(r,t[0].config?.tags),e.pop()}return e}getNode(){let e=this.getWriters();if(this.bound!==nm||0!==e.length)return this.bound===nm&&1===e.length?e[0]:this.bound===nm?new iP.RunnableSequence({first:e[0],middle:e.slice(1,e.length-1),last:e[e.length-1],omitSequenceTags:!0}):e.length>0?new iP.RunnableSequence({first:this.bound,middle:e.slice(0,e.length-1),last:e[e.length-1],omitSequenceTags:!0}):this.bound}join(e){if(!Array.isArray(e))throw Error("channels must be a list");if("object"!=typeof this.channels)throw Error("all channels must be named when using .join()");return new ng({channels:{...this.channels,...Object.fromEntries(e.map(e=>[e,e]))},triggers:this.triggers,mapper:this.mapper,writers:this.writers,bound:this.bound,kwargs:this.kwargs,config:this.config,retryPolicy:this.retryPolicy})}pipe(e){return new ng(nh.isWriter(e)?{channels:this.channels,triggers:this.triggers,mapper:this.mapper,writers:[...this.writers,e],bound:this.bound,config:this.config,kwargs:this.kwargs,retryPolicy:this.retryPolicy}:this.bound===nm?{channels:this.channels,triggers:this.triggers,mapper:this.mapper,writers:this.writers,bound:(0,iP._coerceToRunnable)(e),config:this.config,kwargs:this.kwargs,retryPolicy:this.retryPolicy}:{channels:this.channels,triggers:this.triggers,mapper:this.mapper,writers:this.writers,bound:this.bound.pipe(e),config:this.config,kwargs:this.kwargs,retryPolicy:this.retryPolicy})}}var iP=eR;class nb extends Error{constructor(e){super(e),this.name="GraphValidationError"}}function ny(e,t){if(Array.isArray(e)){for(let r of e)if(!(r in t))throw Error(`Key ${String(r)} not found in channels`)}else if(!(e in t))throw Error(`Key ${String(e)} not found in channels`)}function nv(e,t,r=!0,i=!1){try{return e[t].get()}catch(e){if(e.name===F.unminifiable_name){if(i)return e;else if(r)return null}throw e}}function n_(e,t,r=!0){if(!Array.isArray(t))return nv(e,t);{let i={};for(let a of t)try{i[a]=nv(e,a,!r)}catch(e){if(e.name===F.unminifiable_name)continue}return i}}function*nw(e,t){if(null!=t)if(Array.isArray(e)&&"object"==typeof t&&!Array.isArray(t))for(let r in t)e.includes(r)&&(yield[r,t[r]]);else if(Array.isArray(e))throw Error('Input chunk must be an object when "inputChannels" is an array');else yield[e,t]}function*nk(e,t,r){Array.isArray(e)?(!0===t||t.find(([t,r])=>e.includes(t)))&&(yield n_(r,e)):(!0===t||t.some(([t,r])=>t===e))&&(yield nv(r,e))}function*nO(e,t,r){let i,a=t.filter(([e,t])=>(void 0===e.config||!e.config.tags?.includes(aD))&&t[0][0]!==av&&t[0][0]!==aN);if(!a.length)return;i=a.some(([e])=>e.writes.some(([e,t])=>e===aR))?a.flatMap(([e])=>e.writes.filter(([e,t])=>e===aR).map(([t,r])=>[e.name,r])):Array.isArray(e)?a.flatMap(([t])=>{let{writes:r}=t,i={};for(let[t]of r)e.includes(t)&&(i[t]=(i[t]||0)+1);return Object.values(i).some(e=>e>1)?r.filter(([t])=>e.includes(t)).map(([e,r])=>[t.name,{[e]:r}]):[[t.name,Object.fromEntries(r.filter(([t])=>e.includes(t)))]]}):a.flatMap(([t])=>t.writes.filter(([t,r])=>t===e).map(([e,r])=>[t.name,r]));let n={};for(let[e,t]of i)e in n||(n[e]=[]),n[e].push(t);let s={};for(let e in n)if(1===n[e].length){let[t]=n[e];s[e]=t}else s[e]=n[e];r&&(s.__metadata__={cached:r}),yield s}function nP(e){return"lg_is_pregel"in e&&!0===e.lg_is_pregel}function nA(e){let t=[e];for(let e of t)if(nP(e))return e;else"steps"in e&&Array.isArray(e.steps)&&t.push(...e.steps)}let nT={start:"\x1b[34m",end:"\x1b[0m"},nS={start:"\x1b[32m",end:"\x1b[0m"},nE={start:"\x1b[33;1m",end:"\x1b[0m"},nj=(e,t)=>`${e.start}${t}${e.end}`;function*nC(e,t){let r=new Date().toISOString();for(let{id:i,name:a,input:n,config:s,triggers:o,writes:l}of t){if(s?.tags?.includes(aD))continue;let t=l.filter(([e,t])=>e===i&&t===aN).map(([,e])=>e);yield{type:"task",timestamp:r,step:e,payload:{id:i,name:a,input:n,triggers:o,interrupts:t}}}}function nx(e,t,r){return e.map(e=>{let i=t.find(([t,r])=>t===e.id&&r===av)?.[2],a=t.filter(([t,r])=>t===e.id&&r===aN).map(([,,e])=>e);if(i)return{id:e.id,name:e.name,path:e.path,error:i,interrupts:a};let n=r?.[e.id];return{id:e.id,name:e.name,path:e.path,interrupts:a,...void 0!==n?{state:n}:{}}})}function nN(e,t){let r=t.length;console.log([`${nj(nT,`[${e}:tasks]`)}`,`\x1b[1m Starting step ${e} with ${r} task${1===r?"":"s"}:\x1b[0m
`,t.map(e=>`- ${nj(nS,String(e.name))} -> ${JSON.stringify(e.input,null,2)}`).join("\n")].join(""))}var iA=ts;class nI{constructor({func:e,name:t,input:r,retry:i,callbacks:a}){Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"input",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"retry",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"__lg_type",{enumerable:!0,configurable:!0,writable:!0,value:"call"}),this.func=e,this.name=t,this.input=r,this.retry=i,this.callbacks=a}}function nM(e){let t,r=Object.values(e),i=r.length>0?typeof r[0]:void 0;return"number"===i?t=0:"string"===i&&(t=""),t}function nR(e,t){if(!(Object.keys(e).length>0))return t;{let r=nM(t);return Object.fromEntries(Object.entries(t).filter(([t,i])=>i>(e[t]??r)))}}function nL(e,t){return null===e?{configurable:t}:e?.configurable===void 0?{...e,configurable:t}:{...e,configurable:{...e.configurable,...t}}}function n$(e,t){let r=t?.parents??{};return Object.keys(r).length>0?nL(e,{[aC]:{...r,[e.configurable?.checkpoint_ns??""]:e.configurable?.checkpoint_id}}):e}function nD(...e){if(1===e.length)return e[0];let t=new AbortController,r=()=>{t.abort(),e.forEach(e=>e.removeEventListener("abort",r))};return e.forEach(e=>e.addEventListener("abort",r)),e.some(e=>e.aborted)&&t.abort(),t.signal}var iP=eR,T=T;let nF=e=>void 0!==e?e+1:1;function nB(e,t,r){let i,a=Object.values(e.channel_versions),n=a.length>0?typeof a[0]:void 0;"number"===n?i=0:"string"===n&&(i="");let s=e.versions_seen[aN]??{},o=Object.entries(e.channel_versions).some(([e,t])=>t>(s[e]??i)),l=r.some(e=>"*"===t?!e.config?.tags?.includes(aD):t.includes(e.name));return o&&l}function nz(e,t,r,i,a,n,s=!1){let o,l=[],c=new Set;if(Array.isArray(n))l=n.filter(e=>i.get(e)),c=new Set((n=n.filter(e=>!i.get(e))).filter(e=>a.writes.some(([t,r])=>t===e)));else{for(let[e]of a.writes)if(e===n){c=new Set([e]);break}c=c||new Set}if(s&&c.size>0){let e=Object.fromEntries(Object.entries(r).filter(([e,t])=>c.has(e))),i=ad(t,e,-1),s=ap(e,i);nK(i4(i),s,[a]),o=n_({...r,...s},n)}else o=n_(r,n);if(l.length>0)for(let t of l){let r=i.get(t);if(r){let i=r.call(e);o[t]=i}}return o}function nU(e,t,r,i,a){for(let[t,n]of a)if([az,aB].includes(t)&&null!=n){if(!aG(n))throw new B(`Invalid packet type, expected SendProtocol, got ${JSON.stringify(n)}`);if(!(n.node in r))throw new B(`Invalid node name "${n.node}" in Send packet`);i.replaceRuntimeValues(e,n.args)}t(a)}let nV=new Set([aM,az,aI,aN,aR,av]);function nK(e,t,r,i){let a;r.sort((e,t)=>{let r=e.path?.slice(0,3)||[],i=t.path?.slice(0,3)||[];for(let e=0;e<Math.min(r.length,i.length);e+=1){if(r[e]<i[e])return -1;if(r[e]>i[e])return 1}return r.length-i.length});let n=r.some(e=>e.triggers.length>0),s=Object.fromEntries(Object.entries(t).filter(([e,t])=>au(t)));for(let t of r)for(let r of(void 0===e.versions_seen[t.name]&&(e.versions_seen[t.name]={}),t.triggers))r in e.channel_versions&&(e.versions_seen[t.name][r]=e.channel_versions[r]);for(let t of(Object.keys(e.channel_versions).length>0&&(a=i6(...Object.values(e.channel_versions))),new Set(r.flatMap(e=>e.triggers).filter(e=>!aK.includes(e)))))t in s&&s[t].consume()&&void 0!==i&&(e.channel_versions[t]=i(a,s[t]));e.pending_sends?.length&&n&&(e.pending_sends=[]);let o={},l={};for(let t of r)for(let[r,i]of t.writes)nV.has(r)||(r===aB?e.pending_sends.push({node:i.node,args:i.args}):r in s?r in o?o[r].push(i):o[r]=[i]:r in l?l[r].push(i):l[r]=[i]);a=void 0,Object.keys(e.channel_versions).length>0&&(a=i6(...Object.values(e.channel_versions)));let c=new Set;for(let[t,r]of Object.entries(o))if(t in s){let n;try{n=s[t].update(r)}catch(e){if(e.name===B.unminifiable_name){let i=new B(`Invalid update for channel "${t}" with values ${JSON.stringify(r)}: ${e.message}`);throw i.lc_error_code=e.lc_error_code,i}throw e}n&&void 0!==i&&(e.channel_versions[t]=i(a,s[t])),c.add(t)}if(n)for(let t of Object.keys(s))!c.has(t)&&s[t].update([])&&void 0!==i&&(e.channel_versions[t]=i(a,s[t]));return l}function nZ(e,t,r,i,a,n,s,o){let l={};for(let c=0;c<e.pending_sends.length;c+=1){let u=nW([az,c],e,t,r,i,a,n,s,o);void 0!==u&&(l[u.id]=u)}for(let c of Object.keys(r)){let u=nW([aU,c],e,t,r,i,a,n,s,o);void 0!==u&&(l[u.id]=u)}return l}function nW(e,t,r,i,a,n,s,o,l){var c,u,h;let{step:p,checkpointer:d,manager:f}=l,m=s.configurable??{},g=m.checkpoint_ns??"";if(e[0]===az&&"object"==typeof(c=e[e.length-1])&&null!==c&&"__lg_type"in c&&"call"===c.__lg_type){let c,b=e[e.length-1],y=(u=b.name,h=b.func,c=new ni({func:e=>h(...e),name:u,trace:!1,recurse:!1}),new iP.RunnableSequence({name:u,first:c,last:new nh([{channel:aR,value:nl}],[aD])})),v=[az],_=""===g?b.name:`${g}|${b.name}`,w=X(JSON.stringify([_,p.toString(),b.name,az,e[1],e[2]]),t.id),k=`${_}:${w}`,O={langgraph_step:p,langgraph_node:b.name,langgraph_triggers:v,langgraph_path:e.slice(0,3),langgraph_checkpoint_ns:k};if(!o)return{id:w,name:b.name,interrupts:[],path:e.slice(0,3)};{let o=[];return{name:b.name,input:b.input,proc:y,writes:o,config:(0,iA.patchConfig)((0,iA.mergeConfigs)(s,{metadata:O,store:l.store??s.store}),{runName:b.name,callbacks:f?.getChild(`graph:step:${p}`),configurable:{[aA]:w,[a_]:e=>nU(p,e=>o.push(...e),i,n,e),[ak]:(r,i=!1)=>nz(p,t,a,n,{name:b.name,writes:o,triggers:v,path:e.slice(0,3)},r,i),[aO]:d??m[aO],[aC]:{...m[aC],[g]:t.id},[aS]:nG({pendingWrites:r??[],taskId:w,currentTaskInput:b.input}),[aE]:t.channel_values[aL],checkpoint_id:void 0,checkpoint_ns:k}}),triggers:v,retry_policy:b.retry,id:w,path:e.slice(0,3),writers:[]}}}if(e[0]===az){let c="number"==typeof e[1]?e[1]:parseInt(e[1],10);if(c>=t.pending_sends.length)return;let u=aZ(t.pending_sends[c])&&!aG(t.pending_sends[c])?new aW(t.pending_sends[c].node,t.pending_sends[c].args):t.pending_sends[c];if(!aZ(u))return void console.warn(`Ignoring invalid packet ${JSON.stringify(u)} in pending sends.`);if(!(u.node in i))return void console.warn(`Ignoring unknown node name ${u.node} in pending sends.`);let h=[az],b=""===g?u.node:`${g}|${u.node}`,y=X(JSON.stringify([b,p.toString(),u.node,az,c.toString()]),t.id),v=`${b}:${y}`,_={langgraph_step:p,langgraph_node:u.node,langgraph_triggers:h,langgraph_path:e.slice(0,3),langgraph_checkpoint_ns:v};if(!o)return{id:y,name:u.node,interrupts:[],path:e};{let o=i[u.node],c=o.getNode();if(void 0!==c){n.replaceRuntimePlaceholders(p,u.args),void 0!==o.metadata&&(_={..._,...o.metadata});let b=[];return{name:u.node,input:u.args,proc:c,subgraphs:o.subgraphs,writes:b,config:(0,iA.patchConfig)((0,iA.mergeConfigs)(s,{metadata:_,tags:o.tags,store:l.store??s.store}),{runName:u.node,callbacks:f?.getChild(`graph:step:${p}`),configurable:{[aA]:y,[a_]:e=>nU(p,e=>b.push(...e),i,n,e),[ak]:(r,i=!1)=>nz(p,t,a,n,{name:u.node,writes:b,triggers:h,path:e},r,i),[aO]:d??m[aO],[aC]:{...m[aC],[g]:t.id},[aS]:nG({pendingWrites:r??[],taskId:y,currentTaskInput:u.args}),[aE]:t.channel_values[aL],checkpoint_id:void 0,checkpoint_ns:v}}),triggers:h,retry_policy:o.retryPolicy,id:y,path:e,writers:o.getWriters()}}}}else if(e[0]===aU){let c=e[1].toString(),u=i[c];if(void 0===u)return;if(r?.length){let e=X(JSON.stringify([""===g?c:`${g}|${c}`,p.toString(),c,aU,c]),t.id);if(r.some(t=>t[0]===e&&t[1]!==av))return}let h=nM(t.channel_versions);if(void 0===h)return;let b=t.versions_seen[c]??{},y=u.triggers.filter(e=>{let r=nv(a,e,!1,!0);return!(r instanceof Error&&r.name===F.unminifiable_name)&&(t.channel_versions[e]??h)>(b[e]??h)}).sort();if(y.length>0){let h=function(e,t,r,i,a){let n;if("object"!=typeof t.channels||Array.isArray(t.channels))if(Array.isArray(t.channels)){let e=!1;for(let r of t.channels)try{n=nv(i,r,!1),e=!0;break}catch(e){if(e.name===F.unminifiable_name)continue;throw e}if(!e)return}else throw Error(`Invalid channels type, expected list or dict, got ${t.channels}`);else for(let[a,s]of(n={},Object.entries(t.channels)))if(t.triggers.includes(s))try{n[a]=nv(i,s,!1)}catch(e){if(e.name===F.unminifiable_name)return;throw e}else if(s in i)try{n[a]=nv(i,s,!1)}catch(e){if(e.name===F.unminifiable_name)continue;throw e}else n[a]=r.get(a)?.call(e);return a&&void 0!==t.mapper&&(n=t.mapper(n)),n}(p,u,n,a,o);if(void 0===h)return;let b=""===g?c:`${g}|${c}`,v=X(JSON.stringify([b,p.toString(),c,aU,y]),t.id),_=`${b}:${v}`,w={langgraph_step:p,langgraph_node:c,langgraph_triggers:y,langgraph_path:e,langgraph_checkpoint_ns:_};if(!o)return{id:v,name:c,interrupts:[],path:e};{let o=u.getNode();if(void 0!==o){void 0!==u.metadata&&(w={...w,...u.metadata});let b=[];return{name:c,input:h,proc:o,subgraphs:u.subgraphs,writes:b,config:(0,iA.patchConfig)((0,iA.mergeConfigs)(s,{metadata:w,tags:u.tags,store:l.store??s.store}),{runName:c,callbacks:f?.getChild(`graph:step:${p}`),configurable:{[aA]:v,[a_]:e=>nU(p,e=>{b.push(...e)},i,n,e),[ak]:(r,i=!1)=>nz(p,t,a,n,{name:c,writes:b,triggers:y,path:e},r,i),[aO]:d??m[aO],[aC]:{...m[aC],[g]:t.id},[aS]:nG({pendingWrites:r??[],taskId:v,currentTaskInput:h}),[aE]:t.channel_values[aL],checkpoint_id:void 0,checkpoint_ns:_}}),triggers:y,retry_policy:u.retryPolicy,id:v,path:e,writers:u.getWriters()}}}}}}function nG({pendingWrites:e,taskId:t,currentTaskInput:r}){let i=e.find(([e,t])=>e===aV&&t===aI)?.[2],a={callCounter:0,interruptCounter:-1,resume:e.filter(([e,r])=>e===t&&r===aI).flatMap(([e,t,r])=>r),nullResume:i,subgraphCounter:0,currentTaskInput:r,consumeNullResume:()=>{if(a.nullResume)return delete a.nullResume,e.splice(e.findIndex(([e,t])=>e===aV&&t===aI),1),i}};return a}var nq=ta;class nJ extends nq.IterableReadableStream{constructor(e,t){const r=e.getReader(),i=t??new AbortController;super({start:e=>(function t(){return r.read().then(({done:r,value:i})=>r?void e.close():(e.enqueue(i),t()))})()}),Object.defineProperty(this,"_abortController",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this._abortController=i,this._reader=r}async cancel(e){this._abortController.abort(e),this._reader.releaseLock()}get signal(){return this._abortController.signal}}class nH extends nq.IterableReadableStream{get closed(){return this._closed}constructor(e){let t;const r=new Promise(e=>{t=e});super({start:e=>{t(e)}}),Object.defineProperty(this,"modes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"controller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"passthroughFn",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_closed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),r.then(e=>{this.controller=e}),this.passthroughFn=e.passthroughFn,this.modes=e.modes}push(e){this.passthroughFn?.(e),this.controller.enqueue(e)}close(){try{this.controller.close()}catch(e){}finally{this._closed=!0}}error(e){this.controller.error(e)}}let nY=Symbol.for("INPUT_DONE"),nX=Symbol.for("INPUT_RESUMING");class nQ{get isResuming(){let e=0!==Object.keys(this.checkpoint.channel_versions).length,t=this.config.configurable?.[aP]!==void 0&&this.config.configurable?.[aP],r=null===this.input||void 0===this.input,i=aJ(this.input)&&null!=this.input.resume,a=this.input===nX;return e&&(t||r||i||a)}constructor(e){Object.defineProperty(this,"input",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpointer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpointerGetNextVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"channels",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"managed",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpoint",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpointConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpointMetadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpointNamespace",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpointPendingWrites",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"checkpointPreviousVersions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"step",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputKeys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streamKeys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"skipDoneTasks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"prevCheckpointConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:"pending"}),Object.defineProperty(this,"tasks",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"stream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpointerPromises",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"isNested",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_checkpointerChainedPromise",{enumerable:!0,configurable:!0,writable:!0,value:Promise.resolve()}),Object.defineProperty(this,"store",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"manager",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"interruptAfter",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"interruptBefore",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"toInterrupt",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"debug",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.input=e.input,this.checkpointer=e.checkpointer,void 0!==this.checkpointer?this.checkpointerGetNextVersion=this.checkpointer.getNextVersion.bind(this.checkpointer):this.checkpointerGetNextVersion=nF,this.checkpoint=e.checkpoint,this.checkpointMetadata=e.checkpointMetadata,this.checkpointPreviousVersions=e.checkpointPreviousVersions,this.channels=e.channels,this.managed=e.managed,this.checkpointPendingWrites=e.checkpointPendingWrites,this.step=e.step,this.stop=e.stop,this.config=e.config,this.checkpointConfig=e.checkpointConfig,this.isNested=e.isNested,this.manager=e.manager,this.outputKeys=e.outputKeys,this.streamKeys=e.streamKeys,this.nodes=e.nodes,this.skipDoneTasks=e.skipDoneTasks,this.store=e.store,this.stream=e.stream,this.checkpointNamespace=e.checkpointNamespace,this.prevCheckpointConfig=e.prevCheckpointConfig,this.interruptAfter=e.interruptAfter,this.interruptBefore=e.interruptBefore,this.debug=e.debug}static async initialize(e){let{config:t,stream:r}=e;void 0!==r&&t.configurable?.[aT]!==void 0&&(r=function(...e){return new nH({passthroughFn:t=>{for(let r of e)r.modes.has(t[1])&&r.push(t)},modes:new Set(e.flatMap(e=>Array.from(e.modes)))})}(r,t.configurable[aT]));let i=!t.configurable||!("checkpoint_id"in t.configurable),a=t.configurable?.[aS];t.configurable&&a&&(a.subgraphCounter>0&&(t=nL(t,{[aj]:[t.configurable[aj],a.subgraphCounter.toString()].join("|")})),a.subgraphCounter+=1);let n=ak in(t.configurable??{});n||t.configurable?.checkpoint_ns===void 0||t.configurable?.checkpoint_ns===""||(t=nL(t,{checkpoint_ns:"",checkpoint_id:void 0}));let s=t;t.configurable?.[aC]!==void 0&&t.configurable?.[aC]?.[t.configurable?.checkpoint_ns]&&(s=nL(t,{checkpoint_id:t.configurable[aC][t.configurable?.checkpoint_ns]}));let o=t.configurable?.checkpoint_ns?.split("|")??[],l=await e.checkpointer?.getTuple(s)??{config:t,checkpoint:i5(),metadata:{source:"input",step:-2,writes:null,parents:{}},pendingWrites:[]};s={...t,...l.config,configurable:{checkpoint_ns:"",...t.configurable,...l.config.configurable}};let c=l.parentConfig,u=i4(l.checkpoint),h={...l.metadata},p=l.pendingWrites??[],d=ap(e.channelSpecs,u),f=(h.step??0)+1,m=f+(t.recursionLimit??25)+1,g={...u.channel_versions},b=e.store?new aa(e.store):void 0;return b&&b.start(),new nQ({input:e.input,config:t,checkpointer:e.checkpointer,checkpoint:u,checkpointMetadata:h,checkpointConfig:s,prevCheckpointConfig:c,checkpointNamespace:o,channels:d,managed:e.managed,isNested:n,manager:e.manager,skipDoneTasks:i,step:f,stop:m,checkpointPreviousVersions:g,checkpointPendingWrites:p,outputKeys:e.outputKeys??[],streamKeys:e.streamKeys??[],nodes:e.nodes,stream:r,store:b,interruptAfter:e.interruptAfter,interruptBefore:e.interruptBefore,debug:e.debug})}_checkpointerPutAfterPrevious(e){this._checkpointerChainedPromise=this._checkpointerChainedPromise.then(()=>this.checkpointer?.put(e.config,e.checkpoint,e.metadata,e.newVersions)),this.checkpointerPromises.push(this._checkpointerChainedPromise)}async updateManagedValues(e,t){let r=this.managed.get(e);r&&"update"in r&&"function"==typeof r.update&&await r.update(t)}putWrites(e,t){let r=t;if(0===r.length)return;for(let[t,i]of(r.every(([e])=>e in i9)&&(r=Array.from(new Map(r.map(e=>[e[0],e])).values())),r)){let r=this.checkpointPendingWrites.findIndex(r=>r[0]===e&&r[1]===t);t in i9&&-1!==r?this.checkpointPendingWrites[r]=[e,t,i]:this.checkpointPendingWrites.push([e,t,i])}let i=this.checkpointer?.putWrites({...this.checkpointConfig,configurable:{...this.checkpointConfig.configurable,checkpoint_ns:this.config.configurable?.checkpoint_ns??"",checkpoint_id:this.checkpoint.id}},r,e);void 0!==i&&this.checkpointerPromises.push(i),this.tasks&&this._outputWrites(e,r)}_outputWrites(e,t,r=!1){let i=this.tasks[e];if(void 0!==i){if(void 0!==i.config&&(i.config.tags??[]).includes(aD))return;t.length>0&&t[0][0]!==av&&t[0][0]!==aN&&this._emit(ns(na(nO(this.outputKeys,[[i,t]],r),"updates"))),r||this._emit(ns(na(function*(e,t,r){let i=new Date().toISOString();for(let[{id:a,name:n,config:s},o]of t)s?.tags?.includes(aD)||(yield{type:"task_result",timestamp:i,step:e,payload:{id:a,name:n,result:o.filter(([e])=>Array.isArray(r)?r.includes(e):e===r),interrupts:o.filter(e=>e[0]===aN).map(e=>e[1])}})}(this.step,[[i,t]],this.streamKeys),"debug")))}}async tick(e){this.store&&!this.store.isRunning&&this.store?.start();let{inputKeys:t=[]}=e;if("pending"!==this.status)throw Error(`Cannot tick when status is no longer "pending". Current status: "${this.status}"`);if([nY,nX].includes(this.input))if(this.toInterrupt.length>0)throw this.status="interrupt_before",new N;else{if(!Object.values(this.tasks).every(e=>e.writes.length>0))return!1;let e=Object.values(this.tasks).flatMap(e=>e.writes);for(let[e,t]of Object.entries(nK(this.checkpoint,this.channels,Object.values(this.tasks),this.checkpointerGetNextVersion)))await this.updateManagedValues(e,t);let t=await nn(na(nk(this.outputKeys,e,this.channels),"values"));if(this._emit(t),this.checkpointPendingWrites=[],await this._putCheckpoint({source:"loop",writes:nO(this.outputKeys,Object.values(this.tasks).map(e=>[e,e.writes])).next().value??null}),nB(this.checkpoint,this.interruptAfter,Object.values(this.tasks)))throw this.status="interrupt_after",new N;this.config.configurable?.[aP]!==void 0&&delete this.config.configurable?.[aP]}else await this._first(t);if(this.step>this.stop)return this.status="out_of_steps",!1;let r=nZ(this.checkpoint,this.checkpointPendingWrites,this.nodes,this.channels,this.managed,this.config,!0,{step:this.step,checkpointer:this.checkpointer,isResuming:this.isResuming,manager:this.manager,store:this.store,stream:this.stream});if(this.tasks=r,this.checkpointer&&this._emit(await nn(na(function*(e,t,r,i,a,n,s,o){function l(e){let t={};return null!=e.callbacks&&(t.callbacks=e.callbacks),null!=e.configurable&&(t.configurable=e.configurable),null!=e.maxConcurrency&&(t.max_concurrency=e.maxConcurrency),null!=e.metadata&&(t.metadata=e.metadata),null!=e.recursionLimit&&(t.recursion_limit=e.recursionLimit),null!=e.runId&&(t.run_id=e.runId),null!=e.runName&&(t.run_name=e.runName),null!=e.tags&&(t.tags=e.tags),t}let c=t.configurable?.checkpoint_ns,u={};for(let e of n){if(!(e.subgraphs?.length?e.subgraphs:[e.proc]).find(nA))continue;let r=`${e.name}:${e.id}`;c&&(r=`${c}|${r}`),u[e.id]={configurable:{thread_id:t.configurable?.thread_id,checkpoint_ns:r}}}let h=new Date().toISOString();yield{type:"checkpoint",timestamp:h,step:e,payload:{config:l(t),values:n_(r,i),metadata:a,next:n.map(e=>e.name),tasks:nx(n,s,u),parentConfig:o?l(o):void 0}}}(this.step-1,this.checkpointConfig,this.channels,this.streamKeys,this.checkpointMetadata,Object.values(this.tasks),this.checkpointPendingWrites,this.prevCheckpointConfig),"debug"))),0===Object.values(this.tasks).length)return this.status="done",!1;if(this.skipDoneTasks&&this.checkpointPendingWrites.length>0){for(let[e,t,r]of this.checkpointPendingWrites){if(t===av||t===aN||t===aI)continue;let i=Object.values(this.tasks).find(t=>t.id===e);i&&i.writes.push([t,r])}for(let e of Object.values(this.tasks))e.writes.length>0&&this._outputWrites(e.id,e.writes,!0)}if(Object.values(this.tasks).every(e=>e.writes.length>0))return this.tick({inputKeys:t});if(nB(this.checkpoint,this.interruptBefore,Object.values(this.tasks)))throw this.status="interrupt_before",new N;let i=await nn(na(nC(this.step,Object.values(this.tasks)),"debug"));return this._emit(i),!0}async finishAndHandleError(e){let t=this._suppressInterrupt(e);if((t||void 0===e)&&(this.output=n_(this.channels,this.outputKeys)),t){if(void 0!==this.tasks&&this.checkpointPendingWrites.length>0&&Object.values(this.tasks).some(e=>e.writes.length>0)){for(let[e,t]of Object.entries(nK(this.checkpoint,this.channels,Object.values(this.tasks),this.checkpointerGetNextVersion)))await this.updateManagedValues(e,t);this._emit(ns(na(nk(this.outputKeys,Object.values(this.tasks).flatMap(e=>e.writes),this.channels),"values")))}this._emit([["updates",{[aN]:e.interrupts}]])}return t}acceptPush(e,t,r){if(this.interruptAfter?.length>0&&nB(this.checkpoint,this.interruptAfter,[e]))return void this.toInterrupt.push(e);let i=nW([az,e.path??[],t,e.id,r],this.checkpoint,this.checkpointPendingWrites,this.nodes,this.channels,this.managed,e.config??{},!0,{step:this.step,checkpointer:this.checkpointer,manager:this.manager,store:this.store,stream:this.stream});if(i)return this.interruptBefore?.length>0&&nB(this.checkpoint,this.interruptBefore,[i])?void this.toInterrupt.push(i):(this._emit(ns(na(nC(this.step,[i]),"debug"))),this.debug&&nN(this.step,[i]),this.tasks[i.id]=i,this.skipDoneTasks&&this._matchWrites({[i.id]:i}),i)}_suppressInterrupt(e){return $(e)&&!this.isNested}async _first(e){let{configurable:t}=this.config,r=t?.[aS];if(r&&void 0!==r.nullResume&&this.putWrites(aV,[[aI,r.nullResume]]),aJ(this.input)){if(null!=this.input.resume&&null==this.checkpointer)throw Error("Cannot use Command(resume=...) without checkpointer");let e={};for(let[t,r,i]of function*(e,t){if(e.graph===aq.PARENT)throw new B("There is no parent graph.");if(e.goto){for(let t of Array.isArray(e.goto)?e.goto:[e.goto])if(aG(t))yield[aV,aB,t];else if("string"==typeof t)yield[aV,`branch:to:${t}`,"__start__"];else throw Error(`In Command.send, expected Send or string, got ${typeof t}`)}if(e.resume)if("object"==typeof e.resume&&Object.keys(e.resume).length&&Object.keys(e.resume).every(a9.validate))for(let[r,i]of Object.entries(e.resume)){let e=t.filter(e=>e[0]===r&&e[1]===aI).map(e=>e[2]).slice(0,1)??[];e.push(i),yield[r,aI,e]}else yield[aV,aI,e.resume];if(e.update){if("object"!=typeof e.update||!e.update)throw Error("Expected cmd.update to be a dict mapping channel names to update values");if(Array.isArray(e.update))for(let[t,r]of e.update)yield[aV,t,r];else for(let[t,r]of Object.entries(e.update))yield[aV,t,r]}}(this.input,this.checkpointPendingWrites))void 0===e[t]&&(e[t]=[]),e[t].push([r,i]);if(0===Object.keys(e).length)throw new D("Received empty Command input");for(let[t,r]of Object.entries(e))this.putWrites(t,r)}let i=(this.checkpointPendingWrites??[]).filter(e=>e[0]===aV).map(e=>e.slice(1));i.length>0&&nK(this.checkpoint,this.channels,[{name:ay,writes:i,triggers:[]}],this.checkpointerGetNextVersion);let a=aJ(this.input)&&i.length>0;if(this.isResuming||a){for(let e of Object.keys(this.channels))if(void 0!==this.checkpoint.channel_versions[e]){let t=this.checkpoint.channel_versions[e];this.checkpoint.versions_seen[aN]={...this.checkpoint.versions_seen[aN],[e]:t}}let e=await nn(na(nk(this.outputKeys,!0,this.channels),"values"));this._emit(e)}if(this.isResuming)this.input=nX;else if(a)await this._putCheckpoint({source:"input",writes:{}}),this.input=nY;else{let t=await nn(nw(e,this.input));if(t.length>0){let e=nZ(this.checkpoint,this.checkpointPendingWrites,this.nodes,this.channels,this.managed,this.config,!0,{step:this.step});nK(this.checkpoint,this.channels,Object.values(e).concat([{name:ay,writes:t,triggers:[]}]),this.checkpointerGetNextVersion),await this._putCheckpoint({source:"input",writes:Object.fromEntries(t)}),this.input=nY}else if(aP in(this.config.configurable??{}))this.input=nY;else throw new D(`Received no input writes for ${JSON.stringify(e,null,2)}`)}this.isNested||(this.config=nL(this.config,{[aP]:this.isResuming}))}_emit(e){for(let t of e)this.stream.modes.has(t[0])&&this.stream.push([this.checkpointNamespace,...t])}async _putCheckpoint(e){let t={...e,step:this.step,parents:this.config.configurable?.[aC]??{}};if(void 0!==this.checkpointer){this.prevCheckpointConfig=this.checkpointConfig?.configurable?.checkpoint_id?this.checkpointConfig:void 0,this.checkpointMetadata=t,this.checkpoint=ad(this.checkpoint,this.channels,this.step),this.checkpointConfig={...this.checkpointConfig,configurable:{...this.checkpointConfig.configurable,checkpoint_ns:this.config.configurable?.checkpoint_ns??""}};let e={...this.checkpoint.channel_versions},r=nR(this.checkpointPreviousVersions,e);this.checkpointPreviousVersions=e,this._checkpointerPutAfterPrevious({config:{...this.checkpointConfig},checkpoint:i4(this.checkpoint),metadata:{...this.checkpointMetadata},newVersions:r}),this.checkpointConfig={...this.checkpointConfig,configurable:{...this.checkpointConfig.configurable,checkpoint_id:this.checkpoint.id}}}this.step+=1}_matchWrites(e){for(let[t,r,i]of this.checkpointPendingWrites){if(r===av||r===aN||r===aI)continue;let a=Object.values(e).find(e=>e.id===t);a&&a.writes.push([r,i])}for(let t of Object.values(e))t.writes.length>0&&this._outputWrites(t.id,t.writes,!0)}}var n0=eT,i_=ro;class n1 extends n0.BaseCallbackHandler{constructor(e){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"StreamMessagesHandler"}),Object.defineProperty(this,"streamFn",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadatas",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"seen",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"emittedChatModelRunIds",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"stableMessageIdMap",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"lc_prefer_streaming",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.streamFn=e}_emit(e,t,r,i=!1){if(i&&void 0!==t.id&&void 0!==this.seen[t.id])return;let a=t.id;null!=r&&((0,i_.isToolMessage)(t)?a??=`run-${r}-tool-${t.tool_call_id}`:((null==a||a===`run-${r}`)&&(a=this.stableMessageIdMap[r]??a??`run-${r}`),this.stableMessageIdMap[r]??=a)),a!==t.id&&(t.id=a,t.lc_kwargs.id=a),null!=t.id&&(this.seen[t.id]=t),this.streamFn([e[0],"messages",[t,e[1]]])}handleChatModelStart(e,t,r,i,a,n,s,o){!s||n&&(n.includes("langsmith:nostream")||n.includes("nostream"))||(this.metadatas[r]=[s.langgraph_checkpoint_ns.split("|"),{tags:n,name:o,...s}])}handleLLMNewToken(e,t,r,i,a,n){let s=n?.chunk;(this.emittedChatModelRunIds[r]=!0,void 0!==this.metadatas[r])&&((0,tt.isBaseMessage)(s?.message)?this._emit(this.metadatas[r],s.message,r):this._emit(this.metadatas[r],new eC.AIMessageChunk({content:e}),r))}handleLLMEnd(e,t){if(!this.emittedChatModelRunIds[t]){let r=e.generations?.[0]?.[0];(0,tt.isBaseMessage)(r?.message)&&this._emit(this.metadatas[t],r?.message,t,!0),delete this.emittedChatModelRunIds[t]}delete this.metadatas[t],delete this.stableMessageIdMap[t]}handleLLMError(e,t){delete this.metadatas[t]}handleChainStart(e,t,r,i,a,n,s,o){if(void 0!==n&&o===n.langgraph_node&&(void 0===a||!a.includes(aD))&&(this.metadatas[r]=[n.langgraph_checkpoint_ns.split("|"),{tags:a,name:o,...n}],"object"==typeof t)){for(let e of Object.values(t))if(((0,tt.isBaseMessage)(e)||(0,tt.isBaseMessageChunk)(e))&&void 0!==e.id)this.seen[e.id]=e;else if(Array.isArray(e))for(let t of e)((0,tt.isBaseMessage)(t)||(0,tt.isBaseMessageChunk)(t))&&void 0!==t.id&&(this.seen[t.id]=t)}}handleChainEnd(e,t){let r=this.metadatas[t];if(delete this.metadatas[t],void 0!==r){if((0,tt.isBaseMessage)(e))this._emit(r,e,t,!0);else if(Array.isArray(e))for(let i of e)(0,tt.isBaseMessage)(i)&&this._emit(r,i,t,!0);else if(null!=e&&"object"==typeof e){for(let i of Object.values(e))if((0,tt.isBaseMessage)(i))this._emit(r,i,t,!0);else if(Array.isArray(i))for(let e of i)(0,tt.isBaseMessage)(e)&&this._emit(r,e,t,!0)}}}handleChainError(e,t){delete this.metadatas[t]}}let n2=[400,401,402,403,404,405,406,407,409],n5=e=>{if(e.message.startsWith("Cancel")||e.message.startsWith("AbortError")||"AbortError"===e.name||e?.code==="ECONNABORTED")return!1;let t=e?.response?.status??e?.status;return!(t&&n2.includes(+t))&&e?.error?.code!=="insufficient_quota"};async function n4(e,t,r,i){let a,n,s=e.retry_policy??t,o=void 0!==s?s.initialInterval??500:0,l=0,{config:c}=e;for(r&&(c=nL(c,r)),c={...c,signal:i};!i?.aborted;){e.writes.splice(0,e.writes.length),a=void 0;try{n=await e.proc.invoke(e.input,c);break}catch(i){if((a=i).pregelTaskId=e.id,R(a)){let t=c?.configurable?.checkpoint_ns,r=a.command;if(r.graph===t){for(let t of e.writers)await t.invoke(r,c);a=void 0;break}if(r.graph===aq.PARENT){let e=function(e){let t=e.split("|");for(;t.length>1&&t[t.length-1].match(/^\d+$/);)t.pop();return t.slice(0,-1).join("|")}(t);a.command=new aq({...a.command,graph:e})}}if(L(a)||void 0===s||(l+=1)>=(s.maxAttempts??3)||!(s.retryOn??n5)(a))break;o=Math.min(s.maxInterval??128e3,o*(s.backoffFactor??2));let t=s.jitter?Math.floor(o+1e3*Math.random()):o;await new Promise(e=>setTimeout(e,t));let r=a.name??a.constructor.unminifiable_name??a.constructor.name;(s?.logWarning??!0)&&console.log(`Retrying task "${String(e.name)}" after ${o.toFixed(2)}ms (attempt ${l}) after ${r}: ${a}`),c=nL(c,{[aP]:!0})}}return{task:e,result:n,error:a,signalAborted:i?.aborted}}let n3=Symbol.for("promiseAdded");class n8{constructor({loop:e,nodeFinished:t}){Object.defineProperty(this,"nodeFinished",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"loop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.loop=e,this.nodeFinished=t}async tick(e={}){let t,{timeout:r,retryPolicy:i,onStepWrite:a,maxConcurrency:n}=e,s=new Set,o=new AbortController,l=Object.values(this.loop.tasks).filter(e=>0===e.writes.length),c=this._initializeAbortSignals({exceptionSignalController:o,timeout:r,signal:e.signal});for await(let{task:e,error:r,signalAborted:a}of this._executeTasksWithRetry(l,{signals:c,retryPolicy:i,maxConcurrency:n}))this._commit(e,r),$(r)||L(r)&&!$(t)?t=r:r&&(0===s.size||!a)&&(o.abort(),s.add(r));if(a?.(this.loop.step,Object.values(this.loop.tasks).map(e=>e.writes).flat()),1===s.size)throw Array.from(s)[0];if(s.size>1)throw AggregateError(Array.from(s),`Multiple errors occurred during superstep ${this.loop.step}. See the "errors" field of this exception for more details.`);if($(t)||L(t)&&this.loop.isNested)throw t}_initializeAbortSignals({exceptionSignalController:e,timeout:t,signal:r}){let i=this.loop.config.configurable?.[ax]??{},a=r&&i.composedAbortSignal&&r!==i.composedAbortSignal?nD(i.externalAbortSignal,r):i.externalAbortSignal??r,n=i.errorAbortSignal?nD(i.errorAbortSignal,e.signal):e.signal,s=t?AbortSignal.timeout(t):void 0,o=nD(...a?[a]:[],...s?[s]:[],n),l={externalAbortSignal:a,errorAbortSignal:n,timeoutAbortSignal:s,composedAbortSignal:o};return this.loop.config=nL(this.loop.config,{[ax]:l}),l}async *_executeTasksWithRetry(e,t){let r,i,{retryPolicy:a,maxConcurrency:n,signals:s}=t??{},o=((i={next:()=>void 0,wait:Promise.resolve(n3)}).wait=new Promise(function e(t){i.next=()=>{i.wait=new Promise(e),t(n3)}}),i),l={},c={executingTasksMap:l,barrier:o,retryPolicy:a,scheduleTask:async(e,t,r)=>this.loop.acceptPush(e,t,r)};if(s?.composedAbortSignal?.aborted)throw Error("Abort");let u=0,h=s?.externalAbortSignal||s?.timeoutAbortSignal?nD(...s.externalAbortSignal?[s.externalAbortSignal]:[],...s.timeoutAbortSignal?[s.timeoutAbortSignal]:[]):void 0,p=h?new Promise((e,t)=>{r=()=>t(Error("Abort")),h.addEventListener("abort",r,{once:!0})}):void 0;for(;(0===u||Object.keys(l).length>0)&&e.length;){for(;Object.values(l).length<(n??e.length)&&u<e.length;u+=1){let t=e[u];l[t.id]=n4(t,a,{[aw]:n6?.bind(c,this,t)},s?.composedAbortSignal).catch(e=>({task:t,error:e,signalAborted:s?.composedAbortSignal?.aborted}))}let t=await Promise.race([...Object.values(l),...p?[p]:[],o.wait]);t!==n3&&(yield t,delete l[t.task.id])}}_commit(e,t){if(void 0!==t)if($(t)){if(t.interrupts.length){let r=t.interrupts.map(e=>[aN,e]),i=e.writes.filter(e=>e[0]===aI);i.length&&r.push(...i),this.loop.putWrites(e.id,r)}}else L(t)&&e.writes.length?this.loop.putWrites(e.id,e.writes):this.loop.putWrites(e.id,[[av,{message:t.message,name:t.name}]]);else this.nodeFinished&&(e.config?.tags==null||!e.config.tags.includes(aD))&&this.nodeFinished(String(e.name)),0===e.writes.length&&e.writes.push([aM,null]),this.loop.putWrites(e.id,e.writes)}}async function n6(e,t,r,i,a,n={}){let s=t.config?.configurable?.[aS];if(!s)throw Error(`BUG: No scratchpad found on task ${t.name}__${t.id}`);let o=s.callCounter;s.callCounter+=1;let l=new nI({func:r,name:i,input:a,retry:n.retry,callbacks:n.callbacks}),c=await this.scheduleTask(t,o,l);if(!c)return;let u=this.executingTasksMap[c.id];if(void 0!==u)return u;if(c.writes.length>0){let e=c.writes.filter(([e])=>e===aR),t=c.writes.filter(([e])=>e===av);if(e.length>0){if(1===e.length)return Promise.resolve(e[0][1]);throw Error(`BUG: multiple returns found for task ${c.name}__${c.id}`)}if(t.length>0){if(1===t.length){let e=t[0][1];return Promise.reject(e instanceof Error?e:Error(String(e)))}throw Error(`BUG: multiple errors found for task ${c.name}__${c.id}`)}return}{let t=n4(c,n.retry,{[aw]:n6.bind(this,e,c)});return this.executingTasksMap[c.id]=t,this.barrier.next(),t.then(({result:e,error:t})=>t?Promise.reject(t):e)}}class n9{static subscribeTo(e,t){let r,{key:i,tags:a}={key:void 0,tags:void 0,...t??{}};if(Array.isArray(e)&&void 0!==i)throw Error("Can't specify a key when subscribing to multiple channels");return new ng({channels:r="string"==typeof e?i?{[i]:e}:[e]:Object.fromEntries(e.map(e=>[e,e])),triggers:Array.isArray(e)?e:[e],tags:a})}static writeTo(e,t){let r=[];for(let t of e)r.push({channel:t,value:nl,skipNone:!1});for(let[e,i]of Object.entries(t??{}))iP.Runnable.isRunnable(i)||"function"==typeof i?r.push({channel:e,value:nl,skipNone:!0,mapper:(0,iP._coerceToRunnable)(i)}):r.push({channel:e,value:i,skipNone:!1});return new nh(r)}}class n7 extends iP.Runnable{static lc_name(){return"LangGraph"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langgraph","pregel"]}),Object.defineProperty(this,"lg_is_pregel",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"channels",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputChannels",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputChannels",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoValidate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"streamMode",{enumerable:!0,configurable:!0,writable:!0,value:["values"]}),Object.defineProperty(this,"streamChannels",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"interruptAfter",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"interruptBefore",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stepTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"debug",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"checkpointer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"retryPolicy",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"store",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let{streamMode:t}=e;null==t||Array.isArray(t)||(t=[t]),this.nodes=e.nodes,this.channels=e.channels,this.autoValidate=e.autoValidate??this.autoValidate,this.streamMode=t??this.streamMode,this.inputChannels=e.inputChannels,this.outputChannels=e.outputChannels,this.streamChannels=e.streamChannels??this.streamChannels,this.interruptAfter=e.interruptAfter,this.interruptBefore=e.interruptBefore,this.stepTimeout=e.stepTimeout??this.stepTimeout,this.debug=e.debug??this.debug,this.checkpointer=e.checkpointer,this.retryPolicy=e.retryPolicy,this.config=e.config,this.store=e.store,this.name=e.name,this.autoValidate&&this.validate()}withConfig(e){let t=(0,iA.mergeConfigs)(this.config,e);return new this.constructor({...this,config:t})}validate(){return!function({nodes:e,channels:t,inputChannels:r,outputChannels:i,streamChannels:a,interruptAfterNodes:n,interruptBeforeNodes:s}){if(!t)throw new nb("Channels not provided");let o=new Set,l=new Set;for(let[t,r]of Object.entries(e)){if(t===aN)throw new nb(`"Node name ${aN} is reserved"`);if(r.constructor===ng)r.triggers.forEach(e=>o.add(e));else throw new nb(`Invalid node type ${typeof r}, expected PregelNode`)}for(let e of o)if(!(e in t))throw new nb(`Subcribed channel '${String(e)}' not in channels`);if(Array.isArray(r)){if(r.every(e=>!o.has(e)))throw new nb(`None of the input channels ${r} are subscribed to by any node`)}else if(!o.has(r))throw new nb(`Input channel ${String(r)} is not subscribed to by any node`);for(let e of(Array.isArray(i)?i.forEach(e=>l.add(e)):l.add(i),a&&!Array.isArray(a)?l.add(a):Array.isArray(a)&&a.forEach(e=>l.add(e)),l))if(!(e in t))throw new nb(`Output channel '${String(e)}' not in channels`);if(n&&"*"!==n){for(let t of n)if(!(t in e))throw new nb(`Node ${String(t)} not in nodes`)}if(s&&"*"!==s){for(let t of s)if(!(t in e))throw new nb(`Node ${String(t)} not in nodes`)}}({nodes:this.nodes,channels:this.channels,outputChannels:this.outputChannels,inputChannels:this.inputChannels,streamChannels:this.streamChannels,interruptAfterNodes:this.interruptAfter,interruptBeforeNodes:this.interruptBefore}),this}get streamChannelsList(){return Array.isArray(this.streamChannels)?this.streamChannels:this.streamChannels?[this.streamChannels]:Object.keys(this.channels)}get streamChannelsAsIs(){return this.streamChannels?this.streamChannels:Object.keys(this.channels)}async getGraphAsync(e){return this.getGraph(e)}*getSubgraphs(e,t){for(let[r,i]of Object.entries(this.nodes))if(void 0===e||e.startsWith(r))for(let a of i.subgraphs?.length?i.subgraphs:[i.bound]){let i=nA(a);if(void 0!==i){if(r===e)return void(yield[r,i]);if(void 0===e&&(yield[r,i]),t){let a=e;for(let[n,s]of(void 0!==e&&(a=e.slice(r.length+1)),i.getSubgraphs(a,t)))yield[`${r}|${n}`,s]}}}}async *getSubgraphsAsync(e,t){yield*this.getSubgraphs(e,t)}async _prepareStateSnapshot({config:e,saved:t,subgraphCheckpointer:r,applyPendingWrites:i=!1}){if(void 0===t)return{values:{},next:[],config:e,tasks:[]};let{managed:a}=await this.prepareSpecs(e,{skipManaged:!0}),n=ap(this.channels,t.checkpoint);if(t.pendingWrites?.length){let e=t.pendingWrites.filter(([e,t])=>e===aV).map(([e,t,r])=>[String(t),r]);e.length>0&&nK(t.checkpoint,n,[{name:ay,writes:e,triggers:[]}])}let s=Object.values(nZ(t.checkpoint,t.pendingWrites,this.nodes,n,a,t.config,!0,{step:(t.metadata?.step??-1)+1,store:this.store})),o=await nn(this.getSubgraphsAsync()),l=t.config.configurable?.checkpoint_ns??"",c={};for(let e of s){let i=o.find(([t])=>t===e.name);if(!i)continue;let a=`${String(e.name)}:${e.id}`;if(l&&(a=`${l}|${a}`),void 0===r){let r={configurable:{thread_id:t.config.configurable?.thread_id,checkpoint_ns:a}};c[e.id]=r}else{let n={configurable:{[aO]:r,thread_id:t.config.configurable?.thread_id,checkpoint_ns:a}},s=i[1];c[e.id]=await s.getState(n,{subgraphs:!0})}}if(i&&t.pendingWrites?.length){let e=Object.fromEntries(s.map(e=>[e.id,e]));for(let[r,i,a]of t.pendingWrites)![av,aN,ee].includes(i)&&r in e&&e[r].writes.push([String(i),a]);let r=s.filter(e=>e.writes.length>0);r.length>0&&nK(t.checkpoint,n,r)}let u=t?.metadata;u&&t?.config?.configurable?.thread_id&&(u={...u,thread_id:t.config.configurable.thread_id});let h=s.filter(e=>0===e.writes.length).map(e=>e.name);return{values:n_(n,this.streamChannelsAsIs),next:h,tasks:nx(s,t?.pendingWrites??[],c),metadata:u,config:n$(t.config,t.metadata),createdAt:t.checkpoint.ts,parentConfig:t.parentConfig}}async getState(e,t){let r=e.configurable?.[aO]??this.checkpointer;if(!r)throw new x("No checkpointer set");let i=e.configurable?.checkpoint_ns??"";if(""!==i&&e.configurable?.[aO]===void 0){let a=nr(i);for await(let[i,n]of this.getSubgraphsAsync(a,!0))if(i===a)return await n.getState(no(e,{[aO]:r}),{subgraphs:t?.subgraphs});throw Error(`Subgraph with namespace "${a}" not found.`)}let a=(0,iA.mergeConfigs)(this.config,e),n=await r.getTuple(e);return await this._prepareStateSnapshot({config:a,saved:n,subgraphCheckpointer:t?.subgraphs?r:void 0,applyPendingWrites:!e.configurable?.checkpoint_id})}async *getStateHistory(e,t){let r=e.configurable?.[aO]??this.checkpointer;if(!r)throw Error("No checkpointer set");let i=e.configurable?.checkpoint_ns??"";if(""!==i&&e.configurable?.[aO]===void 0){let a=nr(i);for await(let[i,n]of this.getSubgraphsAsync(a,!0))if(i===a)return void(yield*n.getStateHistory(no(e,{[aO]:r}),t));throw Error(`Subgraph with namespace "${a}" not found.`)}let a=(0,iA.mergeConfigs)(this.config,e,{configurable:{checkpoint_ns:i}});for await(let e of r.list(a,t))yield this._prepareStateSnapshot({config:e.config,saved:e})}async bulkUpdateState(e,t){let r=e.configurable?.[aO]??this.checkpointer;if(!r)throw new x("No checkpointer set");if(0===t.length)throw Error("No supersteps provided");if(t.some(e=>0===e.updates.length))throw Error("No updates provided");let i=e.configurable?.checkpoint_ns??"";if(""!==i&&e.configurable?.[aO]===void 0){let a=nr(i);for await(let[,i]of this.getSubgraphsAsync(a,!0))return await i.bulkUpdateState(no(e,{[aO]:r}),t);throw Error(`Subgraph "${a}" not found`)}let a=async(e,t)=>{let i=this.config?(0,iA.mergeConfigs)(this.config,e):e,a=await r.getTuple(i),n=void 0!==a?i4(a.checkpoint):i5(),s={...a?.checkpoint.channel_versions},o=a?.metadata?.step??-1,l=no(i,{checkpoint_ns:i.configurable?.checkpoint_ns??""}),c=i.metadata??{};a?.config.configurable&&(l=no(i,a.config.configurable),c={...a.metadata,...c});let{values:u,asNode:h}=t[0];if(null==u&&void 0===h){if(t.length>1)throw new B("Cannot create empty checkpoint with multiple updates");return n$(await r.put(l,ad(n,void 0,o),{source:"update",step:o+1,writes:{},parents:a?.metadata?.parents??{}},{}),a?a.metadata:void 0)}let p=ap(this.channels,n),{managed:d}=await this.prepareSpecs(i,{skipManaged:!0});if(null===u&&h===ab){if(t.length>1)throw new B("Cannot apply multiple updates when clearing state");if(a){let e=nZ(n,a.pendingWrites||[],this.nodes,p,d,a.config,!0,{step:(a.metadata?.step??-1)+1,checkpointer:this.checkpointer||void 0,store:this.store}),t=(a.pendingWrites||[]).filter(e=>e[0]===aV).map(e=>e.slice(1));for(let[r,i,n]of(t.length>0&&nK(a.checkpoint,p,[{name:ay,writes:t,triggers:[]}]),a.pendingWrites||[]))![av,aN,ee].includes(i)&&r in e&&e[r].writes.push([i,n]);nK(n,p,Object.values(e))}return n$(await r.put(l,ad(n,void 0,o),{...c,source:"update",step:o+1,writes:{},parents:a?.metadata?.parents??{}},{}),a?a.metadata:void 0)}if(null==u&&"__copy__"===h){if(t.length>1)throw new B("Cannot copy checkpoint with multiple updates");return n$(await r.put(a?.parentConfig??l,ad(n,void 0,o),{source:"fork",step:o+1,writes:{},parents:a?.metadata?.parents??{}},{}),a?a.metadata:void 0)}if(h===ay){if(t.length>1)throw new B("Cannot apply multiple updates when updating as input");let e=await nn(nw(this.inputChannels,u));if(0===e.length)throw new B(`Received no input writes for ${JSON.stringify(this.inputChannels,null,2)}`);nK(n,p,[{name:ay,writes:e,triggers:[]}],r.getNextVersion.bind(this.checkpointer));let i=a?.metadata?.step!=null?a.metadata.step+1:-1,o=await r.put(l,ad(n,p,i),{source:"input",step:i,writes:Object.fromEntries(e),parents:a?.metadata?.parents??{}},nR(s,n.channel_versions));return await r.putWrites(o,e,X(ay,n.id)),n$(o,a?a.metadata:void 0)}if(i.configurable?.checkpoint_id===void 0&&a?.pendingWrites!==void 0&&a.pendingWrites.length>0){let e=nZ(n,a.pendingWrites,this.nodes,p,d,a.config,!0,{store:this.store,checkpointer:this.checkpointer,step:(a.metadata?.step??-1)+1}),t=(a.pendingWrites??[]).filter(e=>e[0]===aV).map(e=>e.slice(1));for(let[r,i,n]of(t.length>0&&nK(a.checkpoint,p,[{name:ay,writes:t,triggers:[]}]),a.pendingWrites))[av,aN,ee].includes(i)||void 0===e[r]||e[r].writes.push([i,n]);let r=Object.values(e).filter(e=>e.writes.length>0);r.length>0&&nK(n,p,r)}let f=Object.values(n.versions_seen).map(e=>Object.values(e)).flat().find(e=>!!e),m=[];if(1===t.length){let{values:e,asNode:r}=t[0];if(void 0===r&&1===Object.keys(this.nodes).length)[r]=Object.keys(this.nodes);else if(void 0===r&&void 0===f)"string"==typeof this.inputChannels&&void 0!==this.nodes[this.inputChannels]&&(r=this.inputChannels);else if(void 0===r){let e=Object.entries(n.versions_seen).map(([e,t])=>Object.values(t).map(t=>[t,e])).flat().sort(([e],[t])=>i8(e,t));e&&(1===e.length?r=e[0][1]:e[e.length-1][0]!==e[e.length-2][0]&&(r=e[e.length-1][1]))}if(void 0===r)throw new B('Ambiguous update, specify "asNode"');m.push({values:e,asNode:r})}else for(let{asNode:e,values:r}of t){if(null==e)throw new B('"asNode" is required when applying multiple updates');m.push({values:r,asNode:e})}let g=[];for(let{asNode:e,values:t}of m){if(void 0===this.nodes[e])throw new B(`Node "${e.toString()}" does not exist`);let r=this.nodes[e].getWriters();if(!r.length)throw new B(`No writers found for node "${e.toString()}"`);g.push({name:e,input:t,proc:r.length>1?iP.RunnableSequence.from(r,{omitSequenceTags:!0}):r[0],writes:[],triggers:[aN],id:X(aN,n.id),writers:[]})}for(let e of g)await e.proc.invoke(e.input,(0,iA.patchConfig)({...i,store:i?.store??this.store},{runName:i.runName??`${this.getName()}UpdateState`,configurable:{[a_]:t=>e.writes.push(...t),[ak]:(t,r=!1)=>nz(o,n,p,d,e,t,r)}}));for(let e of g){let t=e.writes.filter(e=>e[0]!==az);void 0!==a&&t.length>0&&await r.putWrites(l,t,e.id)}nK(n,p,g,r.getNextVersion.bind(this.checkpointer));let b=nR(s,n.channel_versions),y=await r.put(l,ad(n,p,o+1),{source:"update",step:o+1,writes:Object.fromEntries(m.map(e=>[e.asNode,e.values])),parents:a?.metadata?.parents??{}},b);for(let e of g){let t=e.writes.filter(e=>e[0]===az);t.length>0&&await r.putWrites(y,t,e.id)}return n$(y,a?a.metadata:void 0)},n=e;for(let{updates:e}of t)n=await a(n,e);return n}async updateState(e,t,r){return this.bulkUpdateState(e,[{updates:[{values:t,asNode:r}]}])}_defaults(e){let t,{debug:r,streamMode:i,inputKeys:a,outputKeys:n,interruptAfter:s,interruptBefore:o,...l}=e,c=!0,u=void 0!==r?r:this.debug,h=n;void 0===h?h=this.streamChannelsAsIs:ny(h,this.channels);let p=a;void 0===p?p=this.inputChannels:ny(p,this.channels);let d=o??this.interruptBefore??[],f=s??this.interruptAfter??[];return void 0!==i?(t=Array.isArray(i)?i:[i],c="string"==typeof i):(t=this.streamMode,c=!0),e.configurable?.[aA]!==void 0&&(t=["values"]),[u,t,p,h,l,d,f,!1===this.checkpointer?void 0:void 0!==e&&e.configurable?.[aO]!==void 0?e.configurable[aO]:this.checkpointer,e.store??this.store,c]}async stream(e,t){let r=new AbortController,i={recursionLimit:this.config?.recursionLimit,...t,signal:t?.signal?nD(t.signal,r.signal):r.signal};return new nJ(await super.stream(e,i),r)}streamEvents(e,t,r){let i=new AbortController,a={recursionLimit:this.config?.recursionLimit,callbacks:this.config?.callbacks,...t,signal:t?.signal?nD(t.signal,i.signal):i.signal};return new nJ(super.streamEvents(e,a,r),i)}async prepareSpecs(e,t){let r={...e,store:this.store},i={},a={};for(let[e,r]of Object.entries(this.channels))au(r)?i[e]=r:t?.skipManaged?a[e]={cls:a5,params:{config:{}}}:a[e]=r;return{channelSpecs:i,managed:new a0(await Object.entries(a).reduce(async(e,[t,i])=>{let a,n=await e;return a2(i)?("key"in i.params&&i.params.key===aQ&&(i.params.key=t),a=await i.cls.initialize(r,i.params)):a=await i.initialize(r),void 0!==a&&n.push([t,a]),n},Promise.resolve([])))}}async _validateInput(e){return e}async _validateConfigurable(e){return e}async *_streamIterator(e,t){let r,i,a=t?.subgraphs,n=nt(this.config,t);if(void 0===n.recursionLimit||n.recursionLimit<1)throw Error('Passed "recursionLimit" must be at least 1.');if(void 0!==this.checkpointer&&!1!==this.checkpointer&&void 0===n.configurable)throw Error('Checkpointer requires one or more of the following "configurable" keys: "thread_id", "checkpoint_ns", "checkpoint_id"');let s=await this._validateInput(e),{runId:o,...l}=n,[c,u,,h,p,d,f,m,g,b]=this._defaults(l);p.configurable=await this._validateConfigurable(p.configurable);let y=new nH({modes:new Set(u)});if(u.includes("messages")){let e=new n1(e=>y.push(e)),{callbacks:t}=p;if(void 0===t)p.callbacks=[e];else if(Array.isArray(t))p.callbacks=t.concat(e);else{let r=t.copy();r.addHandler(e,!0),p.callbacks=r}}u.includes("custom")&&(p.writer=e=>y.push([[],"custom",e]));let v=await (0,iA.getCallbackManagerForConfig)(p),_=await v?.handleChainStart(this.toJSON(),!e||Array.isArray(e)||e instanceof Date||"object"!=typeof e?{input:e}:e,o,void 0,void 0,void 0,p?.runName??this.getName()),{channelSpecs:w,managed:k}=await this.prepareSpecs(p),O=(async()=>{try{r=await nQ.initialize({input:s,config:p,checkpointer:m,nodes:this.nodes,channelSpecs:w,managed:k,outputKeys:h,streamKeys:this.streamChannelsAsIs,store:g,stream:y,interruptAfter:f,interruptBefore:d,manager:_,debug:this.debug});let e=new n8({loop:r,nodeFinished:p.configurable?.__pregel_node_finished});t?.subgraphs&&(r.config.configurable={...r.config.configurable,[aT]:r.stream}),await this._runLoop({loop:r,runner:e,debug:c,config:p})}catch(e){i=e}finally{try{r&&await r.store?.stop(),await Promise.all([...r?.checkpointerPromises??[],...Array.from(k.values()).map(e=>e.promises())])}catch(e){i=i??e}i?y.error(i):y.close()}})();try{for await(let e of y){if(void 0===e)throw Error("Data structure error.");let[t,r,i]=e;u.includes(r)&&(a&&!b?yield[t,r,i]:b?a?yield[t,i]:yield i:yield[r,i])}}catch(e){throw await _?.handleChainError(i),e}finally{await O}await _?.handleChainEnd(r?.output??{},o,void 0,void 0,void 0)}async invoke(e,t){let r=t?.streamMode??"values",i={...t,outputKeys:t?.outputKeys??this.outputChannels,streamMode:r},a=[];for await(let t of(await this.stream(e,i)))a.push(t);return"values"===r?a[a.length-1]:a}async _runLoop(e){let t,{loop:r,runner:i,debug:a,config:n}=e;try{for(;await r.tick({inputKeys:this.inputChannels});){var s,o,l;a&&(s=r.checkpointMetadata.step,o=r.channels,l=this.streamChannelsList,console.log([`${nj(nT,`[${s}:checkpoint]`)}`,`\x1b[1m State at the end of step ${s}:\x1b[0m
`,JSON.stringify(n_(o,l),null,2)].join(""))),a&&nN(r.step,Object.values(r.tasks)),await i.tick({timeout:this.stepTimeout,retryPolicy:this.retryPolicy,onStepWrite:(e,t)=>{a&&function(e,t,r){let i={};for(let[e,a]of t)r.includes(e)&&(i[e]||(i[e]=[]),i[e].push(a));console.log([`${nj(nT,`[${e}:writes]`)}`,`\x1b[1m Finished step ${e} with writes to ${Object.keys(i).length} channel${1!==Object.keys(i).length?"s":""}:\x1b[0m
`,Object.entries(i).map(([e,t])=>`- ${nj(nE,e)} -> ${t.map(e=>JSON.stringify(e)).join(", ")}`).join("\n")].join(""))}(e,t,this.streamChannelsList)},maxConcurrency:n.maxConcurrency,signal:n.signal})}if("out_of_steps"===r.status)throw new C(`Recursion limit of ${n.recursionLimit} reached without hitting a stop condition. You can increase the limit by setting the "recursionLimit" config key.`,{lc_error_code:"GRAPH_RECURSION_LIMIT"})}catch(e){if(t=e,!await r.finishAndHandleError(t))throw e}finally{void 0===t&&await r.finishAndHandleError()}}}class se extends ah{constructor(e=!0){super(),Object.defineProperty(this,"lc_graph_name",{enumerable:!0,configurable:!0,writable:!0,value:"EphemeralValue"}),Object.defineProperty(this,"guard",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.guard=e}fromCheckpoint(e){let t=new se(this.guard);return void 0!==e&&(t.value=[e]),t}update(e){if(0===e.length){let e=this.value.length>0;return this.value=[],e}if(1!==e.length&&this.guard)throw new B("EphemeralValue can only receive one value per step.");return this.value=[e[e.length-1]],!0}get(){if(0===this.value.length)throw new F;return this.value[0]}checkpoint(){if(0===this.value.length)throw new F;return this.value[0]}}class st{constructor(e){Object.defineProperty(this,"path",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ends",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),iP.Runnable.isRunnable(e.path)?this.path=e.path:this.path=(0,iP._coerceToRunnable)(e.path).withConfig({runName:"Branch"}),this.ends=Array.isArray(e.pathMap)?e.pathMap.reduce((e,t)=>(e[t]=t,e),{}):e.pathMap}run(e,t){return nh.registerWriter(new ni({name:"<branch_run>",trace:!1,func:async(r,i)=>{try{return await this._route(r,i,e,t)}catch(e){throw e.name===I.unminifiable_name&&console.warn("[WARN]: 'NodeInterrupt' thrown in conditional edge. This is likely a bug in your graph implementation.\nNodeInterrupt should only be thrown inside a node, not in edge conditions."),e}}}))}async _route(e,t,r,i){let a,n=await this.path.invoke(i?i(t):e,t);if(Array.isArray(n)||(n=[n]),(a=this.ends?n.map(e=>aG(e)?e:this.ends[e]):n).some(e=>!e))throw Error("Branch condition returned unknown or null destination");if(a.filter(aG).some(e=>e.node===ab))throw new B("Cannot send a packet to the END node");return await r(a,t)??e}}class sr{constructor(){Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"branches",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"entryPoint",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"compiled",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.nodes={},this.edges=new Set,this.branches={}}warnIfCompiled(e){this.compiled&&console.warn(e)}get allEdges(){return this.edges}addNode(...e){let t=e.length>=1&&"string"!=typeof e[0]?Array.isArray(e[0])?e[0]:Object.entries(e[0]):[[e[0],e[1],e[2]]];if(0===t.length)throw Error("No nodes provided in `addNode`");for(let[e,r,i]of t){for(let t of["|",":"])if(e.includes(t))throw Error(`"${t}" is a reserved character and is not allowed in node names.`);if(this.warnIfCompiled("Adding a node to a graph that has already been compiled. This will not be reflected in the compiled graph."),e in this.nodes)throw Error(`Node \`${e}\` already present.`);if(e===ab)throw Error(`Node \`${e}\` is reserved.`);let t=(0,iP._coerceToRunnable)(r);this.nodes[e]={runnable:t,metadata:i?.metadata,subgraphs:nP(t)?[t]:i?.subgraphs,ends:i?.ends}}return this}addEdge(e,t){if(this.warnIfCompiled("Adding an edge to a graph that has already been compiled. This will not be reflected in the compiled graph."),e===ab)throw Error("END cannot be a start node");if(t===ag)throw Error("START cannot be an end node");if(Array.from(this.edges).some(([t])=>t===e)&&!("channels"in this))throw Error(`Already found path for ${e}. For multiple edges, use StateGraph.`);return this.edges.add([e,t]),this}addConditionalEdges(e,t,r){let i="object"==typeof e?e:{source:e,path:t,pathMap:r};if(this.warnIfCompiled("Adding an edge to a graph that has already been compiled. This will not be reflected in the compiled graph."),!iP.Runnable.isRunnable(i.path)){let e=Array.isArray(i.pathMap)?i.pathMap.join(","):Object.keys(i.pathMap??{}).join(",");i.path=(0,iP._coerceToRunnable)(i.path).withConfig({runName:`Branch<${i.source}${""!==e?`,${e}`:""}>`.slice(0,63)})}let a="RunnableLambda"===i.path.getName()?"condition":i.path.getName();if(this.branches[i.source]&&this.branches[i.source][a])throw Error(`Condition \`${a}\` already present for node \`${e}\``);return this.branches[i.source]??={},this.branches[i.source][a]=new st(i),this}setEntryPoint(e){return this.warnIfCompiled("Setting the entry point of a graph that has already been compiled. This will not be reflected in the compiled graph."),this.addEdge(ag,e)}setFinishPoint(e){return this.warnIfCompiled("Setting a finish point of a graph that has already been compiled. This will not be reflected in the compiled graph."),this.addEdge(e,ab)}compile({checkpointer:e,interruptBefore:t,interruptAfter:r,name:i}={}){this.validate([...Array.isArray(t)?t:[],...Array.isArray(r)?r:[]]);let a=new si({builder:this,checkpointer:e,interruptAfter:r,interruptBefore:t,autoValidate:!1,nodes:{},channels:{[ag]:new se,[ab]:new se},inputChannels:ag,outputChannels:ab,streamChannels:[],streamMode:"values",name:i});for(let[e,t]of Object.entries(this.nodes))a.attachNode(e,t);for(let[e,t]of this.edges)a.attachEdge(e,t);for(let[e,t]of Object.entries(this.branches))for(let[r,i]of Object.entries(t))a.attachBranch(e,r,i);return a.validate()}validate(e){let t=new Set([...this.allEdges].map(([e,t])=>e));for(let[e]of Object.entries(this.branches))t.add(e);for(let e of t)if(e!==ag&&!(e in this.nodes))throw Error(`Found edge starting at unknown node \`${e}\``);let r=new Set([...this.allEdges].map(([e,t])=>t));for(let[e,t]of Object.entries(this.branches))for(let i of Object.values(t))if(null!=i.ends)for(let e of Object.values(i.ends))r.add(e);else for(let t of(r.add(ab),Object.keys(this.nodes)))t!==e&&r.add(t);for(let e of Object.values(this.nodes))for(let t of e.ends??[])r.add(t);for(let e of Object.keys(this.nodes))if(!r.has(e))throw new U(`Node \`${e}\` is not reachable.

If you are returning Command objects from your node,
make sure you are passing names of potential destination nodes as an "ends" array
into ".addNode(..., { ends: ["node1", "node2"] })".`,{lc_error_code:"UNREACHABLE_NODE"});for(let e of r)if(e!==ab&&!(e in this.nodes))throw Error(`Found edge ending at unknown node \`${e}\``);if(e){for(let t of e)if(!(t in this.nodes))throw Error(`Interrupt node \`${t}\` is not present`)}this.compiled=!0}}class si extends n7{constructor({builder:e,...t}){super(t),Object.defineProperty(this,"builder",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.builder=e}attachNode(e,t){this.channels[e]=new se,this.nodes[e]=new ng({channels:[],triggers:[],metadata:t.metadata,subgraphs:t.subgraphs,ends:t.ends}).pipe(t.runnable).pipe(new nh([{channel:e,value:nl}],[aD])),this.streamChannels.push(e)}attachEdge(e,t){if(t===ab){if(e===ag)throw Error("Cannot have an edge from START to END");this.nodes[e].writers.push(new nh([{channel:ab,value:nl}],[aD]))}else this.nodes[t].triggers.push(e),this.nodes[t].channels.push(e)}attachBranch(e,t,r){for(let i of(e!==ag||this.nodes[ag]||(this.nodes[ag]=n9.subscribeTo(ag,{tags:[aD]})),this.nodes[e].pipe(r.run(r=>new nh(r.map(r=>aG(r)?r:{channel:r===ab?ab:`branch:${e}:${t}:${r}`,value:nl}),[aD]))),r.ends?Object.values(r.ends):Object.keys(this.nodes)))if(i!==ab){let r=`branch:${e}:${t}:${i}`;this.channels[r]=new se,this.nodes[i].triggers.push(r),this.nodes[i].channels.push(r)}}async getGraphAsync(e){let t=e?.xray,r=new a6.Graph,i={[ag]:r.addNode({schema:tB.z.any()},ag)},a={},n={};function s(e,t,n,o=!1){if(t===ab&&void 0===a[ab]&&(a[ab]=r.addNode({schema:tB.z.any()},ab)),void 0!==i[e]){if(void 0===a[t])throw Error(`End node ${t} not found!`);return r.addEdge(i[e],a[t],n!==t?n:void 0,o)}}for(let[s,l]of(t&&(n=Object.fromEntries((await nn(this.getSubgraphsAsync())).filter(e=>sa(e[1])))),Object.entries(this.builder.nodes))){let c=sn(s),u=l.runnable,h=l.metadata??{};if(this.interruptBefore?.includes(s)&&this.interruptAfter?.includes(s)?h.__interrupt="before,after":this.interruptBefore?.includes(s)?h.__interrupt="before":this.interruptAfter?.includes(s)&&(h.__interrupt="after"),t){let l="number"==typeof t?t-1:t,p=void 0!==n[s]?await n[s].getGraphAsync({...e,xray:l}):u.getGraph(e);if(p.trimFirstNode(),p.trimLastNode(),Object.keys(p.nodes).length>1){let[e,t]=r.extend(p,c);if(void 0===e)throw Error(`Could not extend subgraph "${s}" due to missing entrypoint.`);function o(e,t){if(void 0!==e&&!(0,a9.validate)(e))return e;if(!t||!t.lc_runnable)return t.name??"UnknownSchema";try{let e=t.getName();return e=e.startsWith("Runnable")?e.slice(8):e}catch(e){return t.getName()}}void 0!==t&&(i[c]={name:o(t.id,t.data),...t}),a[c]={name:o(e.id,e.data),...e}}else{let e=r.addNode(u,c,h);i[c]=e,a[c]=e}}else{let e=r.addNode(u,c,h);i[c]=e,a[c]=e}}for(let[e,t]of[...this.builder.allEdges].sort(([e],[t])=>e<t?-1:+(t>e)))s(sn(e),sn(t));for(let[e,t]of Object.entries(this.builder.branches)){let r={...Object.fromEntries(Object.keys(this.builder.nodes).filter(t=>t!==e).map(e=>[sn(e),sn(e)])),[ab]:ab};for(let i of Object.values(t)){for(let[t,a]of Object.entries(void 0!==i.ends?i.ends:r))s(sn(e),sn(a),t,!0)}}for(let[e,t]of Object.entries(this.builder.nodes))if(void 0!==t.ends)for(let r of t.ends)s(sn(e),sn(r),void 0,!0);return r}getGraph(e){let t=e?.xray,r=new a6.Graph,i={[ag]:r.addNode({schema:tB.z.any()},ag)},a={},n={};function s(e,t,n,o=!1){return t===ab&&void 0===a[ab]&&(a[ab]=r.addNode({schema:tB.z.any()},ab)),r.addEdge(i[e],a[t],n!==t?n:void 0,o)}for(let[s,l]of(t&&(n=Object.fromEntries(ns(this.getSubgraphs()).filter(e=>sa(e[1])))),Object.entries(this.builder.nodes))){let c=sn(s),u=l.runnable,h=l.metadata??{};if(this.interruptBefore?.includes(s)&&this.interruptAfter?.includes(s)?h.__interrupt="before,after":this.interruptBefore?.includes(s)?h.__interrupt="before":this.interruptAfter?.includes(s)&&(h.__interrupt="after"),t){let l="number"==typeof t?t-1:t,p=void 0!==n[s]?n[s].getGraph({...e,xray:l}):u.getGraph(e);if(p.trimFirstNode(),p.trimLastNode(),Object.keys(p.nodes).length>1){let[e,t]=r.extend(p,c);if(void 0===e)throw Error(`Could not extend subgraph "${s}" due to missing entrypoint.`);function o(e,t){if(void 0!==e&&!(0,a9.validate)(e))return e;if(!t||!t.lc_runnable)return t.name??"UnknownSchema";try{let e=t.getName();return e=e.startsWith("Runnable")?e.slice(8):e}catch(e){return t.getName()}}void 0!==t&&(i[c]={name:o(t.id,t.data),...t}),a[c]={name:o(e.id,e.data),...e}}else{let e=r.addNode(u,c,h);i[c]=e,a[c]=e}}else{let e=r.addNode(u,c,h);i[c]=e,a[c]=e}}for(let[e,t]of[...this.builder.allEdges].sort(([e],[t])=>e<t?-1:+(t>e)))s(sn(e),sn(t));for(let[e,t]of Object.entries(this.builder.branches)){let r={...Object.fromEntries(Object.keys(this.builder.nodes).filter(t=>t!==e).map(e=>[sn(e),sn(e)])),[ab]:ab};for(let i of Object.values(t)){for(let[t,a]of Object.entries(void 0!==i.ends?i.ends:r))s(sn(e),sn(a),t,!0)}}return r}}function sa(e){return"function"==typeof e.attachNode&&"function"==typeof e.attachEdge}function sn(e){return"subgraph"===e?`"${e}"`:e}var iP=eR;let ss=(e,t)=>e.size===t.size&&[...e].every(e=>t.has(e));class so extends ah{constructor(e){super(),Object.defineProperty(this,"lc_graph_name",{enumerable:!0,configurable:!0,writable:!0,value:"NamedBarrierValue"}),Object.defineProperty(this,"names",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"seen",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.names=e,this.seen=new Set}fromCheckpoint(e){let t=new so(this.names);return void 0!==e&&(t.seen=new Set(e)),t}update(e){let t=!1;for(let r of e)if(this.names.has(r))this.seen.has(r)||(this.seen.add(r),t=!0);else throw new B(`Value ${JSON.stringify(r)} not in names ${JSON.stringify(this.names)}`);return t}get(){if(!ss(this.names,this.seen))throw new F}checkpoint(){return[...this.seen]}consume(){return!!(this.seen&&this.names&&ss(this.seen,this.names))&&(this.seen=new Set,!0)}}let sl=new WeakMap;function sc(e){return"object"==typeof e&&null!=e&&"_parse"in e&&"function"==typeof e._parse}function su(e){return sc(e)&&"partial"in e&&"function"==typeof e.partial}function sh(e){let t={};for(let i in e.shape)if(Object.prototype.hasOwnProperty.call(e.shape,i)){var r;let a=(r=e.shape[i],sl.get(r));a?.reducer?t[i]=new af(a.reducer.fn,a.default):t[i]=new am}return t}let sp="__root__";class sd extends sr{constructor(e,t){if(super(),Object.defineProperty(this,"channels",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"waitingEdges",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"_schemaDefinition",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaRuntimeDefinition",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_inputDefinition",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_inputRuntimeDefinition",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_outputDefinition",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_outputRuntimeDefinition",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaDefinitions",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"_configSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_configRuntimeSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),function(e){return"object"==typeof e&&null!=e&&"state"in e&&!!su(e.state)&&(!("input"in e)||!!su(e.input))&&(!("output"in e)||!!su(e.output))}(e)){const t=sh(e.state),r=null!=e.input?sh(e.input):t,i=null!=e.output?sh(e.output):t;this._schemaDefinition=t,this._schemaRuntimeDefinition=e.state,this._inputDefinition=r,this._inputRuntimeDefinition=e.input??e.state.partial(),this._outputDefinition=i,this._outputRuntimeDefinition=e.output??e.state}else if(su(e)){const t=sh(e);this._schemaDefinition=t,this._schemaRuntimeDefinition=e,this._inputDefinition=t,this._inputRuntimeDefinition=e.partial(),this._outputDefinition=t,this._outputRuntimeDefinition=e}else if(function(e){return"object"==typeof e&&null!==e&&void 0===e.stateSchema&&void 0!==e.input&&void 0!==e.output}(e))this._schemaDefinition=e.input.spec,this._inputDefinition=e.input.spec,this._outputDefinition=e.output.spec;else if(function(e){return"object"==typeof e&&null!==e&&void 0!==e.stateSchema}(e))this._schemaDefinition=e.stateSchema.spec,this._inputDefinition=e.input?.spec??this._schemaDefinition,this._outputDefinition=e.output?.spec??this._schemaDefinition;else if(function(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)&&Object.keys(e).length>0&&Object.values(e).every(e=>"function"==typeof e||au(e))}(e)||sm(e)){const t=sm(e)?e.spec:e;this._schemaDefinition=t}else if(function(e){return"object"==typeof e&&null!==e&&void 0!==e.channels}(e)){const t=function(e){let t={};for(let[r,i]of Object.entries(e))t[r]=a8(i);return t}(e.channels);this._schemaDefinition=t}else throw Error("Invalid StateGraph input.");this._inputDefinition??=this._schemaDefinition,this._outputDefinition??=this._schemaDefinition,this._addSchema(this._schemaDefinition),this._addSchema(this._inputDefinition),this._addSchema(this._outputDefinition),su(t)&&(this._configRuntimeSchema=t.passthrough())}get allEdges(){return new Set([...this.edges,...Array.from(this.waitingEdges).flatMap(([e,t])=>e.map(e=>[e,t]))])}_addSchema(e){if(!this._schemaDefinitions.has(e))for(let[t,r]of(this._schemaDefinitions.set(e,e),Object.entries(e))){let e;if(e="function"==typeof r?r():r,void 0!==this.channels[t]){if(this.channels[t]!==e&&!a2(e)&&"LastValue"!==e.lc_graph_name)throw Error(`Channel "${t}" already exists with a different type.`)}else this.channels[t]=e}}addNode(...e){let t=e.length>=1&&"string"!=typeof e[0]?Array.isArray(e[0])?e[0]:Object.entries(e[0]):[[e[0],e[1],e[2]]];if(0===t.length)throw Error("No nodes provided in `addNode`");for(let[e,r,i]of t){let t;if(e in this.channels)throw Error(`${e} is already being used as a state attribute (a.k.a. a channel), cannot also be used as a node name.`);for(let t of["|",":"])if(e.includes(t))throw Error(`"${t}" is a reserved character and is not allowed in node names.`);if(this.warnIfCompiled("Adding a node to a graph that has already been compiled. This will not be reflected in the compiled graph."),e in this.nodes)throw Error(`Node \`${e}\` already present.`);if(e===ab||e===ag)throw Error(`Node \`${e}\` is reserved.`);let a=this._schemaDefinition;i?.input!==void 0&&(su(i.input)?a=sh(i.input):void 0!==i.input.spec&&(a=i.input.spec)),void 0!==a&&this._addSchema(a);let n={runnable:t=iP.Runnable.isRunnable(r)?r:"function"==typeof r?new ni({func:r,name:e,trace:!1}):(0,iP._coerceToRunnable)(r),retryPolicy:i?.retryPolicy,metadata:i?.metadata,input:a??this._schemaDefinition,subgraphs:nP(t)?[t]:i?.subgraphs,ends:i?.ends};this.nodes[e]=n}return this}addEdge(e,t){if("string"==typeof e)return super.addEdge(e,t);for(let t of(this.compiled&&console.warn("Adding an edge to a graph that has already been compiled. This will not be reflected in the compiled graph."),e)){if(t===ab)throw Error("END cannot be a start node");if(!Object.keys(this.nodes).some(e=>e===t))throw Error(`Need to add a node named "${t}" first`)}if(t===ab)throw Error("END cannot be an end node");if(!Object.keys(this.nodes).some(e=>e===t))throw Error(`Need to add a node named "${t}" first`);return this.waitingEdges.add([e,t]),this}addSequence(e){let t,r=Array.isArray(e)?e:Object.entries(e);if(0===r.length)throw Error("Sequence requires at least one node.");for(let[e,i,a]of r){if(e in this.nodes)throw Error(`Node names must be unique: node with the name "${e}" already exists.`);this.addNode(e,i,a),null!=t&&this.addEdge(t,e),t=e}return this}compile({checkpointer:e,store:t,interruptBefore:r,interruptAfter:i,name:a}={}){this.validate([...Array.isArray(r)?r:[],...Array.isArray(i)?i:[]]);let n=Object.keys(this._schemaDefinitions.get(this._outputDefinition)),s=1===n.length&&n[0]===sp?sp:n,o=Object.keys(this.channels),l=1===o.length&&o[0]===sp?sp:o,c=new sf({builder:this,checkpointer:e,interruptAfter:i,interruptBefore:r,autoValidate:!1,nodes:{},channels:{...this.channels,[ag]:new se},inputChannels:ag,outputChannels:s,streamChannels:l,streamMode:"updates",store:t,name:a});for(let[e,t]of(c.attachNode(ag),Object.entries(this.nodes)))c.attachNode(e,t);for(let[e]of(c.attachBranch(ag,aF,sb(),{withReader:!1}),Object.entries(this.nodes)))c.attachBranch(e,aF,sb(),{withReader:!1});for(let[e,t]of this.edges)c.attachEdge(e,t);for(let[e,t]of this.waitingEdges)c.attachEdge(e,t);for(let[e,t]of Object.entries(this.branches))for(let[r,i]of Object.entries(t))c.attachBranch(e,r,i);return c.validate()}}class sf extends si{attachNode(e,t){let r,i=[{value:nl,mapper:new ni({func:(r=e===ag?Object.entries(this.builder._schemaDefinitions.get(this.builder._inputDefinition)).filter(([e,t])=>!a2(t)).map(([e])=>e):Object.keys(this.builder.channels)).length&&r[0]===sp?function(e){if(aJ(e))return e.graph===aq.PARENT?null:e._updateAsTuples();if(Array.isArray(e)&&e.length>0&&e.some(e=>aJ(e))){let t=[];for(let r of e)if(aJ(r)){if(r.graph===aq.PARENT)continue;t.push(...r._updateAsTuples())}else t.push([sp,r]);return t}return null!=e?[[sp,e]]:null}:function t(i){if(!i)return null;if(aJ(i))return i.graph===aq.PARENT?null:i._updateAsTuples().filter(([e])=>r.includes(e));if(Array.isArray(i)&&i.length>0&&i.some(aJ)){let e=[];for(let a of i)if(aJ(a)){if(a.graph===aq.PARENT)continue;e.push(...a._updateAsTuples().filter(([e])=>r.includes(e)))}else{let r=t(a);r&&e.push(...r??[])}return e}{if("object"==typeof i&&!Array.isArray(i))return Object.entries(i).filter(([e])=>r.includes(e));let t=Array.isArray(i)?"array":typeof i;throw new B(`Expected node "${e.toString()}" to return an object or an array containing at least one Command object, received ${t}`,{lc_error_code:"INVALID_GRAPH_NODE_RETURN_VALUE"})}},trace:!1,recurse:!1})}];if(e===ag)this.nodes[e]=new ng({tags:[aD],triggers:[ag],channels:[ag],writers:[new nh(i,[aD])]});else{let r=t?.input??this.builder._schemaDefinition,a=Object.fromEntries(Object.keys(this.builder._schemaDefinitions.get(r)).map(e=>[e,e])),n=1===Object.keys(a).length&&sp in a,s=`branch:to:${e}`;this.channels[s]=new se(!1),this.nodes[e]=new ng({triggers:[s],channels:n?Object.keys(a):a,writers:[new nh(i,[aD])],mapper:n?void 0:e=>Object.fromEntries(Object.entries(e).filter(([e])=>e in a)),bound:t?.runnable,metadata:t?.metadata,retryPolicy:t?.retryPolicy,subgraphs:t?.subgraphs,ends:t?.ends})}}attachEdge(e,t){if(t!==ab){if("string"==typeof e)this.nodes[e].writers.push(new nh([{channel:`branch:to:${t}`,value:null}],[aD]));else if(Array.isArray(e)){let r=`join:${e.join("+")}:${t}`;for(let i of(this.channels[r]=new so(new Set(e)),this.nodes[t].triggers.push(r),e))this.nodes[i].writers.push(new nh([{channel:r,value:i}],[aD]))}}}attachBranch(e,t,r,i={withReader:!0}){let a=async(t,r)=>{let i=t.filter(e=>e!==ab);if(!i.length)return;let a=i.map(t=>aG(t)?t:{channel:`branch:to:${t}`,value:e});await nh.doWrite({...r,tags:(r.tags??[]).concat([aD])},a)};this.nodes[e].writers.push(r.run(a,i.withReader?e=>nf.doRead(e,this.streamChannels??this.outputChannels,!0):void 0))}async _validateInput(e){let t=this.builder._inputRuntimeDefinition;return aJ(e)?(e.update&&su(t)&&(e.update=t.parse(e.update)),e):su(t)?t.parse(e):e}async _validateConfigurable(e){let t=this.builder._configRuntimeSchema;return su(t)&&t.parse(e),e}}function sm(e){return"object"==typeof e&&null!==e&&"lc_graph_name"in e&&"AnnotationRoot"===e.lc_graph_name}function sg(e){if(aG(e))return[e];let t=[];aJ(e)?t.push(e):Array.isArray(e)&&t.push(...e.filter(aJ));let r=[];for(let e of t){if(e.graph===aq.PARENT)throw new M(e);aG(e.goto)||"string"==typeof e.goto?r.push(e.goto):Array.isArray(e.goto)&&r.push(...e.goto)}return r}function sb(){return new st({path:new ni({func:sg,tags:[aD],trace:!1,recurse:!1,name:"<control_branch>"})})}var sy=e.i(59952);function sv(e,t){let r,i=Array.isArray(e)?e:[e],a=Array.isArray(t)?t:[t],n=i.map(ev.coerceMessageLikeToMessage),s=a.map(ev.coerceMessageLikeToMessage);for(let e of n)(null===e.id||void 0===e.id)&&(e.id=(0,sy.v4)(),e.lc_kwargs.id=e.id);for(let e=0;e<s.length;e+=1){let t=s[e];(null===t.id||void 0===t.id)&&(t.id=(0,sy.v4)(),t.lc_kwargs.id=t.id),"remove"===t.getType()&&"__remove_all__"===t.id&&(r=e)}if(null!=r)return s.slice(r+1);let o=[...n],l=new Map(o.map((e,t)=>[e.id,t])),c=new Set;for(let e of s){let t=l.get(e.id);if(void 0!==t)"remove"===e.getType()?c.add(e.id):(c.delete(e.id),o[t]=e);else{if("remove"===e.getType())throw Error(`Attempting to delete a message with an ID that doesn't exist ('${e.id}')`);l.set(e.id,o.length),o.push(e)}}return o.filter(e=>!c.has(e.id))}class s_ extends aY{call(e){return e===(this.config.recursionLimit??25)-1}}e.s(["IsLastStepManager",()=>s_],72711);class sw extends aX{constructor(e,t){if(super(e,t),Object.defineProperty(this,"scope",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"store",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ns",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:{}}),this.scope=t.scope,this.store=e.store||null,this.store)if(e.configurable?.[this.scope]){const r=e.configurable[this.scope],i="string"==typeof r?r:JSON.stringify(r);this.ns=["scoped",this.scope,t.key,i]}else throw Error(`Required scope "${this.scope}" for shared state key was not passed in "config.configurable".`);else this.ns=null}static async initialize(e,t){let r=new this(e,t);return await r.loadStore(),r}static on(e){return{cls:sw,params:{scope:e,key:aQ}}}call(e){return{...this.value}}processUpdate(e){let t=[];for(let r of e)for(let[e,i]of Object.entries(r))if(null===i)e in this.value&&(delete this.value[e],this.ns&&t.push({namespace:this.ns,key:e,value:null}));else if("object"!=typeof i||null===i)throw new B("Received a non-object value");else this.value[e]=i,this.ns&&t.push({namespace:this.ns,key:e,value:i});return t}async update(e){this.store?await this.store.batch(this.processUpdate(e)):this.processUpdate(e)}async loadStore(){if(this.store&&this.ns){let e=await this.store.search(this.ns);this.value=e.reduce((e,t)=>(e[t.key]=t.value,e),{})}return!1}}e.s(["SharedValue",()=>sw],21529),e.s([],41701),a3.Root({messages:a3({reducer:sv,default:()=>[]})}),tB.z.object({messages:function(e,t){if(t.reducer&&!t.default){let r=sc(e)&&"removeDefault"in e&&"function"==typeof e.removeDefault?e._def.defaultValue:void 0;null!=r&&(t.default=r)}return sl.set(e,t),e}(tB.z.custom(),{reducer:{schema:tB.z.custom(),fn:sv},default:()=>[]})}),e.s([],68294),T.AsyncLocalStorageProviderSingleton.initializeGlobalInstance(new S.AsyncLocalStorage),e.i(68294),e.i(79045),e.i(58443),e.i(98038),e.i(2641),e.i(41738),e.i(52536),e.i(11055),e.i(14005),e.i(71972),e.i(21197),e.i(44253),e.s(["AsyncBatchedStore",()=>aa,"BaseStore",()=>ai,"InMemoryStore",()=>as,"InvalidNamespaceError",()=>ae,"MemoryStore",()=>ao,"getTextAtPath",()=>at,"tokenizePath",()=>ar],21641),e.i(21641),e.i(85227),e.i(79896),e.i(34939),e.s(["BaseCache",()=>al,"InMemoryCache",()=>ac],88945),e.i(88945),e.i(41701),e.i(86359),e.i(72711),e.i(21529),e.s(["ChannelKeyPlaceholder",0,aQ,"IsLastStepManager",()=>s_,"ManagedValue",()=>aY,"ManagedValueMapping",()=>a0,"NoopManagedValue",()=>a5,"SharedValue",()=>sw,"WritableManagedValue",()=>aX,"isConfiguredManagedValue",()=>a2,"isManagedValue",()=>a1],45207),e.i(45207);var sk=e.i(89228),i_=ro,iP=eR;function sO(e,t){let r;if(void 0===e.function)return;if(t?.partial)try{r=(0,tZ.parsePartialJson)(e.function.arguments??"{}")}catch(e){return}else try{r=JSON.parse(e.function.arguments)}catch(t){throw new tj([`Function "${e.function.name}" arguments:`,"",e.function.arguments,"\nare not valid JSON.",`Error: ${t.message}`].join("\n"))}let i={name:e.function.name,args:r,type:"tool_call"};return t?.returnId&&(i.id=e.id),i}function sP(e){if(void 0===e.id)throw Error('All OpenAI tool calls must have an "id" field.');return{id:e.id,type:"function",function:{name:e.name,arguments:JSON.stringify(e.args)}}}class sA extends tN{static lc_name(){return"JsonOutputToolsParser"}constructor(e){super(e),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.returnId=e?.returnId??this.returnId}_diff(){throw Error("Not supported.")}async parse(){throw Error("Not implemented.")}async parseResult(e){return await this.parsePartialResult(e,!1)}async parsePartialResult(e,t=!0){let r,i=e[0].message;if((0,eC.isAIMessage)(i)&&i.tool_calls?.length?r=i.tool_calls.map(e=>{let{id:t,...r}=e;return this.returnId?{id:t,...r}:r}):void 0!==i.additional_kwargs.tool_calls&&(r=JSON.parse(JSON.stringify(i.additional_kwargs.tool_calls)).map(e=>sO(e,{returnId:this.returnId,partial:t}))),!r)return[];let a=[];for(let e of r)if(void 0!==e){let t={type:e.name,args:e.args,id:e.id};a.push(t)}return a}}class sT extends sA{static lc_name(){return"JsonOutputKeyToolsParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.zodSchema=e.zodSchema}async _validateResult(e){if(void 0===this.zodSchema)return e;let t=await (0,tl.interopSafeParseAsync)(this.zodSchema,e);if(t.success)return t.data;throw new tj(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(t.error?.issues)}`,JSON.stringify(e,null,2))}async parsePartialResult(e){let t=(await super.parsePartialResult(e)).filter(e=>e.type===this.keyName),r=t;if(t.length)return(this.returnId||(r=t.map(e=>e.args)),this.returnSingle)?r[0]:r}async parseResult(e){let t=(await super.parsePartialResult(e,!1)).filter(e=>e.type===this.keyName),r=t;return t.length?(this.returnId||(r=t.map(e=>e.args)),this.returnSingle)?this._validateResult(r[0]):await Promise.all(r.map(e=>this._validateResult(e))):void 0}}e.i(58386);var sS=e.i(1480),sE=e.i(68510),sj=e.i(17958);function sC(e,t,r,i){i?.errorMessages&&r&&(e.errorMessage={...e.errorMessage,[t]:r})}function sx(e,t,r,i,a){e[t]=r,sC(e,t,i,a)}let sN=/^[cC][^\s-]{8,}$/,sI=/^[0-9a-z]+$/,sM=/^[0-9A-HJKMNP-TV-Z]{26}$/,sR=/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,sL=()=>(void 0===i&&(i=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),i),s$=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,sD=/^[a-zA-Z0-9_-]{21}$/;function sF(e,t){let r={type:"string"};function i(e){return"escape"===t.patternStrategy?sB(e):e}if(e.checks)for(let a of e.checks)switch(a.kind){case"min":sx(r,"minLength","number"==typeof r.minLength?Math.max(r.minLength,a.value):a.value,a.message,t);break;case"max":sx(r,"maxLength","number"==typeof r.maxLength?Math.min(r.maxLength,a.value):a.value,a.message,t);break;case"email":switch(t.emailStrategy){case"format:email":sz(r,"email",a.message,t);break;case"format:idn-email":sz(r,"idn-email",a.message,t);break;case"pattern:zod":sU(r,sR,a.message,t)}break;case"url":sz(r,"uri",a.message,t);break;case"uuid":sz(r,"uuid",a.message,t);break;case"regex":sU(r,a.regex,a.message,t);break;case"cuid":sU(r,sN,a.message,t);break;case"cuid2":sU(r,sI,a.message,t);break;case"startsWith":sU(r,RegExp(`^${i(a.value)}`),a.message,t);break;case"endsWith":sU(r,RegExp(`${i(a.value)}$`),a.message,t);break;case"datetime":sz(r,"date-time",a.message,t);break;case"date":sz(r,"date",a.message,t);break;case"time":sz(r,"time",a.message,t);break;case"duration":sz(r,"duration",a.message,t);break;case"length":sx(r,"minLength","number"==typeof r.minLength?Math.max(r.minLength,a.value):a.value,a.message,t),sx(r,"maxLength","number"==typeof r.maxLength?Math.min(r.maxLength,a.value):a.value,a.message,t);break;case"includes":sU(r,RegExp(i(a.value)),a.message,t);break;case"ip":"v6"!==a.version&&sz(r,"ipv4",a.message,t),"v4"!==a.version&&sz(r,"ipv6",a.message,t);break;case"emoji":sU(r,sL,a.message,t);break;case"ulid":sU(r,sM,a.message,t);break;case"base64":switch(t.base64Strategy){case"format:binary":sz(r,"binary",a.message,t);break;case"contentEncoding:base64":sx(r,"contentEncoding","base64",a.message,t);break;case"pattern:zod":sU(r,s$,a.message,t)}break;case"nanoid":sU(r,sD,a.message,t)}return r}let sB=e=>Array.from(e).map(e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`).join(""),sz=(e,t,r,i)=>{e.format||e.anyOf?.some(e=>e.format)?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format,...e.errorMessage&&i.errorMessages&&{errorMessage:{format:e.errorMessage.format}}}),delete e.format,e.errorMessage&&(delete e.errorMessage.format,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.anyOf.push({format:t,...r&&i.errorMessages&&{errorMessage:{format:r}}})):sx(e,"format",t,r,i)},sU=(e,t,r,i)=>{e.pattern||e.allOf?.some(e=>e.pattern)?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern,...e.errorMessage&&i.errorMessages&&{errorMessage:{pattern:e.errorMessage.pattern}}}),delete e.pattern,e.errorMessage&&(delete e.errorMessage.pattern,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.allOf.push({pattern:sV(t,i),...r&&i.errorMessages&&{errorMessage:{pattern:r}}})):sx(e,"pattern",sV(t,i),r,i)},sV=(e,t)=>{let r="function"==typeof e?e():e;if(!t.applyRegexFlags||!r.flags)return r.source;let i={i:r.flags.includes("i"),m:r.flags.includes("m"),s:r.flags.includes("s")},a=i.i?r.source.toLowerCase():r.source,n="",s=!1,o=!1,l=!1;for(let e=0;e<a.length;e++){if(s){n+=a[e],s=!1;continue}if(i.i){if(o){if(a[e].match(/[a-z]/)){l?(n+=a[e],n+=`${a[e-2]}-${a[e]}`.toUpperCase(),l=!1):"-"===a[e+1]&&a[e+2]?.match(/[a-z]/)?(n+=a[e],l=!0):n+=`${a[e]}${a[e].toUpperCase()}`;continue}}else if(a[e].match(/[a-z]/)){n+=`[${a[e]}${a[e].toUpperCase()}]`;continue}}if(i.m){if("^"===a[e]){n+=`(^|(?<=[\r
]))`;continue}else if("$"===a[e]){n+=`($|(?=[\r
]))`;continue}}if(i.s&&"."===a[e]){n+=o?`${a[e]}\r
`:`[${a[e]}\r
]`;continue}n+=a[e],"\\"===a[e]?s=!0:o&&"]"===a[e]?o=!1:o||"["!==a[e]||(o=!0)}try{new RegExp(n)}catch{return console.warn(`Could not convert regex pattern at ${t.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),r.source}return n};function sK(e,t){if("openApi3"===t.target&&e.keyType?._def.typeName===sj.ZodFirstPartyTypeKind.ZodEnum)return{type:"object",required:e.keyType._def.values,properties:e.keyType._def.values.reduce((r,i)=>({...r,[i]:sJ(e.valueType._def,{...t,currentPath:[...t.currentPath,"properties",i]})??{}}),{}),additionalProperties:!1};let r={type:"object",additionalProperties:sJ(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??{}};if("openApi3"===t.target)return r;if(e.keyType?._def.typeName===sj.ZodFirstPartyTypeKind.ZodString&&e.keyType._def.checks?.length){let i=Object.entries(sF(e.keyType._def,t)).reduce((e,[t,r])=>"type"===t?e:{...e,[t]:r},{});return{...r,propertyNames:i}}return e.keyType?._def.typeName===sj.ZodFirstPartyTypeKind.ZodEnum?{...r,propertyNames:{enum:e.keyType._def.values}}:r}let sZ={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"},sW=(e,t)=>{let r=(e.options instanceof Map?Array.from(e.options.values()):e.options).map((e,r)=>sJ(e._def,{...t,currentPath:[...t.currentPath,"anyOf",`${r}`]})).filter(e=>!!e&&(!t.strictUnions||"object"==typeof e&&Object.keys(e).length>0));return r.length?{anyOf:r}:void 0},sG=Symbol("Let zodToJsonSchema decide on which parser to use"),sq={name:void 0,$refStrategy:"root",effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",nullableStrategy:"from-target",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"};function sJ(e,t,r=!1){let i=t.seen.get(e);if(t.override){let a=t.override?.(e,t,i,r);if(a!==sG)return a}if(i&&!r){let e=sH(i,t);if(void 0!==e)return"$ref"in e&&t.seenRefs.add(e.$ref),e}let a={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,a);let n=sX(e,e.typeName,t,r);return n&&sQ(e,t,n),a.jsonSchema=n,n}let sH=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"extract-to-root":let r=e.path.slice(t.basePath.length+1).join("_");return r!==t.name&&"duplicate-ref"===t.nameStrategy&&(t.definitions[r]=e.def),{$ref:[...t.basePath,t.definitionPath,r].join("/")};case"relative":return{$ref:sY(t.currentPath,e.path)};case"none":case"seen":if(e.path.length<t.currentPath.length&&e.path.every((e,r)=>t.currentPath[r]===e))return console.warn(`Recursive reference detected at ${t.currentPath.join("/")}! Defaulting to any`),{};return"seen"===t.$refStrategy?{}:void 0}},sY=(e,t)=>{let r=0;for(;r<e.length&&r<t.length&&e[r]===t[r];r++);return[(e.length-r).toString(),...t.slice(r)].join("/")},sX=(e,t,r,i)=>{switch(t){case sj.ZodFirstPartyTypeKind.ZodString:return sF(e,r);case sj.ZodFirstPartyTypeKind.ZodNumber:let a={type:"number"};if(!e.checks)return a;for(let t of e.checks)switch(t.kind){case"int":a.type="integer",sC(a,"type",t.message,r);break;case"min":"jsonSchema7"===r.target?t.inclusive?sx(a,"minimum",t.value,t.message,r):sx(a,"exclusiveMinimum",t.value,t.message,r):(t.inclusive||(a.exclusiveMinimum=!0),sx(a,"minimum",t.value,t.message,r));break;case"max":"jsonSchema7"===r.target?t.inclusive?sx(a,"maximum",t.value,t.message,r):sx(a,"exclusiveMaximum",t.value,t.message,r):(t.inclusive||(a.exclusiveMaximum=!0),sx(a,"maximum",t.value,t.message,r));break;case"multipleOf":sx(a,"multipleOf",t.value,t.message,r)}return a;case sj.ZodFirstPartyTypeKind.ZodObject:let n;return(n={type:"object",...Object.entries(e.shape()).reduce((e,[t,i])=>{if(void 0===i||void 0===i._def)return e;let a=[...r.currentPath,"properties",t],n=sJ(i._def,{...r,currentPath:a,propertyPath:a});return void 0===n?e:(r.openaiStrictMode&&i.isOptional()&&!i.isNullable()&&console.warn(`Zod field at \`${a.join("/")}\` uses \`.optional()\` without \`.nullable()\` which is not supported by the API. See: https://platform.openai.com/docs/guides/structured-outputs?api-mode=responses#all-fields-must-be-required
This will become an error in a future version of the SDK.`),{properties:{...e.properties,[t]:n},required:i.isOptional()&&!r.openaiStrictMode?e.required:[...e.required,t]})},{properties:{},required:[]}),additionalProperties:"strict"===r.removeAdditionalStrategy?"ZodNever"===e.catchall._def.typeName?"strict"!==e.unknownKeys:sJ(e.catchall._def,{...r,currentPath:[...r.currentPath,"additionalProperties"]})??!0:"ZodNever"===e.catchall._def.typeName?"passthrough"===e.unknownKeys:sJ(e.catchall._def,{...r,currentPath:[...r.currentPath,"additionalProperties"]})??!0}).required.length||delete n.required,n;case sj.ZodFirstPartyTypeKind.ZodBigInt:let s={type:"integer",format:"int64"};if(!e.checks)return s;for(let t of e.checks)switch(t.kind){case"min":"jsonSchema7"===r.target?t.inclusive?sx(s,"minimum",t.value,t.message,r):sx(s,"exclusiveMinimum",t.value,t.message,r):(t.inclusive||(s.exclusiveMinimum=!0),sx(s,"minimum",t.value,t.message,r));break;case"max":"jsonSchema7"===r.target?t.inclusive?sx(s,"maximum",t.value,t.message,r):sx(s,"exclusiveMaximum",t.value,t.message,r):(t.inclusive||(s.exclusiveMaximum=!0),sx(s,"maximum",t.value,t.message,r));break;case"multipleOf":sx(s,"multipleOf",t.value,t.message,r)}return s;case sj.ZodFirstPartyTypeKind.ZodBoolean:return{type:"boolean"};case sj.ZodFirstPartyTypeKind.ZodDate:return function e(t,r,i){let a=i??r.dateStrategy;if(Array.isArray(a))return{anyOf:a.map((i,a)=>e(t,r,i))};switch(a){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":var n=t,s=r;let o={type:"integer",format:"unix-time"};if("openApi3"===s.target)return o;for(let e of n.checks)switch(e.kind){case"min":sx(o,"minimum",e.value,e.message,s);break;case"max":sx(o,"maximum",e.value,e.message,s)}return o}}(e,r);case sj.ZodFirstPartyTypeKind.ZodUndefined:return{not:{}};case sj.ZodFirstPartyTypeKind.ZodNull:return"openApi3"===r.target?{enum:["null"],nullable:!0}:{type:"null"};case sj.ZodFirstPartyTypeKind.ZodArray:let o;return o={type:"array"},e.type?._def?.typeName!==sj.ZodFirstPartyTypeKind.ZodAny&&(o.items=sJ(e.type._def,{...r,currentPath:[...r.currentPath,"items"]})),e.minLength&&sx(o,"minItems",e.minLength.value,e.minLength.message,r),e.maxLength&&sx(o,"maxItems",e.maxLength.value,e.maxLength.message,r),e.exactLength&&(sx(o,"minItems",e.exactLength.value,e.exactLength.message,r),sx(o,"maxItems",e.exactLength.value,e.exactLength.message,r)),o;case sj.ZodFirstPartyTypeKind.ZodUnion:case sj.ZodFirstPartyTypeKind.ZodDiscriminatedUnion:if("openApi3"===r.target)return sW(e,r);let l=e.options instanceof Map?Array.from(e.options.values()):e.options;if(l.every(e=>e._def.typeName in sZ&&(!e._def.checks||!e._def.checks.length))){let e=l.reduce((e,t)=>{let r=sZ[t._def.typeName];return r&&!e.includes(r)?[...e,r]:e},[]);return{type:e.length>1?e:e[0]}}if(l.every(e=>"ZodLiteral"===e._def.typeName&&!e.description)){let e=l.reduce((e,t)=>{let r=typeof t._def.value;switch(r){case"string":case"number":case"boolean":return[...e,r];case"bigint":return[...e,"integer"];case"object":if(null===t._def.value)return[...e,"null"];default:return e}},[]);if(e.length===l.length){let t=e.filter((e,t,r)=>r.indexOf(e)===t);return{type:t.length>1?t:t[0],enum:l.reduce((e,t)=>e.includes(t._def.value)?e:[...e,t._def.value],[])}}}else if(l.every(e=>"ZodEnum"===e._def.typeName))return{type:"string",enum:l.reduce((e,t)=>[...e,...t._def.values.filter(t=>!e.includes(t))],[])};return sW(e,r);case sj.ZodFirstPartyTypeKind.ZodIntersection:let c,u,h;return c=[sJ(e.left._def,{...r,currentPath:[...r.currentPath,"allOf","0"]}),sJ(e.right._def,{...r,currentPath:[...r.currentPath,"allOf","1"]})].filter(e=>!!e),u="jsonSchema2019-09"===r.target?{unevaluatedProperties:!1}:void 0,h=[],c.forEach(e=>{if((!("type"in e)||"string"!==e.type)&&"allOf"in e)h.push(...e.allOf),void 0===e.unevaluatedProperties&&(u=void 0);else{let t=e;if("additionalProperties"in e&&!1===e.additionalProperties){let{additionalProperties:r,...i}=e;t=i}else u=void 0;h.push(t)}}),h.length?{allOf:h,...u}:void 0;case sj.ZodFirstPartyTypeKind.ZodTuple:return e.rest?{type:"array",minItems:e.items.length,items:e.items.map((e,t)=>sJ(e._def,{...r,currentPath:[...r.currentPath,"items",`${t}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[]),additionalItems:sJ(e.rest._def,{...r,currentPath:[...r.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map((e,t)=>sJ(e._def,{...r,currentPath:[...r.currentPath,"items",`${t}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[])};case sj.ZodFirstPartyTypeKind.ZodRecord:return sK(e,r);case sj.ZodFirstPartyTypeKind.ZodLiteral:let p;return"bigint"!=(p=typeof e.value)&&"number"!==p&&"boolean"!==p&&"string"!==p?{type:Array.isArray(e.value)?"array":"object"}:"openApi3"===r.target?{type:"bigint"===p?"integer":p,enum:[e.value]}:{type:"bigint"===p?"integer":p,const:e.value};case sj.ZodFirstPartyTypeKind.ZodEnum:return{type:"string",enum:[...e.values]};case sj.ZodFirstPartyTypeKind.ZodNativeEnum:let d,f,m;return d=e.values,{type:1===(m=Array.from(new Set((f=Object.keys(e.values).filter(e=>"number"!=typeof d[d[e]]).map(e=>d[e])).map(e=>typeof e)))).length?"string"===m[0]?"string":"number":["string","number"],enum:f};case sj.ZodFirstPartyTypeKind.ZodNullable:if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return"openApi3"===r.target||"property"===r.nullableStrategy?{type:sZ[e.innerType._def.typeName],nullable:!0}:{type:[sZ[e.innerType._def.typeName],"null"]};if("openApi3"===r.target){let t=sJ(e.innerType._def,{...r,currentPath:[...r.currentPath]});return t&&"$ref"in t?{allOf:[t],nullable:!0}:t&&{...t,nullable:!0}}let g=sJ(e.innerType._def,{...r,currentPath:[...r.currentPath,"anyOf","0"]});return g&&{anyOf:[g,{type:"null"}]};case sj.ZodFirstPartyTypeKind.ZodOptional:if(r.currentPath.toString()===r.propertyPath?.toString())return sJ(e.innerType._def,r);let b=sJ(e.innerType._def,{...r,currentPath:[...r.currentPath,"anyOf","1"]});return b?{anyOf:[{not:{}},b]}:{};case sj.ZodFirstPartyTypeKind.ZodMap:if("record"===r.mapStrategy)return sK(e,r);return{type:"array",maxItems:125,items:{type:"array",items:[sJ(e.keyType._def,{...r,currentPath:[...r.currentPath,"items","items","0"]})||{},sJ(e.valueType._def,{...r,currentPath:[...r.currentPath,"items","items","1"]})||{}],minItems:2,maxItems:2}};case sj.ZodFirstPartyTypeKind.ZodSet:let y;return y={type:"array",uniqueItems:!0,items:sJ(e.valueType._def,{...r,currentPath:[...r.currentPath,"items"]})},e.minSize&&sx(y,"minItems",e.minSize.value,e.minSize.message,r),e.maxSize&&sx(y,"maxItems",e.maxSize.value,e.maxSize.message,r),y;case sj.ZodFirstPartyTypeKind.ZodLazy:return sJ(e.getter()._def,r);case sj.ZodFirstPartyTypeKind.ZodPromise:return sJ(e.type._def,r);case sj.ZodFirstPartyTypeKind.ZodNaN:case sj.ZodFirstPartyTypeKind.ZodNever:return{not:{}};case sj.ZodFirstPartyTypeKind.ZodEffects:return"input"===r.effectStrategy?sJ(e.schema._def,r,i):{};case sj.ZodFirstPartyTypeKind.ZodAny:case sj.ZodFirstPartyTypeKind.ZodUnknown:return{};case sj.ZodFirstPartyTypeKind.ZodDefault:return{...sJ(e.innerType._def,r),default:e.defaultValue()};case sj.ZodFirstPartyTypeKind.ZodBranded:return sJ(e.type._def,r);case sj.ZodFirstPartyTypeKind.ZodReadonly:case sj.ZodFirstPartyTypeKind.ZodCatch:return sJ(e.innerType._def,r);case sj.ZodFirstPartyTypeKind.ZodPipeline:if("input"===r.pipeStrategy)return sJ(e.in._def,r);if("output"===r.pipeStrategy)return sJ(e.out._def,r);let v=sJ(e.in._def,{...r,currentPath:[...r.currentPath,"allOf","0"]}),_=sJ(e.out._def,{...r,currentPath:[...r.currentPath,"allOf",v?"1":"0"]});return{allOf:[v,_].filter(e=>void 0!==e)};case sj.ZodFirstPartyTypeKind.ZodFunction:case sj.ZodFirstPartyTypeKind.ZodVoid:case sj.ZodFirstPartyTypeKind.ZodSymbol:default:return}},sQ=(e,t,r)=>(e.description&&(r.description=e.description,t.markdownDescription&&(r.markdownDescription=e.description)),r),s0=e=>"_def"in e?e._def:e;function s1(e,t){return((e,t)=>{let r,i,a=(i=void 0!==(r="string"==typeof t?{...sq,basePath:["#"],definitions:{},name:t}:{...sq,basePath:["#"],definitions:{},...t}).name?[...r.basePath,r.definitionPath,r.name]:r.basePath,{...r,currentPath:i,propertyPath:void 0,seenRefs:new Set,seen:new Map(Object.entries(r.definitions).map(([e,t])=>[s0(t),{def:s0(t),path:[...r.basePath,r.definitionPath,e],jsonSchema:void 0}]))}),n="string"==typeof t?t:t?.nameStrategy==="title"?void 0:t?.name,s=sJ(e._def,void 0===n?a:{...a,currentPath:[...a.basePath,a.definitionPath,n]},!1)??{},o="object"==typeof t&&void 0!==t.name&&"title"===t.nameStrategy?t.name:void 0;void 0!==o&&(s.title=o);let l=(()=>{if(function(e){if(!e)return!0;for(let t in e)return!1;return!0}(a.definitions))return;let e={},t=new Set;for(let r=0;r<500;r++){let r=Object.entries(a.definitions).filter(([e])=>!t.has(e));if(0===r.length)break;for(let[i,n]of r)e[i]=sJ(s0(n),{...a,currentPath:[...a.basePath,a.definitionPath,i]},!0)??{},t.add(i)}return e})(),c=void 0===n?l?{...s,[a.definitionPath]:l}:s:"duplicate-ref"===a.nameStrategy?{...s,...l||a.seenRefs.size?{[a.definitionPath]:{...l,...a.seenRefs.size?{[n]:s}:void 0}}:void 0}:{$ref:[..."relative"===a.$refStrategy?[]:a.basePath,a.definitionPath,n].join("/"),[a.definitionPath]:{...l,[n]:s}};return"jsonSchema7"===a.target?c.$schema="http://json-schema.org/draft-07/schema#":"jsonSchema2019-09"===a.target&&(c.$schema="https://json-schema.org/draft/2019-09/schema#"),c})(e,{openaiStrictMode:!0,name:t.name,nameStrategy:"duplicate-ref",$refStrategy:"extract-to-root",nullableStrategy:"property"})}var s2=e.i(77843);function s5(e,t){return e.lc_error_code=t,e.message=`${e.message}

Troubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${t}/
`,e}function s4(e){let t;return e.constructor.name===s2.APIConnectionTimeoutError.name?(t=Error(e.message)).name="TimeoutError":e.constructor.name===s2.APIUserAbortError.name?(t=Error(e.message)).name="AbortError":t=400===e.status&&e.message.includes("tool_calls")?s5(e,"INVALID_TOOL_RESULTS"):401===e.status?s5(e,"MODEL_AUTHENTICATION"):429===e.status?s5(e,"MODEL_RATE_LIMIT"):404===e.status?s5(e,"MODEL_NOT_FOUND"):e,t}function s3(e,t){let r=[];for(let[i,a]of Object.entries(e.properties??{}))a.description&&t<2&&r.push(`// ${a.description}`),e.required?.includes(i)?r.push(`${i}: ${s8(a,t)},`):r.push(`${i}?: ${s8(a,t)},`);return r.map(e=>" ".repeat(t)+e).join("\n")}function s8(e,t){if(void 0!==e.anyOf&&Array.isArray(e.anyOf))return e.anyOf.map(e=>s8(e,t)).join(" | ");switch(e.type){case"string":if(e.enum)return e.enum.map(e=>`"${e}"`).join(" | ");return"string";case"number":if(e.enum)return e.enum.map(e=>`${e}`).join(" | ");return"number";case"integer":if(e.enum)return e.enum.map(e=>`${e}`).join(" | ");return"number";case"boolean":return"boolean";case"null":return"null";case"object":return["{",s3(e,t+2),"}"].join("\n");case"array":if(e.items)return`${s8(e.items,t)}[]`;return"any[]";default:return""}}function s6(e){let t=e._getType();switch(t){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":if(!im.ChatMessage.isInstance(e))throw Error("Invalid generic chat message");return"system"!==e.role&&"developer"!==e.role&&"assistant"!==e.role&&"user"!==e.role&&"function"!==e.role&&"tool"!==e.role&&console.warn(`Unknown message role: ${e.role}`),e.role;default:throw Error(`Unknown message type: ${t}`)}}function s9(e,t){return e.flatMap(e=>{let r=s6(e);"system"===r&&t?.startsWith("o1")&&(r="developer");let i={role:r,content:e.content};return(null!=e.name&&(i.name=e.name),null!=e.additional_kwargs.function_call&&(i.function_call=e.additional_kwargs.function_call,i.content=null),(0,eC.isAIMessage)(e)&&e.tool_calls?.length?(i.tool_calls=e.tool_calls.map(sP),i.content=null):(null!=e.additional_kwargs.tool_calls&&(i.tool_calls=e.additional_kwargs.tool_calls),null!=e.tool_call_id&&(i.tool_call_id=e.tool_call_id)),e.additional_kwargs.audio&&"object"==typeof e.additional_kwargs.audio&&"id"in e.additional_kwargs.audio)?[i,{role:"assistant",audio:{id:e.additional_kwargs.audio.id}}]:i})}function s7(e,t){var r;let i;if(e6(e))return t?.strict!==void 0?{...e,function:{...e.function,strict:t.strict}}:e;if(rd(e)){let a=(r={name:e.name,parameters:e.schema,description:e.description},(0,sE.makeParseableTool)({type:"function",function:{name:r.name,parameters:s1(r.parameters,{name:r.name}),strict:!0,...r.description?{description:r.description}:void 0}},{callback:r.function,parser:e=>r.parameters.parse(JSON.parse(e))}));i=a.function.parameters?{type:a.type,function:{name:a.function.name,description:a.function.description,parameters:a.function.parameters,...t?.strict!==void 0?{strict:t.strict}:{}}}:{type:"function",function:rx(e,t)}}else i=e;return t?.strict!==void 0&&(i.function.strict=t.strict),i}class oe extends tp{static lc_name(){return"ChatOpenAI"}get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","tool_choice","promptIndex","response_format","seed","reasoning_effort"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",apiKey:"OPENAI_API_KEY",azureOpenAIApiKey:"AZURE_OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",apiKey:"openai_api_key",azureOpenAIApiVersion:"azure_openai_api_version",azureOpenAIApiKey:"azure_openai_api_key",azureOpenAIApiInstanceName:"azure_openai_api_instance_name",azureOpenAIApiDeploymentName:"azure_openai_api_deployment_name"}}constructor(e,t){if(super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topLogprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureADTokenProvider",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIBasePath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIEndpoint",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"__includeRawResponse",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"supportsStrictToolCalling",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"audio",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modalities",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reasoningEffort",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.openAIApiKey=e?.apiKey??e?.openAIApiKey??e?.configuration?.apiKey??(0,rO.getEnvironmentVariable)("OPENAI_API_KEY"),this.apiKey=this.openAIApiKey,this.azureOpenAIApiKey=e?.azureOpenAIApiKey??(0,rO.getEnvironmentVariable)("AZURE_OPENAI_API_KEY"),this.azureADTokenProvider=e?.azureADTokenProvider??void 0,!this.azureOpenAIApiKey&&!this.apiKey&&!this.azureADTokenProvider)throw Error("OpenAI or Azure OpenAI API key or Token Provider not found");if(this.azureOpenAIApiInstanceName=e?.azureOpenAIApiInstanceName??(0,rO.getEnvironmentVariable)("AZURE_OPENAI_API_INSTANCE_NAME"),this.azureOpenAIApiDeploymentName=e?.azureOpenAIApiDeploymentName??(0,rO.getEnvironmentVariable)("AZURE_OPENAI_API_DEPLOYMENT_NAME"),this.azureOpenAIApiVersion=e?.azureOpenAIApiVersion??(0,rO.getEnvironmentVariable)("AZURE_OPENAI_API_VERSION"),this.azureOpenAIBasePath=e?.azureOpenAIBasePath??(0,rO.getEnvironmentVariable)("AZURE_OPENAI_BASE_PATH"),this.organization=e?.configuration?.organization??(0,rO.getEnvironmentVariable)("OPENAI_ORGANIZATION"),this.azureOpenAIEndpoint=e?.azureOpenAIEndpoint??(0,rO.getEnvironmentVariable)("AZURE_OPENAI_ENDPOINT"),this.modelName=e?.model??e?.modelName??this.model,this.model=this.modelName,this.modelKwargs=e?.modelKwargs??{},this.timeout=e?.timeout,this.temperature=e?.temperature??this.temperature,this.topP=e?.topP??this.topP,this.frequencyPenalty=e?.frequencyPenalty??this.frequencyPenalty,this.presencePenalty=e?.presencePenalty??this.presencePenalty,this.maxTokens=e?.maxTokens,this.logprobs=e?.logprobs,this.topLogprobs=e?.topLogprobs,this.n=e?.n??this.n,this.logitBias=e?.logitBias,this.stop=e?.stopSequences??e?.stop,this.stopSequences=this?.stop,this.user=e?.user,this.__includeRawResponse=e?.__includeRawResponse,this.audio=e?.audio,this.modalities=e?.modalities,this.reasoningEffort=e?.reasoningEffort,this.azureOpenAIApiKey||this.azureADTokenProvider){if(!this.azureOpenAIApiInstanceName&&!this.azureOpenAIBasePath&&!this.azureOpenAIEndpoint)throw Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName&&this.azureOpenAIBasePath){const e=this.azureOpenAIBasePath.split("/openai/deployments/");if(2===e.length){const[,t]=e;this.azureOpenAIApiDeploymentName=t}}if(!this.azureOpenAIApiDeploymentName)throw Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw Error("Azure OpenAI API version not found");this.apiKey=this.apiKey??"",this.streamUsage=!1}"o1"===this.model&&(this.disableStreaming=!0),this.streaming=e?.streaming??!1,this.streamUsage=e?.streamUsage??this.streamUsage,this.clientConfig={apiKey:this.apiKey,organization:this.organization,baseURL:t?.basePath??e?.configuration?.basePath,dangerouslyAllowBrowser:!0,defaultHeaders:t?.baseOptions?.headers??e?.configuration?.baseOptions?.headers,defaultQuery:t?.baseOptions?.params??e?.configuration?.baseOptions?.params,...t,...e?.configuration},e?.supportsStrictToolCalling!==void 0&&(this.supportsStrictToolCalling=e.supportsStrictToolCalling)}getLsParams(e){let t=this.invocationParams(e);return{ls_provider:"openai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:t.temperature??void 0,ls_max_tokens:t.max_tokens??void 0,ls_stop:e.stop}}bindTools(e,t){let r;return t?.strict!==void 0?r=t.strict:void 0!==this.supportsStrictToolCalling&&(r=this.supportsStrictToolCalling),this.bind({tools:e.map(e=>s7(e,{strict:r})),...t})}createResponseFormat(e){if(e&&"json_schema"===e.type&&e.json_schema.schema&&ot(e.json_schema.schema)){var t,r,i;return t=e.json_schema.schema,r=e.json_schema.name,i={description:e.json_schema.description},(0,sE.makeParseableResponseFormat)({type:"json_schema",json_schema:{...i,name:r,strict:!0,schema:s1(t,{name:r})}},e=>t.parse(JSON.parse(e)))}return e}invocationParams(e,t){let r;e?.strict!==void 0?r=e.strict:void 0!==this.supportsStrictToolCalling&&(r=this.supportsStrictToolCalling);let i={};e?.stream_options!==void 0?i={stream_options:e.stream_options}:this.streamUsage&&(this.streaming||t?.streaming)&&(i={stream_options:{include_usage:!0}});let a={model:this.model,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,max_tokens:-1===this.maxTokens?void 0:this.maxTokens,logprobs:this.logprobs,top_logprobs:this.topLogprobs,n:this.n,logit_bias:this.logitBias,stop:e?.stop??this.stopSequences,user:this.user,stream:this.streaming,functions:e?.functions,function_call:e?.function_call,tools:e?.tools?.length?e.tools.map(e=>s7(e,{strict:r})):void 0,tool_choice:function(e){if(e){if("any"===e||"required"===e)return"required";if("auto"===e)return"auto";if("none"===e)return"none";else if("string"==typeof e)return{type:"function",function:{name:e}};else return e}}(e?.tool_choice),response_format:this.createResponseFormat(e?.response_format),seed:e?.seed,...i,parallel_tool_calls:e?.parallel_tool_calls,...this.audio||e?.audio?{audio:this.audio||e?.audio}:{},...this.modalities||e?.modalities?{modalities:this.modalities||e?.modalities}:{},...this.modelKwargs};e?.prediction!==void 0&&(a.prediction=e.prediction);let n=e?.reasoning_effort??this.reasoningEffort;return void 0!==n&&(a.reasoning_effort=n),a}_identifyingParams(){return{model_name:this.model,...this.invocationParams(),...this.clientConfig}}async *_streamResponseChunks(e,t,r){let i,a,n=s9(e,this.model),s={...this.invocationParams(t,{streaming:!0}),messages:n,stream:!0};for await(let e of(await this.completionWithRetry(s,t))){let n=e?.choices?.[0];if(e.usage&&(a=e.usage),!n)continue;let{delta:s}=n;if(!s)continue;let o=function(e,t,r,i){let a,n=e.role??r,s=e.content??"";a=e.function_call?{function_call:e.function_call}:e.tool_calls?{tool_calls:e.tool_calls}:{},i&&(a.__raw_response=t),e.audio&&(a.audio={...e.audio,index:t.choices[0].index});let o={usage:{...t.usage}};if("user"===n)return new ej.HumanMessageChunk({content:s,response_metadata:o});if("assistant"===n){let r=[];if(Array.isArray(e.tool_calls))for(let t of e.tool_calls)r.push({name:t.function?.name,args:t.function?.arguments,id:t.id,index:t.index,type:"tool_call_chunk"});return new eC.AIMessageChunk({content:s,tool_call_chunks:r,additional_kwargs:a,id:t.id,response_metadata:o})}if("system"===n)return new ib.SystemMessageChunk({content:s,response_metadata:o});if("developer"===n)return new ib.SystemMessageChunk({content:s,response_metadata:o,additional_kwargs:{__openai_role__:"developer"}});if("function"===n)return new ig.FunctionMessageChunk({content:s,additional_kwargs:a,name:e.name,response_metadata:o});else if("tool"===n)return new i_.ToolMessageChunk({content:s,additional_kwargs:a,tool_call_id:e.tool_call_id,response_metadata:o});else return new im.ChatMessageChunk({content:s,role:n,response_metadata:o})}(s,e,i,this.__includeRawResponse);i=s.role??i;let l={prompt:t.promptIndex??0,completion:n.index??0};if("string"!=typeof o.content){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}let c={...l};null!=n.finish_reason&&(c.finish_reason=n.finish_reason,c.system_fingerprint=e.system_fingerprint,c.model_name=e.model),this.logprobs&&(c.logprobs=n.logprobs);let u=new ti.ChatGenerationChunk({message:o,text:o.content,generationInfo:c});yield u,await r?.handleLLMNewToken(u.text??"",l,void 0,void 0,void 0,{chunk:u})}if(a){let e={...a.prompt_tokens_details?.audio_tokens!==null&&{audio:a.prompt_tokens_details?.audio_tokens},...a.prompt_tokens_details?.cached_tokens!==null&&{cache_read:a.prompt_tokens_details?.cached_tokens}},t={...a.completion_tokens_details?.audio_tokens!==null&&{audio:a.completion_tokens_details?.audio_tokens},...a.completion_tokens_details?.reasoning_tokens!==null&&{reasoning:a.completion_tokens_details?.reasoning_tokens}},r=new ti.ChatGenerationChunk({message:new eC.AIMessageChunk({content:"",response_metadata:{usage:{...a}},usage_metadata:{input_tokens:a.prompt_tokens,output_tokens:a.completion_tokens,total_tokens:a.total_tokens,...Object.keys(e).length>0&&{input_token_details:e},...Object.keys(t).length>0&&{output_token_details:t}}}),text:""});yield r}if(t.signal?.aborted)throw Error("AbortError")}identifyingParams(){return this._identifyingParams()}async _generate(e,t,r){let i={},a=this.invocationParams(t),n=s9(e,this.model);if(a.stream){let a=this._streamResponseChunks(e,t,r),n={};for await(let e of a){e.message.response_metadata={...e.generationInfo,...e.message.response_metadata};let t=e.generationInfo?.completion??0;void 0===n[t]?n[t]=e:n[t]=n[t].concat(e)}let s=Object.entries(n).sort(([e],[t])=>parseInt(e,10)-parseInt(t,10)).map(([e,t])=>t),{functions:o,function_call:l}=this.invocationParams(t),c=await this.getEstimatedTokenCountFromPrompt(e,o,l),u=await this.getNumTokensFromGenerations(s);return i.input_tokens=c,i.output_tokens=u,i.total_tokens=c+u,{generations:s,llmOutput:{estimatedTokenUsage:{promptTokens:i.input_tokens,completionTokens:i.output_tokens,totalTokens:i.total_tokens}}}}{let e;e=t.response_format&&"json_schema"===t.response_format.type?await this.betaParsedCompletionWithRetry({...a,stream:!1,messages:n},{signal:t?.signal,...t?.options}):await this.completionWithRetry({...a,stream:!1,messages:n},{signal:t?.signal,...t?.options});let{completion_tokens:r,prompt_tokens:s,total_tokens:o,prompt_tokens_details:l,completion_tokens_details:c}=e?.usage??{};r&&(i.output_tokens=(i.output_tokens??0)+r),s&&(i.input_tokens=(i.input_tokens??0)+s),o&&(i.total_tokens=(i.total_tokens??0)+o),(l?.audio_tokens!==null||l?.cached_tokens!==null)&&(i.input_token_details={...l?.audio_tokens!==null&&{audio:l?.audio_tokens},...l?.cached_tokens!==null&&{cache_read:l?.cached_tokens}}),(c?.audio_tokens!==null||c?.reasoning_tokens!==null)&&(i.output_token_details={...c?.audio_tokens!==null&&{audio:c?.audio_tokens},...c?.reasoning_tokens!==null&&{reasoning:c?.reasoning_tokens}});let u=[];for(let t of e?.choices??[]){let r={text:t.message?.content??"",message:function(e,t,r){let i=e.tool_calls;if("assistant"!==e.role)return new im.ChatMessage(e.content||"",e.role??"unknown");{let n=[],s=[];for(let e of i??[])try{n.push(sO(e,{returnId:!0}))}catch(t){var a;s.push((a=t.message,{name:e.function?.name,args:e.function?.arguments,id:e.id,error:a,type:"invalid_tool_call"}))}let o={function_call:e.function_call,tool_calls:i};void 0!==r&&(o.__raw_response=t);let l={model_name:t.model,...t.system_fingerprint?{usage:{...t.usage},system_fingerprint:t.system_fingerprint}:{}};return e.audio&&(o.audio=e.audio),new eC.AIMessage({content:e.content||"",tool_calls:n,invalid_tool_calls:s,additional_kwargs:o,response_metadata:l,id:t.id})}}(t.message??{role:"assistant"},e,this.__includeRawResponse)};r.generationInfo={...t.finish_reason?{finish_reason:t.finish_reason}:{},...t.logprobs?{logprobs:t.logprobs}:{}},(0,eC.isAIMessage)(r.message)&&(r.message.usage_metadata=i),r.message=new eC.AIMessage(Object.fromEntries(Object.entries(r.message).filter(([e])=>!e.startsWith("lc_")))),u.push(r)}return{generations:u,llmOutput:{tokenUsage:{promptTokens:i.input_tokens,completionTokens:i.output_tokens,totalTokens:i.total_tokens}}}}}async getEstimatedTokenCountFromPrompt(e,t,r){let i=(await this.getNumTokensFromMessages(e)).totalCount;if(t&&"auto"!==r){let e=function(e){let t=["namespace functions {",""];for(let r of e)r.description&&t.push(`// ${r.description}`),Object.keys(r.parameters.properties??{}).length>0?(t.push(`type ${r.name} = (_: {`),t.push(s3(r.parameters,0)),t.push("}) => any;")):t.push(`type ${r.name} = () => any;`),t.push("");return t.push("} // namespace functions"),t.join("\n")}(t);i+=await this.getNumTokens(e),i+=9}return t&&e.find(e=>"system"===e._getType())&&(i-=4),"none"===r?i+=1:"object"==typeof r&&(i+=await this.getNumTokens(r.name)+4),i}async getNumTokensFromGenerations(e){return(await Promise.all(e.map(async e=>e.message.additional_kwargs?.function_call?(await this.getNumTokensFromMessages([e.message])).countPerMessage[0]:await this.getNumTokens(e.message.content)))).reduce((e,t)=>e+t,0)}async getNumTokensFromMessages(e){let t=0,r=0,i=0;"gpt-3.5-turbo-0301"===this.model?(r=4,i=-1):(r=3,i=1);let a=await Promise.all(e.map(async e=>{let a=await this.getNumTokens(e.content),n=await this.getNumTokens(s6(e)),s=void 0!==e.name?i+await this.getNumTokens(e.name):0,o=a+r+n+s;if("function"===e._getType()&&(o-=2),e.additional_kwargs?.function_call&&(o+=3),e?.additional_kwargs.function_call?.name&&(o+=await this.getNumTokens(e.additional_kwargs.function_call?.name)),e.additional_kwargs.function_call?.arguments)try{o+=await this.getNumTokens(JSON.stringify(JSON.parse(e.additional_kwargs.function_call?.arguments)))}catch(t){console.error("Error parsing function arguments",t,JSON.stringify(e.additional_kwargs.function_call)),o+=await this.getNumTokens(e.additional_kwargs.function_call?.arguments)}return t+=o,o}));return{totalCount:t+=3,countPerMessage:a}}async completionWithRetry(e,t){let r=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.chat.completions.create(e,r)}catch(e){throw s4(e)}})}async betaParsedCompletionWithRetry(e,t){let r=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.beta.chat.completions.parse(e,r)}catch(e){throw s4(e)}})}_getClientOptions(e){if(!this.client){let e=function(e){let{azureOpenAIApiDeploymentName:t,azureOpenAIApiInstanceName:r,azureOpenAIApiKey:i,azureOpenAIBasePath:a,baseURL:n,azureADTokenProvider:s,azureOpenAIEndpoint:o}=e;if((i||s)&&a&&t)return`${a}/${t}`;if((i||s)&&o&&t)return`${o}/openai/deployments/${t}`;if(i||s){if(!r)throw Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!t)throw Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${r}.openai.azure.com/openai/deployments/${t}`}return n}({azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,baseURL:this.clientConfig.baseURL,azureOpenAIEndpoint:this.azureOpenAIEndpoint}),t={...this.clientConfig,baseURL:e,timeout:this.timeout,maxRetries:0};t.baseURL||delete t.baseURL,this.client=new sk.OpenAI(t)}let t={...this.clientConfig,...e};return this.azureOpenAIApiKey&&(t.headers={"api-key":this.azureOpenAIApiKey,...t.headers},t.query={"api-version":this.azureOpenAIApiVersion,...t.query}),t}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce((e,t)=>(t&&t.tokenUsage&&(e.tokenUsage.completionTokens+=t.tokenUsage.completionTokens??0,e.tokenUsage.promptTokens+=t.tokenUsage.promptTokens??0,e.tokenUsage.totalTokens+=t.tokenUsage.totalTokens??0),e),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}withStructuredOutput(e,t){var r;let i,a,n,s,o,l;if(void 0!==(r=e)&&"object"==typeof r.schema?(i=e.schema,a=e.name,n=e.method,s=e.includeRaw):(i=e,a=t?.name,n=t?.method,s=t?.includeRaw),t?.strict!==void 0&&"jsonMode"===n)throw Error("Argument `strict` is only supported for `method` = 'function_calling'");if("jsonMode"===n)o=this.bind({response_format:{type:"json_object"}}),l=ot(i)?tz.fromZodSchema(i):new tW;else if("jsonSchema"===n)o=this.bind({response_format:{type:"json_schema",json_schema:{name:a??"extract",description:i.description,schema:i,strict:t?.strict}}}),l=ot(i)?tz.fromZodSchema(i):new tW;else{let e=a??"extract";if(ot(i)){let r=(0,sS.zodToJsonSchema)(i);o=this.bind({tools:[{type:"function",function:{name:e,description:r.description,parameters:r}}],tool_choice:{type:"function",function:{name:e}},...t?.strict!==void 0?{strict:t.strict}:{}}),l=new sT({returnSingle:!0,keyName:e,zodSchema:i})}else{let r;"string"==typeof i.name&&"object"==typeof i.parameters&&null!=i.parameters?(r=i,e=i.name):r={name:e=i.title??e,description:i.description??"",parameters:i},o=this.bind({tools:[{type:"function",function:r}],tool_choice:{type:"function",function:{name:e}},...t?.strict!==void 0?{strict:t.strict}:{}}),l=new sT({returnSingle:!0,keyName:e})}}if(!s)return o.pipe(l);let c=to.assign({parsed:(e,t)=>l.invoke(e.raw,t)}),u=to.assign({parsed:()=>null}),h=c.withFallbacks({fallbacks:[u]});return iP.RunnableSequence.from([{raw:o},h])}}function ot(e){return"function"==typeof e?.parse}Object.defineProperty(class extends rm{static lc_name(){return"DallEAPIWrapper"}constructor(e){e?.responseFormat!==void 0&&["url","b64_json"].includes(e.responseFormat)&&(e.dallEResponseFormat=e.responseFormat,e.responseFormat="content"),super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:"A wrapper around OpenAI DALL-E API. Useful for when you need to generate images from a text description. Input should be an image description."}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"dall-e-3"}),Object.defineProperty(this,"style",{enumerable:!0,configurable:!0,writable:!0,value:"vivid"}),Object.defineProperty(this,"quality",{enumerable:!0,configurable:!0,writable:!0,value:"standard"}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"size",{enumerable:!0,configurable:!0,writable:!0,value:"1024x1024"}),Object.defineProperty(this,"dallEResponseFormat",{enumerable:!0,configurable:!0,writable:!0,value:"url"}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const t={apiKey:e?.apiKey??e?.openAIApiKey??(0,rO.getEnvironmentVariable)("OPENAI_API_KEY"),organization:e?.organization??(0,rO.getEnvironmentVariable)("OPENAI_ORGANIZATION"),dangerouslyAllowBrowser:!0,baseUrl:e?.baseUrl};this.client=new sk.OpenAI(t),this.model=e?.model??e?.modelName??this.model,this.style=e?.style??this.style,this.quality=e?.quality??this.quality,this.n=e?.n??this.n,this.size=e?.size??this.size,this.dallEResponseFormat=e?.dallEResponseFormat??this.dallEResponseFormat,this.user=e?.user}processMultipleGeneratedUrls(e){return"url"===this.dallEResponseFormat?e.flatMap(e=>e.data.flatMap(e=>e.url?{type:"image_url",image_url:e.url}:[]).filter(e=>void 0!==e&&"image_url"===e.type&&"string"==typeof e.image_url&&void 0!==e.image_url)):e.flatMap(e=>e.data.flatMap(e=>e.b64_json?{type:"image_url",image_url:{url:e.b64_json}}:[]).filter(e=>void 0!==e&&"image_url"===e.type&&"object"==typeof e.image_url&&"url"in e.image_url&&"string"==typeof e.image_url.url&&void 0!==e.image_url.url))}async _call(e){let t={model:this.model,prompt:e,n:1,size:this.size,response_format:this.dallEResponseFormat,style:this.style,quality:this.quality,user:this.user};if(this.n>1){let e=await Promise.all(Array.from({length:this.n}).map(()=>this.client.images.generate(t)));return this.processMultipleGeneratedUrls(e)}let r=await this.client.images.generate(t),i="";return"url"===this.dallEResponseFormat?[i]=r.data.map(e=>e.url).filter(e=>"undefined"!==e):[i]=r.data.map(e=>e.b64_json).filter(e=>"undefined"!==e),i}},"toolName",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"});var or=e.i(6298);let oi=["termination","liability","indemnity","privacy","payment","renewal","jurisdiction","IP","confidentiality","warranty","limitation_of_liability","assignment","dispute_resolution","SLA"],oa=a3.Root({docId:a3(),focusAreas:a3(),riskAppetite:a3(),docContext:a3(),seedClauses:a3(),findings:a3(),runId:a3(),retryCount:a3()});async function on(e){let t=await (0,A.getDb)(),r=await t.collection("documents").findOne({_id:new P.ObjectId(e.docId)});if(!r)throw Error("Document not found");return{docContext:{_id:String(r._id),title:r.title,sourceType:r.sourceType,status:r.status}}}async function os(e){let t=e.focusAreas?.length?e.focusAreas:oi,r={},i=(e.retryCount??0)+1;for(let i of t){let t=await (0,or.queryByDocId)(e.docId,i,5);r[i]=t.map(e=>({id:e.id,text:e.text}))}return{seedClauses:r,retryCount:i}}async function oo(e){let t=new oe({modelName:"gpt-4o-mini",temperature:0}),r=[],i=`{
    "risk_level": "low" | "medium" | "high",
    "category": "string",
    "title": "string",
    "description": "string",
    "why_it_matters": "string",
    "suggested_questions": ["string"],
    "suggested_redline": "string (optional)",
    "citations": [{"docId": "string", "chunkId": "string", "snippet": "string"}],
    "confidence": 0.0-1.0
  }`;for(let[a,n]of Object.entries(e.seedClauses??{})){if(0===n.length)continue;let e=n.map(e=>`[${e.id}]: ${e.text}`).join("\n\n"),s=await t.invoke([{role:"system",content:`You are a contract risk analyst. Extract risk findings from the provided clauses. 
Output valid JSON matching this schema: ${i}
Only report findings that are grounded in the text. Every finding MUST have at least one citation with a chunkId from the context.
Do not provide legal advice. Focus on risk signals and questions for counsel.`},{role:"user",content:`Category: ${a}

Context:
${e}

Extract findings as JSON array. If no relevant findings, return [].`}]),o="string"==typeof s.content?s.content:"";try{let e=JSON.parse(o.replace(/```json\n?|\n?```/g,"").trim());for(let t of Array.isArray(e)?e:[e])t&&t.citations?.length>0&&r.push({risk_level:t.risk_level??"medium",category:t.category??a,title:t.title??"",description:t.description??"",why_it_matters:t.why_it_matters??"",suggested_questions:t.suggested_questions??[],suggested_redline:t.suggested_redline,citations:t.citations,confidence:Math.min(1,Math.max(0,t.confidence??.7))})}catch{}}return{findings:r}}function ol(e){let t=e.findings??[],r=new Set,i=[];for(let e of t){let t=`${e.category}:${e.title}`;r.has(t)||(r.add(t),i.push(e))}return i.sort((e,t)=>{let r={high:0,medium:1,low:2},i=r[e.risk_level]??1,a=r[t.risk_level]??1;return i!==a?i-a:(t.confidence??0)-(e.confidence??0)}),{findings:i}}function oc(e){let t=e.findings??[],r=t.length>0&&t.every(e=>e.citations?.length>=1),i=e.retryCount??0;return r||i>=2?"finalize":"retrieve_seed_clauses"}async function ou(e){let t=await (0,A.getDb)(),r=new P.ObjectId(e.runId);return await t.collection("runs").updateOne({_id:r},{$set:{status:"completed",outputs:{findings:e.findings},completedAt:new Date}}),{}}async function oh(e){let t=e.nextUrl.searchParams.get("runId");if(!t)return new Response("runId required",{status:400});let r=await (0,A.getDb)(),i=await r.collection("runs").findOne({_id:new P.ObjectId(t)});if(!i)return new Response("Run not found",{status:404});let a=new TextEncoder,n=new ReadableStream({async start(e){let n=t=>{e.enqueue(a.encode(`data: ${JSON.stringify(t)}

`))};try{let e;n({type:"start",runId:t});let a=((e=new sd(oa).addNode("load_doc_context",on).addNode("retrieve_seed_clauses",os).addNode("extract_findings",oo).addNode("consolidate_and_dedupe",ol).addNode("self_check_grounding",e=>({})).addNode("finalize",ou)).addEdge(ag,"load_doc_context"),e.addEdge("load_doc_context","retrieve_seed_clauses"),e.addEdge("retrieve_seed_clauses","extract_findings"),e.addEdge("extract_findings","consolidate_and_dedupe"),e.addEdge("consolidate_and_dedupe","self_check_grounding"),e.addConditionalEdges("self_check_grounding",oc,{retrieve_seed_clauses:"retrieve_seed_clauses",finalize:"finalize"}),e.addEdge("finalize",ab),e.compile()),s=i.inputs,o={docId:i.docId,focusAreas:s?.focusAreas??[],riskAppetite:s?.riskAppetite??"balanced",runId:t,retryCount:0};for await(let e of(await a.stream(o,{streamMode:"updates"})))for(let t of Object.keys(e)){let r=e[t];n(r&&"object"==typeof r&&"findings"in r?{type:"node",node:t,data:{count:r.findings?.length??0}}:{type:"node",node:t,data:{}})}let l=await r.collection("runs").findOne({_id:new P.ObjectId(t)}),c=l?.outputs?.findings??[];n({type:"complete",findings:c})}catch(e){n({type:"error",error:e instanceof Error?e.message:String(e)})}finally{e.close()}}});return new Response(n,{headers:{"Content-Type":"text/event-stream","Cache-Control":"no-cache",Connection:"keep-alive"}})}e.s(["GET",()=>oh,"dynamic",0,"force-dynamic","runtime",0,"nodejs"],91288);var op=e.i(91288);let od=new o.AppRouteRouteModule({definition:{kind:l.RouteKind.APP_ROUTE,page:"/api/analyze/stream/route",pathname:"/api/analyze/stream",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/apps/web/app/api/analyze/stream/route.ts",nextConfigOutput:"",userland:op}),{workAsyncStorage:of,workUnitAsyncStorage:om,serverHooks:og}=od;function ob(){return(0,c.patchFetch)({workAsyncStorage:of,workUnitAsyncStorage:om})}async function oy(e,t,r){od.isDev&&(0,u.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let i="/api/analyze/stream/route";i=i.replace(/\/index$/,"")||"/";let a=await od.prepare(e,t,{srcPage:i,multiZoneDraftMode:!1});if(!a)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:n,params:s,nextConfig:o,parsedUrl:c,isDraftMode:P,prerenderManifest:A,routerServerContext:T,isOnDemandRevalidate:S,revalidateOnlyGenerated:E,resolvedPathname:j,clientReferenceManifest:C,serverActionsManifest:x}=a,N=(0,d.normalizeAppPath)(i),I=!!(A.dynamicRoutes[N]||A.routes[j]),M=async()=>((null==T?void 0:T.render404)?await T.render404(e,t,c,!1):t.end("This page could not be found"),null);if(I&&!P){let e=!!A.routes[j],t=A.dynamicRoutes[N];if(t&&!1===t.fallback&&!e){if(o.experimental.adapterPath)return await M();throw new k.NoFallbackError}}let R=null;!I||od.isDev||P||(R="/index"===(R=j)?"/":R);let L=!0===od.isDev||!I,$=I&&!L;x&&C&&(0,p.setManifestsSingleton)({page:i,clientReferenceManifest:C,serverActionsManifest:x});let D=e.method||"GET",F=(0,h.getTracer)(),B=F.getActiveScopeSpan(),z={params:s,prerenderManifest:A,renderOpts:{experimental:{authInterrupts:!!o.experimental.authInterrupts},cacheComponents:!!o.cacheComponents,supportsDynamicResponse:L,incrementalCache:(0,u.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:o.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,i,a)=>od.onRequestError(e,t,i,a,T)},sharedContext:{buildId:n}},U=new f.NodeNextRequest(e),V=new f.NodeNextResponse(t),K=m.NextRequestAdapter.fromNodeNextRequest(U,(0,m.signalFromNodeResponse)(t));try{let a=async e=>od.handle(K,z).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=F.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==g.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${D} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${D} ${i}`)}),n=!!(0,u.getRequestMeta)(e,"minimalMode"),s=async s=>{var c,u;let h=async({previousCacheEntry:o})=>{try{if(!n&&S&&E&&!o)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await a(s);e.fetchMetrics=z.renderOpts.fetchMetrics;let l=z.renderOpts.pendingWaitUntil;l&&r.waitUntil&&(r.waitUntil(l),l=void 0);let c=z.renderOpts.collectedTags;if(!I)return await (0,y.sendResponse)(U,V,i,z.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,v.toNodeOutgoingHttpHeaders)(i.headers);c&&(t[w.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==z.renderOpts.collectedRevalidate&&!(z.renderOpts.collectedRevalidate>=w.INFINITE_CACHE)&&z.renderOpts.collectedRevalidate,a=void 0===z.renderOpts.collectedExpire||z.renderOpts.collectedExpire>=w.INFINITE_CACHE?void 0:z.renderOpts.collectedExpire;return{value:{kind:O.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==o?void 0:o.isStale)&&await od.onRequestError(e,t,{routerKind:"App Router",routePath:i,routeType:"route",revalidateReason:(0,b.getRevalidateReason)({isStaticGeneration:$,isOnDemandRevalidate:S})},!1,T),t}},p=await od.handleResponse({req:e,nextConfig:o,cacheKey:R,routeKind:l.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:A,isRoutePPREnabled:!1,isOnDemandRevalidate:S,revalidateOnlyGenerated:E,responseGenerator:h,waitUntil:r.waitUntil,isMinimalMode:n});if(!I)return null;if((null==p||null==(c=p.value)?void 0:c.kind)!==O.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==p||null==(u=p.value)?void 0:u.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});n||t.setHeader("x-nextjs-cache",S?"REVALIDATED":p.isMiss?"MISS":p.isStale?"STALE":"HIT"),P&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let d=(0,v.fromNodeOutgoingHttpHeaders)(p.value.headers);return n&&I||d.delete(w.NEXT_CACHE_TAGS_HEADER),!p.cacheControl||t.getHeader("Cache-Control")||d.get("Cache-Control")||d.set("Cache-Control",(0,_.getCacheControlHeader)(p.cacheControl)),await (0,y.sendResponse)(U,V,new Response(p.value.body,{headers:d,status:p.value.status||200})),null};B?await s(B):await F.withPropagatedContext(e.headers,()=>F.trace(g.BaseServerSpan.handleRequest,{spanName:`${D} ${i}`,kind:h.SpanKind.SERVER,attributes:{"http.method":D,"http.target":e.url}},s))}catch(t){if(t instanceof k.NoFallbackError||await od.onRequestError(e,t,{routerKind:"App Router",routePath:N,routeType:"route",revalidateReason:(0,b.getRevalidateReason)({isStaticGeneration:$,isOnDemandRevalidate:S})},!1,T),I)throw t;return await (0,y.sendResponse)(U,V,new Response(null,{status:500})),null}}e.s(["handler",()=>oy,"patchFetch",()=>ob,"routeModule",()=>od,"serverHooks",()=>og,"workAsyncStorage",()=>of,"workUnitAsyncStorage",()=>om],31353)}];

//# sourceMappingURL=node_modules_118b8937._.js.map